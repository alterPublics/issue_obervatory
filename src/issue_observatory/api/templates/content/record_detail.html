{#
    HTMX partial: content record detail panel.
    Loaded into #detail-panel-inner when a row is clicked in the content browser,
    or as a standalone page at /content/{id}.

    Context:
        - record (dict):
            - id (str)
            - platform (str)
            - arena (str)
            - title (str, optional)
            - text (str, optional)
            - author (str, optional)
            - author_id (str, optional)
            - url (str, optional)
            - published_at (str)
            - collected_at (str)
            - language (str, optional)
            - engagement_score (int, optional)
            - search_terms_matched (list[str], optional)
            - run_id (str, optional)
            - metadata (dict, optional): raw platform-specific fields
        - standalone (bool): True when rendered as a full page, False as a panel partial
#}
{% set record = record | default({}) %}
{% set standalone = standalone | default(false) %}

{% if standalone %}
{% extends "base.html" %}
{% block title %}Content Record — {{ record.platform | default('') | capitalize }}{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <div class="flex items-center gap-3">
        <a href="/content"
           class="text-gray-400 hover:text-gray-600 transition-colors"
           aria-label="Back to content browser">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-xl font-bold text-gray-900">Content Record</h1>
    </div>
{% endif %}

<div class="space-y-4" x-data="{ showRaw: false }">

    {# Header row: platform badge + title + external link #}
    <div class="flex items-start justify-between gap-3">
        <div class="flex items-center gap-2 flex-wrap">
            <span class="inline-flex px-2.5 py-0.5 rounded text-xs font-medium
                {% set p = record.platform | default('') %}
                {% if p == 'youtube' %}bg-red-100 text-red-800
                {% elif p == 'reddit' %}bg-orange-100 text-orange-800
                {% elif p == 'bluesky' %}bg-sky-100 text-sky-800
                {% elif p == 'telegram' %}bg-blue-100 text-blue-800
                {% elif p == 'tiktok' %}bg-slate-100 text-slate-800
                {% elif p == 'gab' %}bg-green-100 text-green-800
                {% else %}bg-gray-100 text-gray-700{% endif %}">
                {{ record.platform | default('unknown') | capitalize }}
            </span>
            <span class="text-xs text-gray-400 font-mono">{{ record.arena | default('') }}</span>
        </div>
        {% if record.url | default('') %}
        <a href="{{ record.url }}"
           target="_blank"
           rel="noopener noreferrer"
           class="flex-shrink-0 inline-flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800">
            <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
            View original
        </a>
        {% endif %}
    </div>

    {# Title #}
    {% if record.title | default('') %}
    <h2 class="text-base font-semibold text-gray-900 leading-snug">{{ record.title }}</h2>
    {% endif %}

    {# Main text content #}
    {% if record.text | default('') %}
    <div class="bg-gray-50 rounded-md p-3 border border-gray-200">
        <p class="text-sm text-gray-800 leading-relaxed whitespace-pre-wrap">{{ record.text | truncate(2000, true, '… [truncated]') }}</p>
    </div>
    {% endif %}

    {# Metadata grid #}
    <dl class="grid grid-cols-2 gap-x-6 gap-y-2 text-xs">
        {% if record.author | default('') %}
        <div>
            <dt class="text-gray-500 font-medium">Author</dt>
            <dd class="text-gray-900 mt-0.5">
                {% if record.author_id | default('') %}
                <a href="/actors?q={{ record.author }}"
                   class="text-blue-600 hover:text-blue-800">{{ record.author }}</a>
                {% else %}
                {{ record.author }}
                {% endif %}
            </dd>
        </div>
        {% endif %}

        {% if record.published_at | default('') %}
        <div>
            <dt class="text-gray-500 font-medium">Published</dt>
            <dd class="text-gray-900 mt-0.5 font-mono">{{ record.published_at | truncate(19, true, '') }} <span class="text-gray-400">(UTC)</span></dd>
        </div>
        {% endif %}

        {% if record.collected_at | default('') %}
        <div>
            <dt class="text-gray-500 font-medium">Collected</dt>
            <dd class="text-gray-900 mt-0.5 font-mono">{{ record.collected_at | truncate(19, true, '') }} <span class="text-gray-400">(UTC)</span></dd>
        </div>
        {% endif %}

        {% if record.language | default('') %}
        <div>
            <dt class="text-gray-500 font-medium">Language</dt>
            <dd class="text-gray-900 mt-0.5">{{ record.language | upper }}</dd>
        </div>
        {% endif %}

        {% if record.engagement_score | default(0) %}
        <div>
            <dt class="text-gray-500 font-medium">Engagement</dt>
            <dd class="text-gray-900 mt-0.5 font-mono">{{ record.engagement_score | int }}</dd>
        </div>
        {% endif %}

        {% if record.run_id | default('') %}
        <div>
            <dt class="text-gray-500 font-medium">Collection Run</dt>
            <dd class="text-gray-900 mt-0.5">
                <a href="/collections/{{ record.run_id }}"
                   class="text-blue-600 hover:text-blue-800 font-mono">
                    {{ record.run_id | truncate(8, true, '') }}
                </a>
            </dd>
        </div>
        {% endif %}

        <div class="col-span-2">
            <dt class="text-gray-500 font-medium">Record ID</dt>
            <dd class="text-gray-400 mt-0.5 font-mono break-all">{{ record.id | default('') }}</dd>
        </div>
    </dl>

    {# Search terms matched #}
    {% if record.search_terms_matched | default([]) | length > 0 %}
    <div>
        <p class="text-xs font-medium text-gray-500 mb-1.5">Matched search terms</p>
        <div class="flex flex-wrap gap-1.5">
            {% for term in record.search_terms_matched %}
            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-100">
                {{ term }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {# Raw JSON viewer — Alpine-toggled #}
    {% if record.metadata | default({}) %}
    <div class="border-t border-gray-200 pt-3">
        <button type="button"
                @click="showRaw = !showRaw"
                class="inline-flex items-center gap-1.5 text-xs text-gray-500 hover:text-gray-700 transition-colors">
            <svg class="w-3.5 h-3.5 transition-transform" :class="showRaw ? 'rotate-90' : ''"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
            <span x-text="showRaw ? 'Hide raw metadata' : 'Show raw metadata'">Show raw metadata</span>
        </button>

        <div x-show="showRaw"
             x-cloak
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             class="mt-2">
            <pre class="bg-gray-900 text-gray-100 text-xs p-4 rounded-md overflow-x-auto leading-relaxed max-h-80 overflow-y-auto">{{ record.metadata | tojson(indent=2) if record.metadata else '{}' }}</pre>
        </div>
    </div>
    {% endif %}

    {# ------------------------------------------------------------------ #}
    {# Annotation panel — IP2-043                                        #}
    {# Loads the current user's annotation via GET /annotations/{id},   #}
    {# then lets the researcher save changes via HTMX POST.              #}
    {# ------------------------------------------------------------------ #}
    {% if record.id | default('') and record.published_at | default('') %}
    <div class="border-t border-gray-200 pt-4"
         x-data="annotationPanel('{{ record.id }}', '{{ record.published_at }}')"
         x-init="loadAnnotation()">

        <div class="flex items-center justify-between mb-3">
            <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Annotation</h3>
            {# Green checkmark badge — visible when the record has been saved #}
            <span x-show="saved"
                  x-cloak
                  x-transition:enter="transition ease-out duration-200"
                  x-transition:enter-start="opacity-0 scale-90"
                  x-transition:enter-end="opacity-100 scale-100"
                  class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs font-medium">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                     fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd"
                          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                          clip-rule="evenodd"/>
                </svg>
                Annotated
            </span>
        </div>

        {# Loading state #}
        <div x-show="loading" class="text-xs text-gray-400 py-2 text-center">
            Loading annotation...
        </div>

        {# Error state #}
        <div x-show="error && !loading"
             x-cloak
             class="text-xs text-red-600 py-2">
            <span x-text="error"></span>
        </div>

        {# Annotation form — shown once loaded #}
        <form x-show="!loading"
              x-cloak
              @submit.prevent="saveAnnotation()"
              class="space-y-3">

            {# Stance dropdown #}
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Stance</label>
                <select x-model="form.stance"
                        @blur="saveAnnotation()"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">— unset —</option>
                    <option value="positive">Positive</option>
                    <option value="negative">Negative</option>
                    <option value="neutral">Neutral</option>
                    <option value="contested">Contested</option>
                    <option value="irrelevant">Irrelevant</option>
                </select>
            </div>

            {# Relevant toggle #}
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Relevant?</label>
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio"
                               name="is_relevant_{{ record.id }}"
                               :value="true"
                               x-model="form.is_relevant"
                               @change="saveAnnotation()"
                               class="text-blue-600 focus:ring-blue-500">
                        <span class="text-xs text-gray-700">Yes</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio"
                               name="is_relevant_{{ record.id }}"
                               :value="false"
                               x-model="form.is_relevant"
                               @change="saveAnnotation()"
                               class="text-blue-600 focus:ring-blue-500">
                        <span class="text-xs text-gray-700">No</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer">
                        <input type="radio"
                               name="is_relevant_{{ record.id }}"
                               :value="null"
                               x-model="form.is_relevant"
                               @change="saveAnnotation()"
                               class="text-blue-600 focus:ring-blue-500">
                        <span class="text-xs text-gray-400">Unset</span>
                    </label>
                </div>
            </div>

            {# Frame input #}
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Frame</label>
                <input type="text"
                       x-model="form.frame"
                       @blur="saveAnnotation()"
                       placeholder="e.g. economic, environmental"
                       class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500"
                       maxlength="200">
            </div>

            {# Tags chip input (comma-separated) #}
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Tags</label>
                <input type="text"
                       x-model="tagsInput"
                       @blur="syncTagsAndSave()"
                       placeholder="comma-separated, e.g. climate, policy"
                       class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div x-show="form.tags && form.tags.length > 0"
                     x-cloak
                     class="flex flex-wrap gap-1 mt-1.5">
                    <template x-for="tag in (form.tags || [])" :key="tag">
                        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-xs border border-blue-100">
                            <span x-text="tag"></span>
                            <button type="button"
                                    @click="removeTag(tag)"
                                    class="text-blue-400 hover:text-blue-700 leading-none"
                                    aria-label="Remove tag">
                                &times;
                            </button>
                        </span>
                    </template>
                </div>
            </div>

            {# Notes textarea #}
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                <textarea x-model="form.notes"
                          @blur="saveAnnotation()"
                          rows="3"
                          placeholder="Free-text annotation notes..."
                          class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y min-h-[4rem]"></textarea>
            </div>

            {# Save button + status indicator #}
            <div class="flex items-center gap-3">
                <button type="submit"
                        :disabled="saving"
                        class="px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                    <span x-text="saving ? 'Saving...' : 'Save annotation'"></span>
                </button>

                <span x-show="saveError"
                      x-cloak
                      class="text-xs text-red-600"
                      x-text="saveError"></span>

                <button type="button"
                        x-show="saved"
                        x-cloak
                        @click="deleteAnnotation()"
                        class="ml-auto text-xs text-red-400 hover:text-red-600 transition-colors">
                    Remove annotation
                </button>
            </div>

        </form>
    </div>
    {% endif %}

    {# Actions row #}
    <div class="flex items-center gap-3 pt-2 border-t border-gray-200">
        <a href="/actors?q={{ record.author | default('') | urlencode }}"
           class="text-xs text-gray-500 hover:text-blue-600 transition-colors">
            Find actor
        </a>
        <a href="/content?run_id={{ record.run_id | default('') }}&arenas={{ record.arena | default('') }}"
           class="text-xs text-gray-500 hover:text-blue-600 transition-colors">
            More from this run
        </a>
        {% if not standalone %}
        <a href="/content/{{ record.id }}"
           class="ml-auto text-xs text-gray-400 hover:text-gray-600 transition-colors">
            Full page
        </a>
        {% endif %}
    </div>

<script>
/**
 * Alpine.js component for the annotation panel.
 *
 * Manages loading, saving, and deleting annotations for a single content
 * record via the /annotations/{record_id} API.
 *
 * @param {string} recordId  - UUID of the content record.
 * @param {string} publishedAt - ISO 8601 published_at timestamp.
 */
function annotationPanel(recordId, publishedAt) {
    return {
        recordId,
        publishedAt,

        // UI state
        loading: true,
        saving: false,
        saved: false,
        error: null,
        saveError: null,

        // Form state
        tagsInput: '',
        form: {
            stance: '',
            frame: '',
            is_relevant: null,
            notes: '',
            tags: [],
        },

        /**
         * Fetch the current user's annotation from the API on panel open.
         */
        async loadAnnotation() {
            this.loading = true;
            this.error = null;
            try {
                const params = new URLSearchParams({ published_at: this.publishedAt });
                const resp = await fetch(`/annotations/${this.recordId}?${params}`);
                if (!resp.ok) {
                    this.error = `Failed to load annotation (HTTP ${resp.status}).`;
                    return;
                }
                const data = await resp.json();
                if (data.annotation) {
                    this.applyAnnotation(data.annotation);
                    this.saved = true;
                }
            } catch (err) {
                this.error = 'Network error loading annotation.';
            } finally {
                this.loading = false;
            }
        },

        /**
         * Apply a server annotation object to the local form state.
         */
        applyAnnotation(ann) {
            this.form.stance = ann.stance || '';
            this.form.frame = ann.frame || '';
            this.form.is_relevant = ann.is_relevant !== undefined ? ann.is_relevant : null;
            this.form.notes = ann.notes || '';
            this.form.tags = Array.isArray(ann.tags) ? ann.tags : [];
            this.tagsInput = this.form.tags.join(', ');
        },

        /**
         * Parse the tags text input and sync to form.tags, then save.
         */
        syncTagsAndSave() {
            const raw = this.tagsInput.trim();
            this.form.tags = raw
                ? raw.split(',').map(t => t.trim()).filter(t => t.length > 0)
                : [];
            this.saveAnnotation();
        },

        /**
         * Remove a single tag chip and save.
         */
        removeTag(tag) {
            this.form.tags = this.form.tags.filter(t => t !== tag);
            this.tagsInput = this.form.tags.join(', ');
            this.saveAnnotation();
        },

        /**
         * POST the current form state to /annotations/{record_id}.
         */
        async saveAnnotation() {
            if (this.saving) return;
            this.saving = true;
            this.saveError = null;
            try {
                const payload = {
                    published_at: this.publishedAt,
                    stance: this.form.stance || null,
                    frame: this.form.frame || null,
                    is_relevant: this.form.is_relevant,
                    notes: this.form.notes || null,
                    tags: this.form.tags.length > 0 ? this.form.tags : null,
                    collection_run_id: null,
                    query_design_id: null,
                };
                const resp = await fetch(`/annotations/${this.recordId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    this.saveError = err.detail || `Save failed (HTTP ${resp.status}).`;
                    return;
                }
                const data = await resp.json();
                if (data.annotation) {
                    this.applyAnnotation(data.annotation);
                }
                this.saved = true;

                // Update the browser table row badge if it exists.
                const row = document.getElementById('record-row-' + this.recordId);
                if (row) {
                    let badge = row.querySelector('.annotation-badge');
                    if (!badge) {
                        const td = row.querySelector('td:nth-child(2)');
                        if (td) {
                            badge = document.createElement('span');
                            badge.className = 'annotation-badge inline-flex ml-1 w-2 h-2 rounded-full bg-green-500 flex-shrink-0';
                            badge.title = 'Annotated';
                            td.appendChild(badge);
                        }
                    }
                }
            } catch (err) {
                this.saveError = 'Network error saving annotation.';
            } finally {
                this.saving = false;
            }
        },

        /**
         * DELETE the current user's annotation for this record.
         */
        async deleteAnnotation() {
            if (!confirm('Remove your annotation for this record?')) return;
            try {
                const params = new URLSearchParams({ published_at: this.publishedAt });
                const resp = await fetch(`/annotations/${this.recordId}?${params}`, {
                    method: 'DELETE',
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    this.saveError = err.detail || `Delete failed (HTTP ${resp.status}).`;
                    return;
                }
                // Reset form
                this.form = { stance: '', frame: '', is_relevant: null, notes: '', tags: [] };
                this.tagsInput = '';
                this.saved = false;

                // Remove badge from browser table row if present.
                const row = document.getElementById('record-row-' + this.recordId);
                if (row) {
                    const badge = row.querySelector('.annotation-badge');
                    if (badge) badge.remove();
                }
            } catch (err) {
                this.saveError = 'Network error deleting annotation.';
            }
        },
    };
}
</script>

</div>

{% if standalone %}
</div>
{% endblock %}
{% endif %}
