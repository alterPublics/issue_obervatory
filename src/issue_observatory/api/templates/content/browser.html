{% extends "base.html" %}
{% block title %}Content Browser{% endblock %}

{% block content %}
{#
    Content browser — Task 1.16.
    Left sidebar: filter form (arena, platform, date range, search terms, language, run).
    Main area: paginated content table with HTMX infinite scroll (capped at 2000 rows).
    Detail panel: HTMX-loaded record detail on row click.

    GR-17: Quick-add actor modal — clickable author names open a "Quick-Add Source" modal
    that pre-fills platform + author and lets the researcher add to a query design's actor list.

    Context:
        - records (list): initial page of content records
        - total_count (int): total matching records for the current filter
        - recent_runs (list): [{id, status, query_design_name, created_at}] for run selector
        - user_projects (list): [{id, name}] for project filter
        - filter (dict): currently active filter values (from query params)
        - cursor (str|None): pagination cursor for next page
        - active_query_design_id (str|None): query design in scope, used by GR-17 actor-list fetch.
#}
{% set filter = filter | default({}) %}
{% set records = records | default([]) %}
{% set recent_runs = recent_runs | default([]) %}
{% set user_projects = user_projects | default([]) %}
{% set total_count = total_count | default(0) %}
{% set cursor = cursor | default('') %}
{% set active_query_design_id = active_query_design_id | default('') %}

{# Two-column layout: sidebar + main #}
<div class="flex gap-0 h-full" x-data="contentBrowser()">

    {# ------------------------------------------------------------------ #}
    {# Left sidebar — filter form                                          #}
    {# ------------------------------------------------------------------ #}
    <aside class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col overflow-y-auto"
           style="max-height: calc(100vh - 2rem)">
        <div class="px-4 py-4 border-b border-gray-200">
            <h2 class="text-sm font-semibold text-gray-900">Filters</h2>
        </div>

        <form id="filter-form"
              class="flex-1 px-4 py-4 space-y-5 overflow-y-auto"
              hx-get="/content/records"
              hx-target="#records-tbody"
              hx-swap="innerHTML"
              hx-trigger="change, keyup changed delay:400ms"
              hx-push-url="/content"
              hx-indicator="#table-spinner">

            {# Sort state (hidden — set by clickable column headers) #}
            <input type="hidden" name="sort_by" id="sort_by" value="{{ filter.sort_by | default('published_at') }}">
            <input type="hidden" name="sort_dir" id="sort_dir" value="{{ filter.sort_dir | default('desc') }}">

            {# Full-text search #}
            <div>
                <label for="q" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Search</label>
                <input type="text"
                       id="q"
                       name="q"
                       value="{{ filter.q | default('') }}"
                       placeholder="Search content..."
                       autocomplete="off"
                       class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            {# Arena checkboxes — dynamically populated from /api/arenas/ #}
            <div x-data="arenaFilter({{ filter.arenas | default([]) | tojson }})">
                <p class="text-xs font-medium text-gray-700 mb-2 uppercase tracking-wider">Arena</p>
                <div x-show="loading" class="flex items-center gap-2 text-xs text-gray-400 py-1.5">
                    <svg class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    Loading arenas...
                </div>
                <div x-show="!loading" class="space-y-3">
                    <template x-for="group in arenaGroups" :key="group.name">
                        <div>
                            <p class="text-xs font-medium text-gray-500 mb-1" x-text="group.label"></p>
                            <div class="space-y-1.5">
                                <template x-for="arena in group.arenas" :key="arena.platform_name">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox"
                                               name="arenas"
                                               :value="arena.platform_name"
                                               x-model="activeArenas"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="text-xs text-gray-700" x-text="arena.displayLabel"></span>
                                    </label>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            {# Date range #}
            <div>
                <p class="text-xs font-medium text-gray-700 mb-2 uppercase tracking-wider">Date Range</p>
                <div class="space-y-2">
                    <div>
                        <label for="date_from" class="block text-xs text-gray-500 mb-0.5">From</label>
                        <input type="date"
                               id="date_from"
                               name="date_from"
                               value="{{ filter.date_from | default('') }}"
                               class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="date_to" class="block text-xs text-gray-500 mb-0.5">To</label>
                        <input type="date"
                               id="date_to"
                               name="date_to"
                               value="{{ filter.date_to | default('') }}"
                               class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            {# Language #}
            <div>
                <label for="language" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Language</label>
                <select id="language"
                        name="language"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="" {% if not filter.language | default('') %}selected{% endif %}>All languages</option>
                    <option value="da" {% if filter.language | default('') == 'da' %}selected{% endif %}>Danish (da)</option>
                    <option value="en" {% if filter.language | default('') == 'en' %}selected{% endif %}>English (en)</option>
                    <option value="de" {% if filter.language | default('') == 'de' %}selected{% endif %}>German (de)</option>
                    <option value="kl" {% if filter.language | default('') == 'kl' %}selected{% endif %}>Greenlandic (kl)</option>
                    <option value="sv" {% if filter.language | default('') == 'sv' %}selected{% endif %}>Swedish (sv)</option>
                    <option value="no" {% if filter.language | default('') == 'no' %}selected{% endif %}>Norwegian (no)</option>
                    <option value="ru" {% if filter.language | default('') == 'ru' %}selected{% endif %}>Russian (ru)</option>
                    <option value="fr" {% if filter.language | default('') == 'fr' %}selected{% endif %}>French (fr)</option>
                </select>
            </div>

            {# SB-13: Collection Mode filter #}
            <div>
                <label for="mode" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Collection Mode</label>
                <select id="mode"
                        name="mode"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="" {% if not filter.mode | default('') %}selected{% endif %}>All</option>
                    <option value="batch" {% if filter.mode | default('') == 'batch' %}selected{% endif %}>Batch</option>
                    <option value="live" {% if filter.mode | default('') == 'live' %}selected{% endif %}>Live</option>
                </select>
                <p class="text-xs text-gray-400 mt-0.5">
                    Filter by collection type: one-time batch runs or live tracking.
                </p>
            </div>

            {# Project filter #}
            <div>
                <label for="project_id" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Project</label>
                <select id="project_id"
                        name="project_id"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">All projects</option>
                    {% for proj in user_projects | default([]) %}
                    <option value="{{ proj.id }}" {% if filter.project_id | default('') == proj.id %}selected{% endif %}>
                        {{ proj.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            {# Collection run — changing this also reloads the search term dropdown via HTMX #}
            <div>
                <label for="run_id" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Collection Run</label>
                <select id="run_id"
                        name="run_id"
                        hx-get="/content/search-terms"
                        hx-trigger="change"
                        hx-target="#search-term-filter"
                        hx-swap="innerHTML"
                        hx-include="[name='search_term']"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">All runs</option>
                    {% set runs_by_design = {} %}
                    {% for run in recent_runs %}
                        {% set design_name = run.query_design_name | default('Untitled') %}
                        {% if design_name not in runs_by_design %}
                            {% set _ = runs_by_design.__setitem__(design_name, []) %}
                        {% endif %}
                        {% set _ = runs_by_design[design_name].append(run) %}
                    {% endfor %}
                    {% for design_name, design_runs in runs_by_design.items() %}
                        <optgroup label="{{ design_name }}">
                        {% for run in design_runs %}
                            <option value="{{ run.id }}"
                                    {% if filter.run_id | default('') == run.id %}selected{% endif %}>
                                {{ run.formatted_date | default('') }}{% if run.records_collected %} ({{ '{:,}'.format(run.records_collected) }} records){% endif %}
                            </option>
                        {% endfor %}
                        </optgroup>
                    {% endfor %}
                </select>
            </div>

            {# Search terms matched — populated from the selected run's query design via HTMX #}
            <div>
                <label for="search_term" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Search Term</label>
                <div id="search-term-filter">
                    <select id="search_term"
                            name="search_term"
                            class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="" {% if not filter.search_term | default('') %}selected{% endif %}>All terms</option>
                        {% if filter.search_term | default('') %}
                        <option value="{{ filter.search_term }}" selected>{{ filter.search_term }}</option>
                        {% endif %}
                    </select>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">
                    Select a collection run above to filter by search term.
                </p>
            </div>

            {# Scrape status filter #}
            <div>
                <label for="scrape_status" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Scrape Status</label>
                <select id="scrape_status"
                        name="scrape_status"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="" {% if not filter.scrape_status | default('') %}selected{% endif %}>All scrape statuses</option>
                    <option value="pending" {% if filter.scrape_status | default('') == 'pending' %}selected{% endif %}>Needs scraping</option>
                    <option value="scraped" {% if filter.scrape_status | default('') == 'scraped' %}selected{% endif %}>Scraped</option>
                    <option value="failed"  {% if filter.scrape_status | default('') == 'failed'  %}selected{% endif %}>Scrape failed</option>
                </select>
                <p class="text-xs text-gray-400 mt-0.5">
                    Filter by whether full page content has been retrieved.
                </p>
            </div>

            {# Show non-matching content toggle #}
            <div>
                <p class="text-xs font-medium text-gray-700 mb-1.5 uppercase tracking-wider">Matching</p>
                <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                    <input type="checkbox"
                           name="show_all"
                           value="true"
                           {% if filter.show_all | default(false) %}checked{% endif %}
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    Show non-matching content
                </label>
                <p class="text-xs text-gray-400 mt-0.5">
                    Include records collected by actor tracking that did not match any search term.
                </p>
            </div>

            {# Reset filters button #}
            <div class="pt-2">
                <a href="/content"
                   class="block w-full text-center text-xs text-gray-500 hover:text-gray-700 py-1.5 border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                    Reset filters
                </a>
            </div>

        </form>{# /filter-form #}

        {# Export section at bottom of sidebar #}
        <div class="px-4 py-4 border-t border-gray-200 space-y-2">
            <button type="button"
                    hx-get="/content/export"
                    hx-include="#filter-form"
                    hx-swap="none"
                    hx-on::after-request="if(event.detail.xhr.getResponseHeader('Content-Disposition')){ window.location.href='/content/export?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(); }"
                    class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 text-gray-700 text-xs font-medium border border-gray-200 rounded hover:bg-gray-100 transition-colors">
                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export CSV
            </button>

            {# GR-22: Discovered Sources link #}
            <a href="/content/discovered-links"
               class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 text-gray-700 text-xs font-medium border border-gray-200 rounded hover:bg-gray-100 transition-colors">
                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                </svg>
                Discovered Sources
            </a>
        </div>
    </aside>

    {# ------------------------------------------------------------------ #}
    {# Main area — table + detail panel                                    #}
    {# ------------------------------------------------------------------ #}
    <div class="flex-1 flex flex-col min-w-0">

        {# Table header bar #}
        <div class="flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-sm font-semibold text-gray-900">Content</h1>
                <span class="text-xs text-gray-400" id="record-count">
                    {% if total_count > 2000 %}
                        2,000+ records
                    {% elif total_count > 0 %}
                        {{ '{:,}'.format(total_count | int) }} record{% if total_count != 1 %}s{% endif %}
                    {% endif %}
                </span>
                <span id="table-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5 text-blue-600" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
            </div>
            {# Column visibility controls (Alpine-driven) #}
            <div class="flex items-center gap-3 text-xs text-gray-500">
                <button type="button"
                        @click="showDetail = false"
                        x-show="showDetail"
                        class="hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100">
                    Close detail
                </button>
            </div>
        </div>

        {# 2000-row export banner — appears when row cap is reached #}
        <div x-show="rowCount >= 2000"
             x-cloak
             class="mx-6 mt-3 flex items-center gap-3 bg-yellow-50 border border-yellow-200 rounded-md px-4 py-2.5">
            <svg class="w-4 h-4 text-yellow-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-xs text-yellow-800">
                Display capped at 2,000 rows.
                <a href="#"
                   @click.prevent="triggerExport()"
                   class="font-medium underline hover:no-underline">Export CSV</a>
                to download all matching records.
            </p>
        </div>

        {# Table + detail panel split view #}
        <div class="flex flex-1 overflow-hidden">

            {# Content table #}
            <div class="flex-1 overflow-auto min-w-0">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-800"
                                data-sort-col="platform" onclick="setSort('platform')">Platform<span class="sort-arrow"></span></th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Content</th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell cursor-pointer select-none hover:text-gray-800"
                                data-sort-col="author" onclick="setSort('author')">Sender<span class="sort-arrow"></span></th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell cursor-pointer select-none hover:text-gray-800"
                                data-sort-col="published_at" onclick="setSort('published_at')">Published<span class="sort-arrow"></span></th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none hover:text-gray-800"
                                data-sort-col="arena" onclick="setSort('arena')">Arena<span class="sort-arrow"></span></th>
                            <th class="text-right px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell cursor-pointer select-none hover:text-gray-800"
                                data-sort-col="engagement_score" onclick="setSort('engagement_score')">
                                <span title="Composite engagement score (likes + shares + comments). Not comparable across platforms — each platform weights metrics differently."
                                      class="cursor-pointer border-b border-dashed border-gray-400">Engagement</span><span class="sort-arrow"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white" id="records-tbody"
                           @htmx:after-swap="updateRowCount()">
                        {% if records %}
                        {% for record in records %}
                        <tr class="hover:bg-blue-50/40 cursor-pointer transition-colors"
                            id="record-row-{{ record.id }}"
                            @click="openDetail('{{ record.id }}')"
                            hx-get="/content/{{ record.id }}"
                            hx-target="#detail-panel-inner"
                            hx-swap="innerHTML"
                            hx-on::after-request="showDetail = true"
                            :class="selectedId === '{{ record.id }}' ? 'bg-blue-50 border-l-2 border-blue-500' : ''">

                            {# Platform badge + SB-13: Mode badge #}
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="flex flex-col gap-1">
                                    <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium
                                        {% set p = record.platform | default('') %}
                                        {% if p == 'youtube' %}bg-red-100 text-red-800
                                        {% elif p == 'reddit' %}bg-orange-100 text-orange-800
                                        {% elif p == 'bluesky' %}bg-sky-100 text-sky-800
                                        {% elif p == 'telegram' %}bg-blue-100 text-blue-800
                                        {% elif p == 'tiktok' %}bg-slate-100 text-slate-800
                                        {% elif p == 'gab' %}bg-green-100 text-green-800
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        {{ record.platform | default('—') | capitalize }}
                                    </span>
                                    {# SB-13: Mode badge #}
                                    {% if record.mode | default('') %}
                                    <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium
                                        {% if record.mode == 'live' %}bg-green-100 text-green-700
                                        {% else %}bg-gray-100 text-gray-600{% endif %}">
                                        {{ record.mode | capitalize }}
                                    </span>
                                    {% endif %}

                                    {# Scrape status badge #}
                                    {% set ss = record.scrape_status | default('') %}
                                    {% if ss == 'pending' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700"
                                          title="Full content not yet scraped">
                                        <span class="w-1.5 h-1.5 rounded-full bg-amber-500 flex-shrink-0" aria-hidden="true"></span>
                                        Pending
                                    </span>
                                    {% elif ss == 'scraped' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700"
                                          title="Full content scraped">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 flex-shrink-0" aria-hidden="true"></span>
                                    </span>
                                    {% elif ss == 'failed' %}
                                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-700"
                                          title="Scrape attempt failed">
                                        <span class="w-1.5 h-1.5 rounded-full bg-red-500 flex-shrink-0" aria-hidden="true"></span>
                                        Failed
                                    </span>
                                    {% endif %}
                                </div>
                            </td>

                            {# Title / text excerpt #}
                            <td class="px-4 py-3 max-w-xs">
                                {% if record.title | default('') %}
                                    <p class="font-medium text-gray-900 truncate text-xs">{{ record.title | truncate(80) }}</p>
                                    {% if record.text | default('') %}
                                    <p class="text-gray-400 truncate text-xs mt-0.5">{{ record.text | truncate(80) }}</p>
                                    {% endif %}
                                {% else %}
                                    <p class="text-gray-700 truncate text-xs">{{ record.text | default('(no content)') | truncate(100) }}</p>
                                {% endif %}
                            </td>

                            {# Author — GR-17: clickable to open quick-add modal #}
                            <td class="px-4 py-3 text-xs text-gray-600 whitespace-nowrap hidden lg:table-cell">
                                {% if record.author | default('') %}
                                <button type="button"
                                        @click.stop="openQuickAdd({
                                            author: '{{ record.author | replace("'", "\\'") | truncate(64, true, '') }}',
                                            platform: '{{ record.platform | default('') }}',
                                            authorId: '{{ record.author_id | default('') | replace("'", "\\'") }}'
                                        })"
                                        class="text-blue-600 hover:text-blue-800 hover:underline transition-colors text-left"
                                        title="Quick-add {{ record.author | truncate(40, true, '…') }} to actor collection">
                                    {{ record.author | truncate(24, true, '…') }}
                                </button>
                                {% else %}
                                <span class="text-gray-400">—</span>
                                {% endif %}
                            </td>

                            {# Published at #}
                            <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap hidden md:table-cell">
                                {{ record.published_at | default('') | string | truncate(16, true, '') }} <span class="text-gray-400">UTC</span>
                            </td>

                            {# Arena #}
                            <td class="px-4 py-3">
                                <span class="text-xs text-gray-400 font-mono">{{ record.arena | default('') }}</span>
                            </td>

                            {# Engagement score #}
                            <td class="px-4 py-3 text-right text-xs font-mono text-gray-500 whitespace-nowrap hidden md:table-cell">
                                {% set eng = record.engagement_score | default(0) | int %}
                                {% if eng > 0 %}
                                    <span class="{% if eng > 1000 %}text-blue-700 font-medium{% elif eng > 100 %}text-gray-700{% else %}text-gray-400{% endif %}">
                                        {{ eng }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-300">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        {#
                            Infinite scroll sentinel — last row triggers the next page load.
                            hx-trigger="revealed" fires when the element scrolls into view.
                            Capped: hidden when rowCount >= 2000.
                        #}
                        {% if cursor %}
                        <tr id="scroll-sentinel"
                            hx-get="/content/records?cursor={{ cursor }}"
                            hx-trigger="revealed"
                            hx-target="#records-tbody"
                            hx-swap="beforeend"
                            hx-include="#filter-form"
                            hx-indicator="#table-spinner"
                            x-show="rowCount < 2000">
                            <td colspan="6" class="px-4 py-4 text-center">
                                {% include '_partials/loading_spinner.html' %}
                            </td>
                        </tr>
                        {% endif %}

                        {% else %}
                        {# Empty state #}
                        <tr>
                            <td colspan="6" class="px-6 py-16 text-center">
                                {% set empty_title = 'No content matches your filters' %}
                                {% set empty_message = 'Try broadening the filters in the sidebar, or run a new collection.' %}
                                {% include '_partials/empty_state.html' %}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            {# Detail panel — slides in when a row is clicked #}
            <aside id="detail-panel"
                   x-show="showDetail"
                   x-cloak
                   x-transition:enter="transition ease-out duration-200"
                   x-transition:enter-start="opacity-0 translate-x-4"
                   x-transition:enter-end="opacity-100 translate-x-0"
                   class="w-96 flex-shrink-0 border-l border-gray-200 bg-white overflow-y-auto">
                <div id="detail-panel-inner" class="p-5">
                    {# Populated by HTMX when a row is clicked #}
                    <p class="text-sm text-gray-400 text-center pt-8">Select a record to view details</p>
                </div>
            </aside>

        </div>{# /table+detail #}
    </div>{# /main area #}

</div>{# /two-column layout #}

{# ====================================================================== #}
{# GR-17: Quick-Add Source modal                                          #}
{# ====================================================================== #}
{#
    This modal is triggered by clicking any author name in the content table.
    It pre-fills platform, display name, and platform username from the clicked row.

    Backend contracts expected:
        GET  /query-designs/{design_id}/actor-lists
             Returns: JSON array of { id, name } actor lists for the given query design.
             Used here via HTMX to populate the "Add to actor list" dropdown.

        POST /actors/quick-add
             Body (JSON): {
                 display_name: str,
                 platform: str,
                 platform_username: str,
                 actor_type: "Individual" | "Organization" | "Bot",
                 actor_list_id: str | null
             }
             Returns: { was_created: bool, actor_id: str }
             When was_created is false: actor already existed — still added to actor list.
#}
<div x-data="quickAddModal('{{ active_query_design_id }}')"
     @quick-add-author.window="openFromEvent($event)"
     x-show="open"
     x-cloak
     class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
     @keydown.escape.window="open && close()">

    <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4"
         @click.stop>

        {# Modal header #}
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-900">Quick-Add Source</h2>
            <button type="button"
                    @click="close()"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {# Success / already-exists banners #}
        <div x-show="successMsg"
             x-cloak
             class="mx-6 mt-4 flex items-center gap-2 bg-green-50 border border-green-200 rounded-md px-4 py-2.5">
            <svg class="w-4 h-4 text-green-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
            <p class="text-sm text-green-800" x-text="successMsg"></p>
        </div>

        <div x-show="errorMsg"
             x-cloak
             class="mx-6 mt-4 flex items-center gap-2 bg-red-50 border border-red-200 rounded-md px-4 py-2.5">
            <svg class="w-4 h-4 text-red-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-sm text-red-700" x-text="errorMsg"></p>
        </div>

        {# Form fields #}
        <div class="px-6 py-5 space-y-4">

            {# Display name #}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Author name <span class="text-red-500">*</span>
                </label>
                <input type="text"
                       x-model="form.displayName"
                       placeholder="e.g. Mette Frederiksen"
                       class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            {# Platform (read-only, pre-filled) #}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                <input type="text"
                       x-model="form.platform"
                       placeholder="e.g. telegram"
                       class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            {# Platform username #}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Platform username</label>
                <input type="text"
                       x-model="form.platformUsername"
                       placeholder="Platform-specific identifier"
                       class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <p class="text-xs text-gray-400 mt-0.5">Used to look up the account. Leave as author name if unsure.</p>
            </div>

            {# Actor type #}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Actor type</label>
                <select x-model="form.actorType"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="Individual">Individual</option>
                    <option value="Organization">Organization</option>
                    <option value="Bot">Bot</option>
                </select>
            </div>

            {# Add to actor list dropdown — populated via fetch when modal opens #}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Add to actor list</label>
                <div x-show="listsLoading" class="flex items-center gap-2 text-xs text-gray-400 py-1.5">
                    <svg class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    Loading actor lists...
                </div>
                <select x-show="!listsLoading"
                        x-model="form.actorListId"
                        class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">— No list (registry only) —</option>
                    <template x-for="list in actorLists" :key="list.id">
                        <option :value="list.id" x-text="list.name"></option>
                    </template>
                </select>
                <p x-show="!listsLoading && actorLists.length === 0 && queryDesignId"
                   class="text-xs text-gray-400 mt-0.5">
                    No actor lists found for this query design.
                </p>
                <p x-show="!queryDesignId"
                   class="text-xs text-amber-600 mt-0.5">
                    No query design in scope — actor will be added to the registry only.
                </p>
            </div>

        </div>

        {# Modal footer actions #}
        <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
            <button type="button"
                    @click="close()"
                    class="text-sm text-gray-500 hover:text-gray-700 transition-colors">
                Cancel
            </button>
            <button type="button"
                    @click="submit()"
                    :disabled="submitting || !form.displayName.trim()"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <svg x-show="submitting"
                     class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                <span x-text="submitting ? 'Adding...' : 'Add to Collection'"></span>
            </button>
        </div>

    </div>
</div>

<script>
/**
 * Toggle sort column/direction and trigger a filter form reload.
 * Called from clickable <th> headers.  Resets pagination on sort change.
 */
function setSort(col) {
    const byEl = document.getElementById('sort_by');
    const dirEl = document.getElementById('sort_dir');
    if (byEl.value === col) {
        dirEl.value = dirEl.value === 'desc' ? 'asc' : 'desc';
    } else {
        byEl.value = col;
        dirEl.value = 'desc';
    }
    _updateSortArrows();
    htmx.trigger('#filter-form', 'change');
}

const _ARROW_UP = '<svg class="inline w-3 h-3 ml-0.5" viewBox="0 0 12 12" fill="currentColor"><path d="M6 2l4 5H2z"/></svg>';
const _ARROW_DN = '<svg class="inline w-3 h-3 ml-0.5" viewBox="0 0 12 12" fill="currentColor"><path d="M6 10l4-5H2z"/></svg>';

function _updateSortArrows() {
    const col = document.getElementById('sort_by').value;
    const dir = document.getElementById('sort_dir').value;
    document.querySelectorAll('th[data-sort-col]').forEach(function(th) {
        const arrow = th.querySelector('.sort-arrow');
        if (!arrow) return;
        if (th.dataset.sortCol === col) {
            arrow.innerHTML = dir === 'asc' ? _ARROW_UP : _ARROW_DN;
            th.classList.add('text-gray-800');
        } else {
            arrow.innerHTML = '';
            th.classList.remove('text-gray-800');
        }
    });
}

/* Initialize arrows on page load. */
document.addEventListener('DOMContentLoaded', _updateSortArrows);

/**
 * Alpine component for the arena filter sidebar section.
 * Fetches the live arena list from GET /api/arenas/ and populates checkboxes dynamically.
 * Groups arenas by arena_name (grouping label like "social_media", "news_media") with section headers.
 * @param {string[]} initialActiveArenas - Pre-selected arena platform_names from the URL filter.
 */
function arenaFilter(initialActiveArenas) {
    return {
        loading: true,
        arenaGroups: [],
        activeArenas: initialActiveArenas || [],

        async init() {
            try {
                const res = await fetch('/api/arenas/', {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' },
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                // Filter out deferred stubs (empty supported_tiers)
                const validArenas = data.filter(a => a.supported_tiers && a.supported_tiers.length > 0);

                // Group by arena_name
                const grouped = {};
                for (const arena of validArenas) {
                    const groupName = arena.arena_name;
                    if (!grouped[groupName]) {
                        grouped[groupName] = [];
                    }
                    grouped[groupName].push({
                        ...arena,
                        displayLabel: arena.platform_name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                    });
                }

                // Format group names as human-readable labels
                const formatGroupName = (name) => {
                    return name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                };

                // Convert to array of {name, label, arenas} objects, sorted by group name
                this.arenaGroups = Object.entries(grouped)
                    .map(([name, arenas]) => ({
                        name: name,
                        label: formatGroupName(name),
                        arenas: arenas.sort((a, b) => a.displayLabel.localeCompare(b.displayLabel)),
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label));
            } catch (e) {
                console.error('Failed to load arenas:', e);
                this.arenaGroups = [];
            } finally {
                this.loading = false;
            }
        },
    };
}

/**
 * Alpine component for the content browser.
 * Manages detail panel show/hide state, row count for the 2000-row cap,
 * and dispatches the quick-add author event for GR-17.
 */
function contentBrowser() {
    return {
        showDetail: false,
        selectedId: null,
        rowCount: {{ records | length }},

        openDetail(id) {
            this.selectedId = id;
            this.showDetail = true;
        },

        /**
         * GR-17: dispatch a custom event that the quickAddModal component listens to.
         * Stops row-click propagation to prevent the detail panel opening simultaneously.
         * @param {Object} data - { author, platform, authorId }
         */
        openQuickAdd(data) {
            this.$dispatch('quick-add-author', data);
        },

        updateRowCount() {
            // Count <tr> rows in the table body (excluding the sentinel row)
            const tbody = document.getElementById('records-tbody');
            if (tbody) {
                this.rowCount = tbody.querySelectorAll('tr[id^="record-row-"]').length;
            }
        },

        triggerExport() {
            const form = document.getElementById('filter-form');
            if (!form) return;
            const formData = new FormData(form);
            const params = new URLSearchParams(formData).toString();
            window.location.href = '/content/export?' + params;
        },
    };
}

/**
 * GR-17: Quick-Add Source modal Alpine component.
 *
 * On open, fetches actor lists for the active query design from
 * GET /query-designs/{design_id}/actor-lists.
 *
 * On submit, POSTs to POST /actors/quick-add with the form payload.
 *
 * @param {string} queryDesignId - Jinja-injected active query design UUID (may be empty string).
 */
function quickAddModal(queryDesignId) {
    return {
        open: false,
        queryDesignId: queryDesignId || '',
        submitting: false,
        listsLoading: false,
        actorLists: [],
        successMsg: null,
        errorMsg: null,

        form: {
            displayName: '',
            platform: '',
            platformUsername: '',
            actorType: 'Individual',
            actorListId: '',
        },

        /**
         * Receives the custom event dispatched by contentBrowser.openQuickAdd().
         * Pre-fills form fields from the clicked author row.
         */
        openFromEvent(event) {
            const { author, platform, authorId } = event.detail;
            this.form.displayName = author || '';
            this.form.platform = platform || '';
            // Use authorId as platform username if available; fall back to display name.
            this.form.platformUsername = (authorId && authorId.trim()) ? authorId : (author || '');
            this.form.actorType = 'Individual';
            this.form.actorListId = '';
            this.successMsg = null;
            this.errorMsg = null;
            this.open = true;
            this.fetchActorLists();
        },

        close() {
            this.open = false;
            this.successMsg = null;
            this.errorMsg = null;
        },

        /**
         * Fetch actor lists for the active query design so the researcher can
         * pick which list to add the new actor to.
         *
         * Endpoint: GET /query-designs/{design_id}/actor-lists
         * Expected response shape: [{ id: string, name: string }, ...]
         *
         * When queryDesignId is empty (backend gap — see template comment at top),
         * the fetch is skipped and the dropdown shows only the "registry only" option.
         */
        async fetchActorLists() {
            if (!this.queryDesignId) {
                this.actorLists = [];
                return;
            }
            this.listsLoading = true;
            try {
                const res = await fetch(`/query-designs/${this.queryDesignId}/actor-lists`, {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' },
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                // Accept both array root or { results: [...] } wrapper.
                this.actorLists = Array.isArray(data) ? data : (data.results || data.items || []);
            } catch (_e) {
                // Non-fatal: researcher can still add to registry without a list.
                this.actorLists = [];
            } finally {
                this.listsLoading = false;
            }
        },

        /**
         * POST to /actors/quick-add with the current form state.
         * On success: show a brief "Added!" toast then close after 1.5s.
         * On was_created=false: show "Already in registry — added to list" message.
         */
        async submit() {
            if (!this.form.displayName.trim() || this.submitting) return;

            this.submitting = true;
            this.successMsg = null;
            this.errorMsg = null;

            try {
                const payload = {
                    display_name: this.form.displayName.trim(),
                    platform: this.form.platform.trim(),
                    platform_username: this.form.platformUsername.trim() || this.form.displayName.trim(),
                    actor_type: this.form.actorType,
                    actor_list_id: this.form.actorListId || null,
                };

                const res = await fetch('/actors/quick-add', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.detail || `HTTP ${res.status}: ${res.statusText}`);
                }

                const result = await res.json();

                if (result.was_created === false) {
                    this.successMsg = 'Already in registry — added to actor list.';
                } else {
                    this.successMsg = 'Added to collection!';
                }

                // Auto-close after 1.5 seconds so the researcher can keep browsing.
                setTimeout(() => { this.close(); }, 1500);

            } catch (e) {
                this.errorMsg = e.message || 'An unexpected error occurred. Please try again.';
            } finally {
                this.submitting = false;
            }
        },
    };
}
</script>
{% endblock %}
