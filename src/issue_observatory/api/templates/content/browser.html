{% extends "base.html" %}
{% block title %}Content Browser — Issue Observatory{% endblock %}

{% block content %}
{#
    Content browser — Task 1.16.
    Left sidebar: filter form (arena, platform, date range, search terms, language, run).
    Main area: paginated content table with HTMX infinite scroll (capped at 2000 rows).
    Detail panel: HTMX-loaded record detail on row click.

    Context:
        - records (list): initial page of content records
        - total_count (int): total matching records for the current filter
        - recent_runs (list): [{id, status, query_design_name, created_at}] for run selector
        - filter (dict): currently active filter values (from query params)
        - cursor (str|None): pagination cursor for next page
#}
{% set filter = filter | default({}) %}
{% set records = records | default([]) %}
{% set recent_runs = recent_runs | default([]) %}
{% set total_count = total_count | default(0) %}
{% set cursor = cursor | default('') %}

{# Two-column layout: sidebar + main #}
<div class="flex gap-0 h-full" x-data="contentBrowser()">

    {# ------------------------------------------------------------------ #}
    {# Left sidebar — filter form                                          #}
    {# ------------------------------------------------------------------ #}
    <aside class="w-64 flex-shrink-0 bg-white border-r border-gray-200 flex flex-col overflow-y-auto"
           style="max-height: calc(100vh - 2rem)">
        <div class="px-4 py-4 border-b border-gray-200">
            <h2 class="text-sm font-semibold text-gray-900">Filters</h2>
        </div>

        <form id="filter-form"
              class="flex-1 px-4 py-4 space-y-5 overflow-y-auto"
              hx-get="/content/records"
              hx-target="#records-tbody"
              hx-swap="innerHTML"
              hx-trigger="change, keyup changed delay:400ms"
              hx-push-url="true"
              hx-indicator="#table-spinner">

            {# Full-text search #}
            <div>
                <label for="q" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Search</label>
                <input type="text"
                       id="q"
                       name="q"
                       value="{{ filter.q | default('') }}"
                       placeholder="Search content..."
                       autocomplete="off"
                       class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            {# Arena checkboxes #}
            <div>
                <p class="text-xs font-medium text-gray-700 mb-2 uppercase tracking-wider">Arena</p>
                <div class="space-y-1.5">
                    {% set arena_options = [
                        ('google_search',       'Google Search'),
                        ('google_autocomplete', 'Autocomplete'),
                        ('bluesky',             'Bluesky'),
                        ('reddit',              'Reddit'),
                        ('youtube',             'YouTube'),
                        ('rss_feeds',           'RSS Feeds'),
                        ('gdelt',               'GDELT'),
                        ('telegram',            'Telegram'),
                        ('tiktok',              'TikTok'),
                        ('ritzau_via',          'Ritzau'),
                        ('gab',                 'Gab'),
                    ] %}
                    {% set active_arenas = filter.arenas | default([]) %}
                    {% for val, label in arena_options %}
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox"
                               name="arenas"
                               value="{{ val }}"
                               {% if val in active_arenas %}checked{% endif %}
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-xs text-gray-700">{{ label }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            {# Date range #}
            <div>
                <p class="text-xs font-medium text-gray-700 mb-2 uppercase tracking-wider">Date Range</p>
                <div class="space-y-2">
                    <div>
                        <label for="date_from" class="block text-xs text-gray-500 mb-0.5">From</label>
                        <input type="date"
                               id="date_from"
                               name="date_from"
                               value="{{ filter.date_from | default('') }}"
                               class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="date_to" class="block text-xs text-gray-500 mb-0.5">To</label>
                        <input type="date"
                               id="date_to"
                               name="date_to"
                               value="{{ filter.date_to | default('') }}"
                               class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            {# Language #}
            <div>
                <label for="language" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Language</label>
                <select id="language"
                        name="language"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="" {% if not filter.language | default('') %}selected{% endif %}>All languages</option>
                    <option value="da" {% if filter.language | default('') == 'da' %}selected{% endif %}>Danish (da)</option>
                    <option value="en" {% if filter.language | default('') == 'en' %}selected{% endif %}>English (en)</option>
                    <option value="de" {% if filter.language | default('') == 'de' %}selected{% endif %}>German (de)</option>
                </select>
            </div>

            {#
                Collection run — changing this also reloads the search term dropdown.

                BACKEND GAP (IP2-029): The HTMX call below uses hx-get="/content/search-terms"
                which does NOT yet exist in content.py. The endpoint must be added to serve an
                HTML fragment (<option> elements) for the #search-term-filter select.

                Required endpoint:
                    GET /content/search-terms?run_id={uuid}
                    Returns: HTML <option> fragments listing the distinct search terms matched
                             in the content records for that collection run.
                    Query params: run_id (UUID, optional) — filter terms to this run's records.

                Until this endpoint is implemented, selecting a run will trigger a 404 on
                the HTMX call, which HTMX will silently ignore (the dropdown stays empty).
            #}
            <div>
                <label for="run_id" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Collection Run</label>
                <select id="run_id"
                        name="run_id"
                        hx-get="/content/search-terms"
                        hx-trigger="change"
                        hx-target="#search-term-filter"
                        hx-swap="innerHTML"
                        hx-include="[name='search_term']"
                        class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                    <option value="">All runs</option>
                    {% for run in recent_runs %}
                    <option value="{{ run.id }}"
                            {% if filter.run_id | default('') == run.id %}selected{% endif %}>
                        {{ run.query_design_name | default('Run') | truncate(24, true, '…') }}
                        ({{ run.created_at | default('') | truncate(10, true, '') }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            {# Search terms matched — populated from the selected run's query design via HTMX #}
            <div>
                <label for="search_term" class="block text-xs font-medium text-gray-700 mb-1 uppercase tracking-wider">Search Term</label>
                <div id="search-term-filter">
                    <select id="search_term"
                            name="search_term"
                            class="w-full border border-gray-300 rounded px-2.5 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="" {% if not filter.search_term | default('') %}selected{% endif %}>All terms</option>
                        {% if filter.search_term | default('') %}
                        <option value="{{ filter.search_term }}" selected>{{ filter.search_term }}</option>
                        {% endif %}
                    </select>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">
                    Select a collection run above to filter by search term.
                </p>
            </div>

            {# Reset filters button #}
            <div class="pt-2">
                <a href="/content"
                   class="block w-full text-center text-xs text-gray-500 hover:text-gray-700 py-1.5 border border-gray-200 rounded hover:bg-gray-50 transition-colors">
                    Reset filters
                </a>
            </div>

        </form>{# /filter-form #}

        {# Export section at bottom of sidebar #}
        <div class="px-4 py-4 border-t border-gray-200">
            <button type="button"
                    hx-get="/content/export"
                    hx-include="#filter-form"
                    hx-swap="none"
                    hx-on::after-request="if(event.detail.xhr.getResponseHeader('Content-Disposition')){ window.location.href='/content/export?' + new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString(); }"
                    class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 bg-gray-50 text-gray-700 text-xs font-medium border border-gray-200 rounded hover:bg-gray-100 transition-colors">
                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Export CSV
            </button>
        </div>
    </aside>

    {# ------------------------------------------------------------------ #}
    {# Main area — table + detail panel                                    #}
    {# ------------------------------------------------------------------ #}
    <div class="flex-1 flex flex-col min-w-0">

        {# Table header bar #}
        <div class="flex items-center justify-between px-6 py-3 bg-white border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center gap-3">
                <h1 class="text-sm font-semibold text-gray-900">Content</h1>
                <span class="text-xs text-gray-400" id="record-count">
                    {% if total_count > 0 %}
                        {{ total_count | int }} record{% if total_count != 1 %}s{% endif %}
                    {% endif %}
                </span>
                <span id="table-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5 text-blue-600" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
            </div>
            {# Column visibility controls (Alpine-driven) #}
            <div class="flex items-center gap-3 text-xs text-gray-500">
                <button type="button"
                        @click="showDetail = false"
                        x-show="showDetail"
                        class="hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100">
                    Close detail
                </button>
            </div>
        </div>

        {# 2000-row export banner — appears when row cap is reached #}
        <div x-show="rowCount >= 2000"
             x-cloak
             class="mx-6 mt-3 flex items-center gap-3 bg-yellow-50 border border-yellow-200 rounded-md px-4 py-2.5">
            <svg class="w-4 h-4 text-yellow-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-xs text-yellow-800">
                Display capped at 2,000 rows.
                <a href="#"
                   @click.prevent="triggerExport()"
                   class="font-medium underline hover:no-underline">Export CSV</a>
                to download all matching records.
            </p>
        </div>

        {# Table + detail panel split view #}
        <div class="flex flex-1 overflow-hidden">

            {# Content table #}
            <div class="flex-1 overflow-auto min-w-0">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                        <tr>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Content</th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden lg:table-cell">Author</th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Published</th>
                            <th class="text-left px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Arena</th>
                            <th class="text-right px-4 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                <span title="Composite engagement score (likes + shares + comments). Not comparable across platforms — each platform weights metrics differently."
                                      class="cursor-help border-b border-dashed border-gray-400">Engagement</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white" id="records-tbody"
                           @htmx:after-swap="updateRowCount()">
                        {% if records %}
                        {% for record in records %}
                        <tr class="hover:bg-blue-50/40 cursor-pointer transition-colors"
                            id="record-row-{{ record.id }}"
                            @click="openDetail('{{ record.id }}')"
                            hx-get="/content/{{ record.id }}"
                            hx-target="#detail-panel-inner"
                            hx-swap="innerHTML"
                            hx-on::after-request="showDetail = true"
                            :class="selectedId === '{{ record.id }}' ? 'bg-blue-50 border-l-2 border-blue-500' : ''">

                            {# Platform badge #}
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium
                                    {% set p = record.platform | default('') %}
                                    {% if p == 'youtube' %}bg-red-100 text-red-800
                                    {% elif p == 'reddit' %}bg-orange-100 text-orange-800
                                    {% elif p == 'bluesky' %}bg-sky-100 text-sky-800
                                    {% elif p == 'telegram' %}bg-blue-100 text-blue-800
                                    {% elif p == 'tiktok' %}bg-slate-100 text-slate-800
                                    {% elif p == 'gab' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                                    {{ record.platform | default('—') | capitalize }}
                                </span>
                            </td>

                            {# Title / text excerpt #}
                            <td class="px-4 py-3 max-w-xs">
                                {% if record.title | default('') %}
                                    <p class="font-medium text-gray-900 truncate text-xs">{{ record.title | truncate(80) }}</p>
                                    {% if record.text | default('') %}
                                    <p class="text-gray-400 truncate text-xs mt-0.5">{{ record.text | truncate(80) }}</p>
                                    {% endif %}
                                {% else %}
                                    <p class="text-gray-700 truncate text-xs">{{ record.text | default('(no content)') | truncate(100) }}</p>
                                {% endif %}
                            </td>

                            {# Author #}
                            <td class="px-4 py-3 text-xs text-gray-600 whitespace-nowrap hidden lg:table-cell">
                                {{ record.author | default('—') | truncate(24, true, '…') }}
                            </td>

                            {# Published at #}
                            <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap hidden md:table-cell">
                                {{ record.published_at | default('') | truncate(16, true, '') }}
                            </td>

                            {# Arena #}
                            <td class="px-4 py-3">
                                <span class="text-xs text-gray-400 font-mono">{{ record.arena | default('') }}</span>
                            </td>

                            {# Engagement score #}
                            <td class="px-4 py-3 text-right text-xs font-mono text-gray-500 whitespace-nowrap hidden md:table-cell">
                                {% set eng = record.engagement_score | default(0) | int %}
                                {% if eng > 0 %}
                                    <span class="{% if eng > 1000 %}text-blue-700 font-medium{% elif eng > 100 %}text-gray-700{% else %}text-gray-400{% endif %}">
                                        {{ eng }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-300">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}

                        {#
                            Infinite scroll sentinel — last row triggers the next page load.
                            hx-trigger="revealed" fires when the element scrolls into view.
                            Capped: hidden when rowCount >= 2000.
                        #}
                        {% if cursor %}
                        <tr id="scroll-sentinel"
                            hx-get="/content/records?cursor={{ cursor }}"
                            hx-trigger="revealed"
                            hx-target="#records-tbody"
                            hx-swap="beforeend"
                            hx-include="#filter-form"
                            hx-indicator="#table-spinner"
                            x-show="rowCount < 2000">
                            <td colspan="6" class="px-4 py-4 text-center">
                                {% include '_partials/loading_spinner.html' %}
                            </td>
                        </tr>
                        {% endif %}

                        {% else %}
                        {# Empty state #}
                        <tr>
                            <td colspan="6" class="px-6 py-16 text-center">
                                {% set empty_title = 'No content matches your filters' %}
                                {% set empty_message = 'Try broadening the filters in the sidebar, or run a new collection.' %}
                                {% include '_partials/empty_state.html' %}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            {# Detail panel — slides in when a row is clicked #}
            <aside id="detail-panel"
                   x-show="showDetail"
                   x-cloak
                   x-transition:enter="transition ease-out duration-200"
                   x-transition:enter-start="opacity-0 translate-x-4"
                   x-transition:enter-end="opacity-100 translate-x-0"
                   class="w-96 flex-shrink-0 border-l border-gray-200 bg-white overflow-y-auto">
                <div id="detail-panel-inner" class="p-5">
                    {# Populated by HTMX when a row is clicked #}
                    <p class="text-sm text-gray-400 text-center pt-8">Select a record to view details</p>
                </div>
            </aside>

        </div>{# /table+detail #}
    </div>{# /main area #}

</div>{# /two-column layout #}

<script>
/**
 * Alpine component for the content browser.
 * Manages detail panel show/hide state and row count for the 2000-row cap.
 */
function contentBrowser() {
    return {
        showDetail: false,
        selectedId: null,
        rowCount: {{ records | length }},

        openDetail(id) {
            this.selectedId = id;
            this.showDetail = true;
        },

        updateRowCount() {
            // Count <tr> rows in the table body (excluding the sentinel row)
            const tbody = document.getElementById('records-tbody');
            if (tbody) {
                this.rowCount = tbody.querySelectorAll('tr[id^="record-row-"]').length;
            }
        },

        triggerExport() {
            const form = document.getElementById('filter-form');
            if (!form) return;
            const params = new URLSearchParams(new FormData(form)).toString();
            window.location.href = '/content/export?' + params;
        },
    };
}
</script>
{% endblock %}
