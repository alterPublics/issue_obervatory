<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} — The Issue Observatory</title>

    {#
        Tailwind CSS — development fallback via CDN play script.
        TODO: Replace with compiled app.css for production:
              make css
              (npx tailwindcss -i input.css -o app.css --minify)
        The CDN script is ~350KB and does JIT compilation in the browser.
        It is acceptable for local development but must not ship to production.
    #}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 600: '#2563eb', 700: '#1d4ed8' }
                    }
                }
            }
        }
    </script>

    {# Compiled CSS — empty placeholder until `make css` is run. #}
    <link rel="stylesheet" href="{{ url_for('static', path='css/app.css') }}">

    {# HTMX 2 — core library for all server interactions. #}
    <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"
            integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
            crossorigin="anonymous"></script>

    {# HTMX SSE extension — used on collection detail pages for live run status. #}
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>

    {# Alpine.js 3 — local browser state (forms, modals, dropdowns). defer is required. #}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>

    {# Chart.js 4 — descriptive statistics charts on the analysis page. #}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

    {# Application JS — must load before Alpine initialises (no defer). #}
    <script src="{{ url_for('static', path='js/app.js') }}?v=4"></script>

    {#
        Alpine.js ↔ HTMX bridge (inline).
        When hx-boost swaps page content, Alpine.js must re-initialise x-data
        components on the new DOM. This inline copy ensures the bridge is always
        active even if app.js is cached by the browser.
    #}
    <script>
    document.addEventListener('htmx:load', function (evt) {
        if (window.Alpine) window.Alpine.initTree(evt.detail.elt);
    });
    </script>

    {# Chart helpers — loaded after Chart.js CDN, also without defer so initVolumeChart etc. are available in template <script> blocks. #}
    <script src="{{ url_for('static', path='js/charts.js') }}"></script>

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex" hx-boost="true">
    {% include '_partials/nav.html' %}
    <main class="flex-1 p-6 overflow-auto">
        {% include '_partials/flash.html' %}
        {% block content %}{% endblock %}
    </main>

    {# Session expiry warning — shows banner 5 minutes before the 30-minute session expires #}
    <div id="session-expiry-warning"
         class="hidden fixed bottom-0 left-0 right-0 bg-amber-100 border-t-2 border-amber-400 px-4 py-3 shadow-lg z-50"
         x-data="{ show: false }"
         x-show="show"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="transform translate-y-full"
         x-transition:enter-end="transform translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="transform translate-y-0"
         x-transition:leave-end="transform translate-y-full">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-amber-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="text-sm font-medium text-amber-900">
                        Your session will expire in <span x-text="Math.ceil((window.__sessionExpiresAt - Date.now()) / 60000)"></span> minutes.
                    </p>
                    <p class="text-xs text-amber-700">
                        Save your work and refresh the page to extend your session.
                    </p>
                </div>
            </div>
            <button type="button"
                    @click="show = false"
                    class="text-amber-900 hover:text-amber-700 transition-colors"
                    aria-label="Dismiss session warning">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
    (function() {
        // Session sliding window: the server middleware re-issues the JWT on
        // every successful request, so the 30-minute TTL resets on activity.
        // This client-side timer tracks the last known activity and warns
        // when 30 minutes of inactivity are about to expire the session.
        var SESSION_DURATION_MS = 30 * 60 * 1000;
        var WARNING_THRESHOLD_MS = 5 * 60 * 1000;

        window.__sessionExpiresAt = Date.now() + SESSION_DURATION_MS;

        // Reset the expiry timer on every successful HTMX request, since the
        // server middleware just refreshed the JWT cookie.
        document.addEventListener('htmx:afterRequest', function (evt) {
            if (evt.detail.xhr.status >= 200 && evt.detail.xhr.status < 400) {
                window.__sessionExpiresAt = Date.now() + SESSION_DURATION_MS;
                // Hide the warning banner if it was showing
                var warningEl = document.getElementById('session-expiry-warning');
                if (warningEl) {
                    warningEl.classList.add('hidden');
                    try { Alpine.$data(warningEl).show = false; } catch(e) {}
                }
            }
        });

        function checkSessionExpiry() {
            var timeRemaining = window.__sessionExpiresAt - Date.now();
            if (timeRemaining <= WARNING_THRESHOLD_MS && timeRemaining > 0) {
                var warningEl = document.getElementById('session-expiry-warning');
                if (warningEl) {
                    warningEl.classList.remove('hidden');
                    try { Alpine.$data(warningEl).show = true; } catch(e) {}
                }
            }
        }

        setInterval(checkSessionExpiry, 30000);
        document.addEventListener('DOMContentLoaded', checkSessionExpiry);
    })();
    </script>
</body>
</html>
