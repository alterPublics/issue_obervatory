{% extends "base.html" %}
{% block title %}{% if design_id is defined and design_id %}Edit Query Design{% else %}New Query Design{% endif %}{% endblock %}

{% block content %}
{#
    Query design editor — Phase 1.14 implementation.
    Covers: core metadata form + search terms panel (HTMX add/remove)
            + arena configuration grid (Alpine-powered, per-arena tier selection)
            + actor list sub-panel (HTMX add/remove actors).

    Context:
        - design (dict|None): existing design for editing, or None for create
        - design_id (str|None): UUID string (also derivable from design.id)
        - terms (list): existing search terms (dicts with id, term, term_type, is_active)
        - actors (list): existing actor list members (dicts with id, name, type)
        - parent_design_id (str|None): set when this design was cloned from another (IP2-051)
        - parent_design_name (str|None): human-readable name of the source design, if available
#}
{% set is_edit = design_id is defined and design_id %}
{% set action_url = '/query-designs/' + design_id if is_edit else '/query-designs/' %}
{% set design = design | default({}) %}
{% set terms = terms | default([]) %}
{% set actors = actors | default([]) %}
{% set parent_design_id = parent_design_id | default(design.parent_design_id | default(None)) %}
{% set parent_design_name = parent_design_name | default(design.parent_design_name | default(None)) %}

<div class="max-w-4xl mx-auto space-y-6" x-data="queryEditor()">

    {# Page header #}
    <div class="flex items-center gap-3">
        <a href="/query-designs"
           class="text-gray-400 hover:text-gray-600 transition-colors"
           aria-label="Back to list">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <div class="flex-1">
            <h1 class="text-xl font-bold text-gray-900">
                {% if is_edit %}Edit Query Design{% else %}New Query Design{% endif %}
            </h1>
            {#
                IP2-051: If this design was cloned from another, show a provenance note
                so researchers can trace the lineage of their query designs.
            #}
            {% if parent_design_id %}
            <p class="text-xs text-gray-400 mt-0.5">
                Cloned from:
                {% if parent_design_name %}
                <a href="/query-designs/{{ parent_design_id }}"
                   class="text-blue-500 hover:text-blue-700 hover:underline">{{ parent_design_name }}</a>
                {% else %}
                <a href="/query-designs/{{ parent_design_id }}"
                   class="text-blue-500 hover:text-blue-700 hover:underline font-mono">{{ parent_design_id | truncate(8, true, '') }}</a>
                {% endif %}
            </p>
            {% endif %}
        </div>
        {# Clone action — only shown when editing an existing design (IP2-051) #}
        {% if is_edit %}
        <button type="button"
                hx-post="/query-designs/{{ design_id }}/clone"
                hx-confirm="Create a copy of '{{ design.name | default('this design') }}'?"
                hx-boost="false"
                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-purple-700 border border-purple-200 rounded-md hover:bg-purple-50 transition-colors">
            <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
            </svg>
            Clone
        </button>
        {% endif %}
    </div>

    {# Metadata form #}
    <div class="bg-white rounded-lg shadow p-6 space-y-5">
        <h2 class="text-sm font-semibold text-gray-900 border-b border-gray-200 pb-3">Basic Information</h2>

        <form method="POST"
              action="{{ action_url }}"
              id="design-form"
              hx-post="{{ action_url if not is_edit else '' }}"
              hx-put="{{ action_url if is_edit else '' }}"
              {% if not is_edit %}
              hx-on::after-request="if(event.detail.successful){ window.location.href = '/query-designs/' + event.detail.xhr.getResponseHeader('HX-Redirect-To') || '/query-designs' }"
              {% endif %}>

            <div class="grid grid-cols-2 gap-5">
                {# Name #}
                <div class="col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                        Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           id="name"
                           name="name"
                           required
                           maxlength="200"
                           value="{{ design.name | default('') }}"
                           placeholder="e.g. Climate debate DK 2024"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                {# Description #}
                <div class="col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea id="description"
                              name="description"
                              rows="3"
                              placeholder="Brief description of the purpose and scope of this query design..."
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none">{{ design.description | default('') }}</textarea>
                </div>

                {# Visibility #}
                <div>
                    <label for="visibility" class="block text-sm font-medium text-gray-700 mb-1">
                        Visibility
                    </label>
                    <select id="visibility"
                            name="visibility"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="private" {% if design.visibility | default('private') == 'private' %}selected{% endif %}>Private</option>
                        <option value="team"    {% if design.visibility | default('') == 'team' %}selected{% endif %}>Team</option>
                        <option value="public"  {% if design.visibility | default('') == 'public' %}selected{% endif %}>Public</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Public designs are visible to all users, but only you can edit them.</p>
                </div>

                {# Default tier #}
                <div>
                    <label for="default_tier" class="block text-sm font-medium text-gray-700 mb-1">
                        Default Collection Tier
                    </label>
                    <select id="default_tier"
                            name="default_tier"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="free"    {% if design.default_tier | default('free') == 'free' %}selected{% endif %}>Free — free data sources only</option>
                        <option value="medium"  {% if design.default_tier | default('') == 'medium' %}selected{% endif %}>Medium — low-cost paid services</option>
                        <option value="premium" {% if design.default_tier | default('') == 'premium' %}selected{% endif %}>Premium — best available</option>
                    </select>
                </div>

                {# Language — kept for backwards compatibility; languages array (GR-05) takes priority #}
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-700 mb-1">
                        Primary Language
                    </label>
                    <select id="language"
                            name="language"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="da" {% if design.language | default('da') == 'da' %}selected{% endif %}>Danish (da)</option>
                        <option value="en" {% if design.language | default('') == 'en' %}selected{% endif %}>English (en)</option>
                        <option value="kl" {% if design.language | default('') == 'kl' %}selected{% endif %}>Greenlandic / Kalaallisut (kl)</option>
                        <option value="de" {% if design.language | default('') == 'de' %}selected{% endif %}>German (de)</option>
                        <option value="sv" {% if design.language | default('') == 'sv' %}selected{% endif %}>Swedish (sv)</option>
                        <option value="no" {% if design.language | default('') == 'no' %}selected{% endif %}>Norwegian (no)</option>
                        <option value="ru" {% if design.language | default('') == 'ru' %}selected{% endif %}>Russian (ru)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">
                        Set additional languages in the "Languages" panel below after saving.
                    </p>
                </div>

            </div>

            {# Save button for metadata #}
            {% if not is_edit %}
            <div class="pt-4 border-t border-gray-200 mt-5 flex items-center justify-between">
                <a href="/query-designs"
                   class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
                <button type="submit"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50">
                    Create Query Design
                </button>
            </div>
            {% else %}
            <div class="pt-4 border-t border-gray-200 mt-5 flex items-center justify-between">
                <a href="/query-designs/{{ design_id }}"
                   class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
                <button type="submit"
                        hx-put="{{ action_url }}"
                        hx-target="#design-form"
                        hx-swap="none"
                        hx-indicator="#save-spinner"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                    {% include '_partials/loading_spinner.html' %}
                    Save Changes
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    {% if is_edit %}

    {# Predefined group name suggestions for the group autocomplete input #}
    <datalist id="term-group-suggestions">
        <option value="Primary terms">
        <option value="Discourse associations">
        <option value="Actor discovery terms">
        <option value="English variants">
        <option value="Related concepts">
    </datalist>

    {# Search terms panel #}
    <div class="bg-white rounded-lg shadow p-6" x-data="{ ...termGroupManager(), ...termArenaSelector(), ...bulkTermImporter() }">
        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <h2 class="text-sm font-semibold text-gray-900">Search Terms</h2>
            <div class="flex items-center gap-3">
                <button type="button"
                        @click="bulkMode = !bulkMode"
                        class="text-xs font-medium rounded px-2 py-1 transition-colors"
                        :class="bulkMode ? 'bg-blue-100 text-blue-700 hover:bg-blue-200' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'">
                    <span x-text="bulkMode ? 'Single Term' : 'Bulk Add'"></span>
                </button>
                <span class="text-xs text-gray-400" id="term-count">{{ terms | length }} term{% if terms | length != 1 %}s{% endif %}</span>
            </div>
        </div>

        {# Single term form (shown by default) #}
        <form x-show="!bulkMode"
              hx-post="/query-designs/{{ design_id }}/terms"
              hx-target="#terms-list"
              hx-swap="beforeend"
              hx-on::after-request="if(event.detail.successful){ this.reset(); $root.resetArenaSelector(); $root.resetTranslations(); document.getElementById('new-term-input').focus(); }"
              class="space-y-1.5 mb-2">
            <div class="flex gap-2">
                <select name="term_type"
                        title="Keyword: matches anywhere in text; Phrase: matches exact multi-word phrase; Hashtag: matches #-prefixed tag; URL pattern: matches web addresses"
                        class="border border-gray-300 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex-shrink-0">
                    <option value="keyword">Keyword</option>
                    <option value="phrase">Phrase</option>
                    <option value="hashtag">Hashtag</option>
                    <option value="url_pattern">URL pattern</option>
                </select>
                <input type="text"
                       id="new-term-input"
                       name="term"
                       required
                       placeholder="Add search term..."
                       autocomplete="off"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="submit"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add
                </button>
            </div>
            {# Secondary row: optional group input (visually subordinate) #}
            <div class="flex items-center gap-2 pl-px">
                <label for="new-term-group"
                       class="text-xs text-gray-400 flex-shrink-0 w-28">
                    Group (optional)
                </label>
                <input type="text"
                       id="new-term-group"
                       name="group_label"
                       list="term-group-suggestions"
                       maxlength="200"
                       placeholder="e.g. Primary terms, English variants"
                       autocomplete="off"
                       class="flex-1 border border-gray-200 rounded px-2 py-1 text-xs text-gray-600 placeholder-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-transparent bg-gray-50">
            </div>
            {# YF-01: Arena scoping — collapsible, optional #}
            <div class="border-t border-gray-100 pt-2 space-y-1">
                <button type="button"
                        @click="arenaOpen = !arenaOpen"
                        class="flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-3 h-3 transition-transform"
                         :class="{'rotate-90': arenaOpen}"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span x-text="arenaSelectionSummary()"></span>
                </button>
                <div x-show="arenaOpen"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 -translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 translate-y-0"
                     x-transition:leave-end="opacity-0 -translate-y-1"
                     class="pl-4 space-y-1.5">
                    <p class="text-xs text-gray-400">
                        By default, this term applies to all arenas. Select specific arenas to limit where it is used.
                    </p>
                    <div class="grid grid-cols-2 gap-1.5 max-h-48 overflow-y-auto" x-show="availableArenas.length > 0">
                        <template x-for="arena in availableArenas" :key="arena.platform_name">
                            <label class="flex items-center gap-1.5 text-xs text-gray-700 cursor-pointer hover:bg-gray-50 rounded px-2 py-1">
                                <input type="checkbox"
                                       :value="arena.platform_name"
                                       x-model="selectedArenas"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-offset-0">
                                <span x-text="arena.platform_name"></span>
                            </label>
                        </template>
                    </div>
                    <div x-show="availableArenas.length === 0" class="text-xs text-gray-400 italic">
                        Loading arenas...
                    </div>
                    <button type="button"
                            @click="selectedArenas = []"
                            class="text-xs text-blue-600 hover:text-blue-700 underline"
                            x-show="selectedArenas.length > 0">
                        Clear selection (use all arenas)
                    </button>
                </div>
            </div>
            {# Hidden input that will be submitted to backend #}
            <input type="hidden" name="target_arenas" :value="$root.getArenaValue()">
            {# IP2-052: Translations section (shown only when multiple languages selected) #}
            <div x-show="translationLanguages().length > 0"
                 class="border-t border-gray-100 pt-2 space-y-1">
                <button type="button"
                        @click="translationsOpen = !translationsOpen"
                        class="flex items-center gap-1 text-xs text-gray-500 hover:text-gray-700 transition-colors">
                    <svg class="w-3 h-3 transition-transform"
                         :class="{'rotate-90': translationsOpen}"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                    </svg>
                    <span x-text="'Translations (' + translationLanguages().length + ' languages) — optional'"></span>
                </button>
                <div x-show="translationsOpen"
                     x-transition:enter="transition ease-out duration-200"
                     x-transition:enter-start="opacity-0 -translate-y-1"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     x-transition:leave="transition ease-in duration-150"
                     x-transition:leave-start="opacity-100 translate-y-0"
                     x-transition:leave-end="opacity-0 -translate-y-1"
                     class="pl-4 space-y-2">
                    <p class="text-xs text-gray-400">
                        Provide translated equivalents for this term in each selected language.
                    </p>
                    <template x-for="lang in translationLanguages()" :key="lang.code">
                        <div class="flex items-center gap-2">
                            <label :for="'translation-' + lang.code"
                                   class="text-xs text-gray-600 flex-shrink-0 w-20 font-medium"
                                   x-text="lang.label"></label>
                            <input type="text"
                                   :id="'translation-' + lang.code"
                                   :name="'translation_' + lang.code"
                                   x-model="translations[lang.code]"
                                   :placeholder="'Translation in ' + lang.label"
                                   autocomplete="off"
                                   class="flex-1 border border-gray-200 rounded px-2 py-1 text-xs text-gray-600 placeholder-gray-300 focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-transparent bg-gray-50">
                        </div>
                    </template>
                </div>
            </div>
            {# Hidden input for translations JSON #}
            <input type="hidden" name="translations" :value="getTranslationsJSON()">
        </form>

        {# Bulk import UI (shown when bulkMode is active) #}
        <div x-show="bulkMode"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 -translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             class="space-y-3 mb-4">

            {# Bulk textarea input #}
            <div class="space-y-2">
                <textarea x-model="bulkInput"
                          rows="8"
                          placeholder="Enter terms, one per line&#10;&#10;Simple format:&#10;ytringsfrihed&#10;free speech&#10;&#10;Structured format:&#10;ytringsfrihed | keyword | Danish terms | bluesky,reddit&#10;freedom of speech | phrase | English terms | youtube"
                          class="w-full border border-gray-300 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-y"
                          :disabled="importing"></textarea>

                {# Action buttons #}
                <div class="flex items-center gap-2">
                    <button type="button"
                            @click="importTerms()"
                            :disabled="!bulkInput.trim() || importing"
                            class="inline-flex items-center gap-1.5 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true" x-show="!importing">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        <svg class="w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" x-show="importing" x-cloak>
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span x-text="importing ? 'Importing...' : 'Import Terms'"></span>
                    </button>

                    <button type="button"
                            @click="bulkInput = ''; bulkError = null"
                            :disabled="!bulkInput.trim() || importing"
                            class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50">
                        Clear
                    </button>

                    <div class="flex-1"></div>

                    {# Status messages #}
                    <span x-show="bulkSuccess" x-cloak
                          x-transition:enter="transition ease-out duration-150"
                          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                          x-transition:leave="transition ease-in duration-300"
                          x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                          class="text-sm text-green-700 font-medium"
                          x-text="bulkSuccess"></span>
                    <span x-show="bulkError" x-cloak class="text-sm text-red-600" x-text="bulkError"></span>
                </div>
            </div>

            {# Format help text #}
            <div class="rounded-md bg-blue-50 border border-blue-100 px-3 py-2.5 text-xs text-blue-900 space-y-1.5">
                <p class="font-semibold">Two input formats supported:</p>
                <div class="pl-3 space-y-1">
                    <p><span class="font-medium">Simple:</span> One term per line (defaults to "keyword" type)</p>
                    <p><span class="font-medium">Structured:</span> <code class="bg-blue-100 px-1 rounded">term | type | group | arenas</code></p>
                </div>
                <p class="pt-1"><span class="font-medium">Example:</span></p>
                <div class="pl-3 font-mono text-xs bg-blue-100 rounded px-2 py-1.5 space-y-0.5">
                    <p>ytringsfrihed | keyword | Danish terms | bluesky,reddit</p>
                    <p>freedom of speech | phrase | English terms |</p>
                    <p>#freespeech | hashtag | | youtube</p>
                </div>
                <p class="pt-1 text-blue-700">Lines starting with <code class="bg-blue-100 px-1 rounded">#</code> are ignored as comments. Empty lines are skipped.</p>
            </div>
        </div>

        {# Term type help text (only shown in single-term mode) #}
        <div x-show="!bulkMode" class="mb-4 rounded-md bg-gray-50 border border-gray-100 px-3 py-2.5 text-xs text-gray-600 space-y-1">
            <p><span class="font-medium">Keyword</span> — Match any content containing this word.</p>
            <p><span class="font-medium">Phrase</span> — Match exact multi-word phrase (use for names, compound terms).</p>
            <p><span class="font-medium">Hashtag</span> — Match the specific hashtag across social platforms.</p>
            <p><span class="font-medium">URL pattern</span> — Match URLs containing this string (useful for tracking specific domains or articles).</p>
        </div>

        {#
            Terms list — HTMX appends new <li> rows via hx-swap="beforeend".
            Alpine's termGroupManager (on the parent div) injects group header
            <li> elements on init() and after every DOM mutation, so no
            group-header markup is emitted here.

            Terms are sorted so grouped ones appear first (stable sort by
            group_label, with None/empty last), which gives Alpine a
            predictable order to work with on initial page load.
        #}
        {% if terms %}
        <ul class="space-y-1.5" id="terms-list">
            {# Grouped terms first, ungrouped last #}
            {% for term in terms if term.group_label %}
                {% include '_fragments/term_row.html' %}
            {% endfor %}
            {% for term in terms if not term.group_label %}
                {% include '_fragments/term_row.html' %}
            {% endfor %}
        </ul>
        {% else %}
        <ul class="space-y-1.5" id="terms-list"></ul>
        <p class="text-sm text-gray-400 text-center py-6" id="terms-empty">
            No search terms yet. Add the first term above.
        </p>
        {% endif %}
    </div>

    {# SB-11: AI Chat Search as Discovery Accelerator #}
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6">
        <div class="flex items-start gap-4">
            {# Icon #}
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center">
                <svg class="w-5 h-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
            </div>

            {# Content #}
            <div class="flex-1">
                <h3 class="text-sm font-semibold text-purple-900 mb-1">AI-Powered Discovery</h3>
                <p class="text-sm text-purple-800 mb-3">
                    Use AI Chat Search to discover related terms, actors, and sources for your research.
                    This arena queries AI models to suggest connections you might have missed.
                </p>

                <details class="text-sm text-purple-700">
                    <summary class="cursor-pointer font-medium hover:text-purple-900 inline-flex items-center gap-1">
                        How to use AI Chat Search for discovery
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </summary>
                    <div class="mt-2 pl-5 space-y-2 text-xs text-purple-600 border-l-2 border-purple-300">
                        <p><strong>1. Enable AI Chat Search</strong> in the Arena Configuration section below (select MEDIUM tier).</p>
                        <p><strong>2. Run a collection</strong> with a broad query like "suggest 20 related terms for [your topic]".</p>
                        <p><strong>3. Review results</strong> in the Content Browser and add relevant suggestions back to your search terms list.</p>
                        <p><strong>4. Iterate:</strong> Use discovered terms to refine your query design and expand your research scope.</p>
                    </div>
                </details>

                <div class="mt-4 flex items-center gap-3">
                    <a href="#arena-config"
                       class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-xs font-medium rounded-md hover:bg-purple-700 transition-colors">
                        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        Enable AI Chat Search
                    </a>
                    <a href="https://docs.anthropic.com/claude/docs" target="_blank" rel="noopener"
                       class="text-xs text-purple-600 hover:text-purple-800 underline">
                        Learn more about AI-powered discovery
                    </a>
                </div>
            </div>
        </div>
    </div>

    {# Actor list panel #}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Actor List</h2>
                <p class="text-xs text-gray-400 mt-0.5">Specific accounts or people to track across arenas</p>
            </div>
            <span class="text-xs text-gray-400" id="actor-count">{{ actors | length }} actor{% if actors | length != 1 %}s{% endif %}</span>
        </div>

        {# Add actor form with bulk import toggle #}
        <div x-data="{ bulkMode: false }" class="mb-4">
            {# Toggle between single and bulk #}
            <div class="flex items-center gap-2 mb-3">
                <button type="button"
                        @click="bulkMode = false"
                        :class="!bulkMode ? 'bg-gray-200 text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-3 py-1.5 text-xs font-medium rounded transition-colors">
                    Single Add
                </button>
                <button type="button"
                        @click="bulkMode = true"
                        :class="bulkMode ? 'bg-gray-200 text-gray-900' : 'text-gray-500 hover:text-gray-700'"
                        class="px-3 py-1.5 text-xs font-medium rounded transition-colors">
                    Bulk Add
                </button>
            </div>

            {# Single actor form #}
            <form x-show="!bulkMode"
                  hx-post="/query-designs/{{ design_id }}/actors"
                  hx-target="#actors-list"
                  hx-swap="beforeend"
                  hx-on::after-request="if(event.detail.successful){ this.reset(); document.getElementById('new-actor-input').focus(); }"
                  class="flex gap-2">
                <select name="actor_type"
                        class="border border-gray-300 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex-shrink-0">
                    <option value="person">Person</option>
                    <option value="organization">Organization</option>
                    <option value="political_party">Political party</option>
                    <option value="educational_institution">Educational institution</option>
                    <option value="teachers_union">Teachers' union</option>
                    <option value="think_tank">Think tank</option>
                    <option value="media_outlet">Media outlet</option>
                    <option value="government_body">Government body</option>
                    <option value="ngo">NGO</option>
                    <option value="company">Company</option>
                    <option value="unknown">Unknown</option>
                </select>
                <input type="text"
                       id="new-actor-input"
                       name="name"
                       required
                       placeholder="Actor name or handle..."
                       autocomplete="off"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="submit"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add
                </button>
            </form>

            {# Bulk actor import panel #}
            <div x-show="bulkMode" x-data="bulkActorImport()" class="space-y-3">
                <div>
                    <textarea x-model="bulkInput"
                              id="bulk-actors-input"
                              rows="8"
                              placeholder="Enter actors, one per line. Supports two formats:&#10;&#10;Simple (defaults to person type):&#10;Lars Løkke Rasmussen&#10;Mette Frederiksen&#10;&#10;Structured (name | type):&#10;Lars Løkke Rasmussen | person&#10;Socialdemokratiet | political_party&#10;DR | media_outlet&#10;&#10;Empty lines and lines starting with # are ignored."
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono"></textarea>
                </div>

                {# Action buttons and status #}
                <div class="flex items-center gap-3">
                    <button type="button"
                            @click="bulkInput = ''; bulkError = null"
                            :disabled="!bulkInput.trim() || importing"
                            class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors disabled:opacity-50">
                        Clear
                    </button>

                    <button type="button"
                            @click="submitBulkActors()"
                            :disabled="!bulkInput.trim() || importing"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg x-show="importing" class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                             fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                        <span x-show="!importing">Import Actors</span>
                        <span x-show="importing">Importing...</span>
                    </button>

                    <div class="flex-1"></div>

                    {# Status messages #}
                    <span x-show="bulkSuccess" x-cloak
                          x-transition:enter="transition ease-out duration-150"
                          x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                          x-transition:leave="transition ease-in duration-300"
                          x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                          class="text-sm text-green-700 font-medium"
                          x-text="bulkSuccess"></span>
                    <span x-show="bulkError" x-cloak class="text-sm text-red-600" x-text="bulkError"></span>
                </div>
            </div>

            {# Format help text #}
            <div x-show="bulkMode" class="rounded-md bg-blue-50 border border-blue-100 px-3 py-2.5 text-xs text-blue-900 space-y-1.5">
                <p class="font-semibold">Two input formats supported:</p>
                <div class="pl-3 space-y-1">
                    <p><span class="font-medium">Simple:</span> One actor name per line (defaults to "person" type)</p>
                    <p><span class="font-medium">Structured:</span> <code class="bg-blue-100 px-1 rounded">name | type</code></p>
                </div>
                <p class="pt-1"><span class="font-medium">Valid types:</span> person, organization, political_party, educational_institution, teachers_union, think_tank, media_outlet, government_body, ngo, company, unknown</p>
                <p class="pt-1"><span class="font-medium">Example:</span></p>
                <div class="pl-3 font-mono text-xs bg-blue-100 rounded px-2 py-1.5 space-y-0.5">
                    <p>Lars Løkke Rasmussen | person</p>
                    <p>Socialdemokratiet | political_party</p>
                    <p>DR | media_outlet</p>
                    <p>Undervisningsministeriet | government_body</p>
                </div>
                <p class="pt-1 text-blue-700">Lines starting with <code class="bg-blue-100 px-1 rounded">#</code> are ignored as comments. Empty lines are skipped.</p>
            </div>
        </div>

        {# Actors list #}
        {% if actors %}
        <ul class="space-y-1.5" id="actors-list">
            {% for actor in actors %}
            <li id="actor-{{ actor.id }}"
                class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                <div class="flex items-center gap-2 min-w-0">
                    {# Type badge #}
                    {% set atype = actor.type | default('account') %}
                    {% if atype == 'person' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 flex-shrink-0">Person</span>
                    {% elif atype == 'organisation' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700 flex-shrink-0">Org</span>
                    {% elif atype == 'media_outlet' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700 flex-shrink-0">Media</span>
                    {% else %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 flex-shrink-0">Account</span>
                    {% endif %}
                    <span class="text-sm text-gray-900 font-medium truncate">{{ actor.name | default('') }}</span>
                    {% if actor.actor_id is defined %}
                    <a href="/actors/{{ actor.actor_id }}"
                       class="text-xs text-blue-500 hover:text-blue-700 flex-shrink-0"
                       title="View actor profile">Profile</a>
                    <span class="text-gray-300 flex-shrink-0">|</span>
                    {# YF-16: Inline expandable presence form #}
                    <button type="button"
                            onclick="document.getElementById('presence-form-{{ actor.id }}').style.display = document.getElementById('presence-form-{{ actor.id }}').style.display === 'none' ? 'block' : 'none'"
                            class="inline-flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 hover:underline flex-shrink-0"
                            title="Add platform presence inline">
                        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add presence
                    </button>
                    {% endif %}
                </div>
                <button type="button"
                        hx-delete="/query-designs/{{ design_id }}/actors/{{ actor.id }}"
                        hx-target="#actor-{{ actor.id }}"
                        hx-swap="outerHTML"
                        hx-confirm="Remove '{{ actor.name | default('') }}' from this actor list?"
                        class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50"
                        aria-label="Remove actor">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </li>
            {# YF-16: Inline presence form (hidden by default) #}
            {% if actor.actor_id is defined %}
            <li id="presence-form-{{ actor.id }}"
                style="display: none;"
                class="bg-blue-50 border border-blue-200 rounded-md p-3 ml-8 mt-1 mb-2">
                <form hx-post="/actors/{{ actor.actor_id }}/presences"
                      hx-on::after-request="if(event.detail.successful){ this.reset(); document.getElementById('presence-form-{{ actor.id }}').style.display = 'none'; }"
                      class="flex items-end gap-2">
                    <div class="flex-1 grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Platform</label>
                            <select name="platform" required
                                    class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white">
                                <option value="">Select...</option>
                                <option value="bluesky">Bluesky</option>
                                <option value="reddit">Reddit</option>
                                <option value="youtube">YouTube</option>
                                <option value="telegram">Telegram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="twitter">Twitter/X</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="gab">Gab</option>
                                <option value="linkedin">LinkedIn (manual import only)</option>
                                <option value="threads">Threads</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Username</label>
                            <input type="text" name="username" required
                                   placeholder="@handle or channel ID"
                                   class="w-full border border-gray-300 rounded px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit"
                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded hover:bg-blue-700 transition-colors flex-shrink-0">
                        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        Add
                    </button>
                    <button type="button"
                            onclick="document.getElementById('presence-form-{{ actor.id }}').style.display = 'none'"
                            class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1.5">
                        Cancel
                    </button>
                </form>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        {% else %}
        <ul class="space-y-1.5" id="actors-list"></ul>
        <p class="text-sm text-gray-400 text-center py-6">
            No actors in this list. Add specific accounts or people to track above.
        </p>
        {% endif %}
    </div>

    {#
        Arena configuration grid — Alpine-powered.
        The arena list is fetched dynamically from GET /api/arenas/ on init.
        Each row: arena name (with credential indicator + description), enabled toggle, tier selector.
        Tiers not in arena.supported_tiers are disabled and visually greyed out.
        Credit estimate fires via HTMX debounced 400ms on any change.
    #}
    <div class="bg-white rounded-lg shadow p-6"
         x-data="arenaConfigGrid('{{ design.default_tier | default('free') }}')">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Arena Configuration</h2>
                <p class="text-xs text-gray-400 mt-0.5">Enable arenas and choose a tier for each one</p>
            </div>
            {# Hidden HTMX trigger for estimate refresh #}
            <div id="arena-estimate-trigger"
                 hx-post="/collections/estimate"
                 hx-trigger="arena-estimate"
                 hx-target="#arena-credit-estimate"
                 hx-swap="innerHTML"
                 hx-include="#arena-config-form"
                 hx-indicator="#estimate-spinner"
                 style="display:none">
            </div>
            <div class="flex items-center gap-2">
                <span id="estimate-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5 text-blue-600" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
                <button type="button"
                        @click="enableAll()"
                        class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                    Enable all
                </button>
                <button type="button"
                        @click="disableAll()"
                        class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100 transition-colors">
                    Disable all
                </button>
            </div>
        </div>

        {# Hidden form fields that HTMX sends to the estimate endpoint #}
        <form id="arena-config-form" style="display:none">
            <input type="hidden" name="design_id" value="{{ design_id }}">
            <template x-for="arena in arenas" :key="arena.id">
                <div>
                    <input type="hidden" :name="'arena[' + arena.id + '][enabled]'" :value="arena.enabled ? '1' : '0'">
                    <input type="hidden" :name="'arena[' + arena.id + '][tier]'" :value="arena.tier">
                </div>
            </template>
        </form>

        {# Loading state while fetching arena list from API #}
        <div x-show="arenas.length === 0 && !_loadError"
             class="py-6 text-center text-sm text-gray-400 animate-pulse">
            Loading arenas...
        </div>

        {# Error state if arena fetch failed #}
        <div x-show="_loadError"
             class="py-4 px-3 rounded-md bg-red-50 border border-red-200 text-sm text-red-700"
             x-text="_loadError">
        </div>

        <table x-show="arenas.length > 0" class="min-w-full text-sm">
            <thead>
                <tr class="text-left">
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider w-52">Arena</th>
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Enabled</th>
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider">Tier</th>
                    <th class="pb-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Est. Credits</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <template x-for="arena in arenas" :key="arena.id">
                    <tr :class="arena.enabled ? '' : 'opacity-50'">
                        {#
                            Arena name cell.
                            - Credential status dot: green if has_credentials=true, gray otherwise.
                            - Description shown as a single muted line below the arena name.
                            - The title attribute on the row provides a hover tooltip with the description.
                        #}
                        <td class="py-3 pr-4">
                            <div class="flex items-start gap-2">
                                {# Credential status indicator #}
                                <span class="mt-1 flex-shrink-0 w-2 h-2 rounded-full"
                                      :class="arena.hasCredentials ? 'bg-green-500' : 'bg-gray-300'"
                                      :title="arena.hasCredentials
                                          ? 'Credentials configured'
                                          : 'Credentials not configured — this arena will be skipped during collection'">
                                </span>
                                <div class="min-w-0 flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm font-medium text-gray-800"
                                              x-text="arena.label"></span>
                                        {# YF-02: Configuration badge for source-list arenas #}
                                        <span x-show="arena.customConfigFields && arena.customConfigFields.length > 0"
                                              class="inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700"
                                              :title="'Requires configuration (' + (arena.customConfigFields ? arena.customConfigFields.length : 0) + ' field' + (arena.customConfigFields && arena.customConfigFields.length !== 1 ? 's' : '') + ')'">
                                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            </svg>
                                            Config
                                        </span>
                                        {# YF-14: Google arenas require MEDIUM+ tier #}
                                        <span x-show="arena.id === 'google_search' || arena.id === 'google_autocomplete'"
                                              class="inline-flex items-center gap-0.5 px-1.5 py-0.5 rounded text-xs font-medium bg-amber-50 text-amber-600 border border-amber-200"
                                              title="Google arenas require MEDIUM or PREMIUM tier API keys (no FREE tier support)">
                                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Requires MEDIUM+ tier
                                        </span>
                                    </div>
                                    {# Compact description line (IP2-003) #}
                                    <span x-show="arena.description"
                                          class="block text-xs text-gray-400 truncate max-w-xs"
                                          :title="arena.description"
                                          x-text="arena.description"></span>
                                    <span class="block text-xs text-gray-300 font-mono" x-text="arena.id"></span>
                                </div>
                            </div>
                        </td>

                        {# Enable/disable toggle #}
                        <td class="py-3 pr-4">
                            <button type="button"
                                    @click="toggleArena(arena); scheduleEstimate()"
                                    :class="arena.enabled
                                        ? 'bg-blue-600'
                                        : 'bg-gray-200'"
                                    class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                                    :aria-pressed="arena.enabled.toString()"
                                    :aria-label="'Toggle ' + arena.label">
                                <span :class="arena.enabled ? 'translate-x-5' : 'translate-x-1'"
                                      class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </td>

                        {#
                            Tier radio buttons (IP2-002).
                            Tiers not in arena.supportedTiers are disabled and visually greyed out.
                            A title tooltip explains why a tier is unavailable.
                            The pointer-events-none class is applied when the arena is disabled.
                        #}
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-3" :class="arena.enabled ? '' : 'pointer-events-none'">
                                <template x-for="t in ['free', 'medium', 'premium']" :key="t">
                                    <label class="flex items-center gap-1"
                                           :class="arena.supportedTiers.includes(t) ? 'cursor-pointer' : 'cursor-not-allowed opacity-40'"
                                           :title="arena.supportedTiers.includes(t) ? '' : unsupportedTierTitle(arena)">
                                        <input type="radio"
                                               :name="'tier_' + arena.id"
                                               :value="t"
                                               x-model="arena.tier"
                                               @change="scheduleEstimate()"
                                               :disabled="!arena.enabled || !arena.supportedTiers.includes(t)"
                                               class="text-blue-600 focus:ring-blue-500">
                                        <span class="text-xs capitalize"
                                              :class="{
                                                'text-green-700':  t === 'free',
                                                'text-yellow-700': t === 'medium',
                                                'text-purple-700': t === 'premium'
                                              }"
                                              x-text="t"></span>
                                    </label>
                                </template>
                            </div>
                        </td>

                        {# Estimated credits (per-arena placeholder; aggregate shown below) #}
                        <td class="py-3 text-right">
                            <span class="text-xs font-mono text-gray-400"
                                  x-show="!arena.enabled">—</span>
                            <span class="text-xs font-mono text-gray-600"
                                  x-show="arena.enabled"
                                  :class="arena.tier === 'premium' ? 'text-purple-700' : arena.tier === 'medium' ? 'text-yellow-700' : 'text-green-700'">
                                <span x-text="arena.estimatedCredits !== null ? arena.estimatedCredits : '…'"></span>
                            </span>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        {# Credit estimate summary — HTMX-populated #}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div id="arena-credit-estimate" class="text-sm text-gray-500">
                <span class="text-xs text-gray-400">Change arena settings to see a credit estimate.</span>
            </div>
        </div>

        {# Save arena config button with success feedback #}
        <div class="mt-4 flex items-center justify-end gap-3"
             x-data="{ saved: false, saveError: false }">
            <span x-show="saved"
                  x-cloak
                  x-transition:enter="transition ease-out duration-150"
                  x-transition:enter-start="opacity-0"
                  x-transition:enter-end="opacity-100"
                  x-transition:leave="transition ease-in duration-300"
                  x-transition:leave-start="opacity-100"
                  x-transition:leave-end="opacity-0"
                  class="text-sm text-green-700 font-medium">
                Saved
            </span>
            <span x-show="saveError"
                  x-cloak
                  class="text-sm text-red-600">
                Save failed — please try again.
            </span>
            <button type="button"
                    hx-post="/query-designs/{{ design_id }}/arena-config"
                    hx-include="#arena-config-form"
                    hx-swap="none"
                    hx-indicator="#save-arena-spinner"
                    hx-on::after-settle="if(event.detail.successful){ saved = true; saveError = false; setTimeout(() => { saved = false; }, 3000); } else { saveError = true; saved = false; }"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-md hover:bg-gray-700 transition-colors">
                <span id="save-arena-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
                Save Arena Config
            </button>
        </div>

        {# YF-02: Info box about source-list arenas #}
        <div class="mt-4 rounded-md bg-blue-50 border border-blue-200 p-3">
            <div class="flex gap-2">
                <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div class="text-sm text-blue-800">
                    <p class="font-medium mb-1">Source-list arenas require additional configuration</p>
                    <p class="text-xs text-blue-700">
                        Arenas marked with <span class="inline-flex items-center gap-0.5 px-1 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-700 mx-1">
                            <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            Config
                        </span> need you to specify which sources to monitor. Configure them in the panels below (Telegram, Reddit, RSS, Discord, Wikipedia).
                    </p>
                </div>
            </div>
        </div>
    </div>

    {#
        GR-01 through GR-05 / YF-02 — Per-arena custom source panels + multi-language selector.

        These panels are only rendered in edit mode (design_id is required for
        PATCH /query-designs/{design_id}/arena-config/{arena_name} calls).

        Each panel:
          - Is collapsed by default; expands on "Configure" click.
          - Uses Alpine.js for show/hide and local list state.
          - Uses HTMX PATCH to persist changes (routes added by Core Engineer).
          - Sends JSON via hx-vals (Alpine-serialised) or a hidden form field.
          - Shows only when the relevant arena is enabled in arenaConfigGrid.

        Arena enabled detection: each panel reads window.__arenaEnabled(name)
        which is populated by the arenaConfigGrid Alpine component via a tiny
        bridge set during init().  If the function is unavailable the panel is
        shown unconditionally so researchers can still configure it even before
        the grid loads.
    #}

    {# ------------------------------------------------------------------ #}
    {# GR-05 — Multi-language selector                                    #}
    {# ------------------------------------------------------------------ #}
    <div class="bg-white rounded-lg shadow p-6"
         x-data="languageSelector('{{ design_id }}', {{ (design.arenas_config.global.languages | default(['da'])) | tojson }})">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Languages</h2>
                <p class="text-xs text-gray-400 mt-0.5">
                    Select all languages arenas should search in
                </p>
            </div>
            <div class="flex items-center gap-2">
                {# Live summary of selected languages #}
                <span class="text-xs text-gray-500 font-mono"
                      x-text="selected.join(', ') || 'none'"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Arenas that support language filtering (Google Search, Reddit, RSS, Wikipedia) will restrict
                their queries to the selected languages. Danish (da) is the recommended default.
            </p>

            <div class="flex flex-wrap gap-2 mb-4">
                <template x-for="lang in availableLanguages" :key="lang.code">
                    <button type="button"
                            @click="toggleLanguage(lang.code)"
                            :class="selected.includes(lang.code)
                                ? 'bg-blue-600 text-white border-blue-600'
                                : 'bg-white text-gray-700 border-gray-300 hover:border-blue-400 hover:text-blue-600'"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium border rounded-full transition-colors">
                        <span x-text="lang.label"></span>
                        <span class="font-mono opacity-70" x-text="'(' + lang.code + ')'"></span>
                    </button>
                </template>
            </div>

            <div class="flex items-center gap-3">
                <button type="button"
                        @click="save()"
                        :disabled="saving"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50">
                    <svg x-show="saving" class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    Save Languages
                </button>
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>
        </div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# GR-01 — RSS: custom feeds panel                                    #}
    {# ------------------------------------------------------------------ #}
    <div id="config-rss_feeds" class="bg-white rounded-lg shadow p-6"
         x-data="arenaSourcePanel(
             '{{ design_id }}',
             'rss',
             'custom_feeds',
             {{ (design.arenas_config.rss.custom_feeds | default([])) | tojson }}
         )">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-900">RSS — Custom Feeds</h2>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                          title="Source-list arena requiring configuration">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Requires setup
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">Additional RSS/Atom feeds beyond the 30+ Danish defaults</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="items.length > 0"
                      class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"
                      x-text="items.length + ' custom'"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Add news feeds beyond the 30+ Danish defaults — e.g., <code class="bg-gray-100 px-1 rounded">https://sermitsiaq.ag/rss</code>,
                <code class="bg-gray-100 px-1 rounded">https://knr.gl/da/rss.xml</code>.
                Paste the full feed URL including <code class="bg-gray-100 px-1 rounded">https://</code>.
            </p>

            {# Add input row #}
            <div class="flex gap-2 mb-4">
                <input type="url"
                       x-model="newItem"
                       @keydown.enter.prevent="addItem()"
                       placeholder="https://example.com/feed.xml"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="button"
                        @click="addItem()"
                        :disabled="!newItem.trim() || saving"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors disabled:opacity-50 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Feed
                </button>
            </div>

            {# Items list #}
            <ul class="space-y-1.5 mb-3" x-show="items.length > 0">
                <template x-for="(item, idx) in items" :key="idx">
                    <li class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                        <span class="text-sm text-gray-800 font-mono truncate" x-text="item"></span>
                        <button type="button"
                                @click="removeItem(idx)"
                                :disabled="saving"
                                class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 disabled:opacity-30"
                                aria-label="Remove feed">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </li>
                </template>
            </ul>
            <p x-show="items.length === 0" class="text-sm text-gray-400 text-center py-3">
                No custom feeds added. The default Danish RSS feed list will be used.
            </p>

            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>

            {# YF-12: RSS feed list preview #}
            <div class="mt-4 pt-4 border-t border-gray-100">
                <div x-data="rssFeedViewer()" x-init="loadFeeds()">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-semibold text-gray-700">Default Danish RSS Feeds</h3>
                        <span x-show="feeds.length > 0"
                              class="text-xs text-gray-400"
                              x-text="filteredFeeds.length + ' of ' + feeds.length + ' feeds'"></span>
                    </div>

                    {# Search input #}
                    <div class="mb-2">
                        <div class="relative">
                            <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400 pointer-events-none"
                                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0"/>
                            </svg>
                            <input type="text"
                                   x-model="searchQuery"
                                   placeholder="Search feeds by outlet name or URL..."
                                   class="w-full pl-7 pr-3 py-1.5 text-xs border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-400 focus:border-transparent">
                        </div>
                    </div>

                    {# Feed list #}
                    <div x-show="loading" class="text-xs text-gray-400 italic py-3 text-center">
                        Loading feeds...
                    </div>
                    <div x-show="!loading && feeds.length === 0" class="text-xs text-gray-400 italic py-3 text-center">
                        No feeds available
                    </div>
                    <div x-show="!loading && feeds.length > 0" class="max-h-64 overflow-y-auto border border-gray-200 rounded">
                        <table class="min-w-full text-xs">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="text-left px-2 py-1.5 text-xs font-medium text-gray-500">Outlet</th>
                                    <th class="text-left px-2 py-1.5 text-xs font-medium text-gray-500">Feed URL</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-100">
                                <template x-for="feed in filteredFeeds" :key="feed.key">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-2 py-1.5 text-gray-700 font-medium whitespace-nowrap" x-text="feed.name"></td>
                                        <td class="px-2 py-1.5">
                                            <a :href="feed.url" target="_blank" rel="noopener noreferrer"
                                               class="text-blue-600 hover:text-blue-800 hover:underline font-mono text-xs truncate block max-w-xs"
                                               :title="feed.url"
                                               x-text="feed.url">
                                            </a>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    <div x-show="!loading && feeds.length > 0 && filteredFeeds.length === 0" class="text-xs text-gray-400 italic py-3 text-center border border-gray-200 rounded">
                        No feeds match your search
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# GR-02 — Telegram: custom channels panel                            #}
    {# ------------------------------------------------------------------ #}
    <div id="config-telegram" class="bg-white rounded-lg shadow p-6"
         x-data="arenaSourcePanel(
             '{{ design_id }}',
             'telegram',
             'custom_channels',
             {{ (design.arenas_config.telegram.custom_channels | default([])) | tojson }}
         )">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-900">Telegram — Custom Channels</h2>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                          title="Source-list arena requiring configuration">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Requires setup
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">Additional public channels to monitor beyond default Danish channels</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="items.length > 0"
                      class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"
                      x-text="items.length + ' custom'"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Enter the public channel username without the <code class="bg-gray-100 px-1 rounded">@</code> prefix —
                e.g., <code class="bg-gray-100 px-1 rounded">gronlandnyt</code>,
                <code class="bg-gray-100 px-1 rounded">naalakkersuisut</code>.
                The channel must be public and accessible without an invite link.
            </p>

            <div class="flex gap-2 mb-4">
                <input type="text"
                       x-model="newItem"
                       @keydown.enter.prevent="addItem()"
                       placeholder="channel_username"
                       autocomplete="off"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="button"
                        @click="addItem()"
                        :disabled="!newItem.trim() || saving"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors disabled:opacity-50 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Channel
                </button>
            </div>

            <ul class="space-y-1.5 mb-3" x-show="items.length > 0">
                <template x-for="(item, idx) in items" :key="idx">
                    <li class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                        <span class="text-sm text-gray-800 font-mono truncate"
                              x-text="'@' + item"></span>
                        <button type="button"
                                @click="removeItem(idx)"
                                :disabled="saving"
                                class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 disabled:opacity-30"
                                aria-label="Remove channel">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </li>
                </template>
            </ul>
            <p x-show="items.length === 0" class="text-sm text-gray-400 text-center py-3">
                No custom channels added. Only channels discovered via keyword search will be monitored.
            </p>

            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>
        </div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# GR-03 — Reddit: custom subreddits panel                            #}
    {# ------------------------------------------------------------------ #}
    <div id="config-reddit" class="bg-white rounded-lg shadow p-6"
         x-data="arenaSourcePanel(
             '{{ design_id }}',
             'reddit',
             'custom_subreddits',
             {{ (design.arenas_config.reddit.custom_subreddits | default([])) | tojson }}
         )">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-900">Reddit — Custom Subreddits</h2>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                          title="Source-list arena requiring configuration">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Requires setup
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">Additional subreddits beyond r/Denmark, r/danish, r/copenhagen, r/aarhus, r/dkpolitik</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="items.length > 0"
                      class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"
                      x-text="items.length + ' custom'"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Enter the subreddit name without the <code class="bg-gray-100 px-1 rounded">r/</code> prefix —
                e.g., <code class="bg-gray-100 px-1 rounded">Greenland</code>,
                <code class="bg-gray-100 px-1 rounded">Denmark</code>,
                <code class="bg-gray-100 px-1 rounded">scandinavia</code>.
                All posts matching your search terms will be collected from these subreddits.
            </p>

            <div class="flex gap-2 mb-4">
                <div class="flex items-center border border-gray-300 rounded overflow-hidden flex-1 focus-within:ring-2 focus-within:ring-blue-500">
                    <span class="px-2 text-sm text-gray-400 bg-gray-50 border-r border-gray-300 select-none">r/</span>
                    <input type="text"
                           x-model="newItem"
                           @keydown.enter.prevent="addItem()"
                           placeholder="subreddit_name"
                           autocomplete="off"
                           class="flex-1 px-3 py-2 text-sm focus:outline-none bg-white">
                </div>
                <button type="button"
                        @click="addItem()"
                        :disabled="!newItem.trim() || saving"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors disabled:opacity-50 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Subreddit
                </button>
            </div>

            <ul class="space-y-1.5 mb-3" x-show="items.length > 0">
                <template x-for="(item, idx) in items" :key="idx">
                    <li class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                        <span class="text-sm text-gray-800 font-mono truncate"
                              x-text="'r/' + item"></span>
                        <button type="button"
                                @click="removeItem(idx)"
                                :disabled="saving"
                                class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 disabled:opacity-30"
                                aria-label="Remove subreddit">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </li>
                </template>
            </ul>
            <p x-show="items.length === 0" class="text-sm text-gray-400 text-center py-3">
                No custom subreddits added. Only keyword search results will be collected.
            </p>

            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>
        </div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# GR-04a — Discord: custom channel IDs panel                         #}
    {# ------------------------------------------------------------------ #}
    <div id="config-discord" class="bg-white rounded-lg shadow p-6"
         x-data="arenaSourcePanel(
             '{{ design_id }}',
             'discord',
             'custom_channel_ids',
             {{ (design.arenas_config.discord.custom_channel_ids | default([])) | tojson }}
         )">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-900">Discord — Custom Channel IDs</h2>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                          title="Source-list arena requiring configuration">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Requires setup
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">Specific Discord channels to monitor (requires Bot Token credentials)</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="items.length > 0"
                      class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"
                      x-text="items.length + ' channel' + (items.length === 1 ? '' : 's')"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Enter the Discord channel snowflake ID (a long numeric string) — e.g.,
                <code class="bg-gray-100 px-1 rounded">1234567890123456789</code>.
                Enable Developer Mode in Discord (User Settings &rarr; Advanced) then right-click any
                channel and choose "Copy Channel ID". The bot must already be a member of the server.
            </p>

            <div class="flex gap-2 mb-4">
                <input type="text"
                       x-model="newItem"
                       @keydown.enter.prevent="addItem()"
                       placeholder="1234567890123456789"
                       inputmode="numeric"
                       pattern="[0-9]*"
                       autocomplete="off"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="button"
                        @click="addItem()"
                        :disabled="!newItem.trim() || saving"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors disabled:opacity-50 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Channel
                </button>
            </div>

            <ul class="space-y-1.5 mb-3" x-show="items.length > 0">
                <template x-for="(item, idx) in items" :key="idx">
                    <li class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                        <span class="text-sm text-gray-800 font-mono truncate" x-text="item"></span>
                        <button type="button"
                                @click="removeItem(idx)"
                                :disabled="saving"
                                class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 disabled:opacity-30"
                                aria-label="Remove channel ID">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </li>
                </template>
            </ul>
            <p x-show="items.length === 0" class="text-sm text-gray-400 text-center py-3">
                No channel IDs added. Add at least one channel ID for the Discord arena to collect data.
            </p>

            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>
        </div>
    </div>

    {# ------------------------------------------------------------------ #}
    {# GR-04b — Wikipedia: custom seed articles panel                     #}
    {# ------------------------------------------------------------------ #}
    <div id="config-wikipedia" class="bg-white rounded-lg shadow p-6"
         x-data="arenaSourcePanel(
             '{{ design_id }}',
             'wikipedia',
             'seed_articles',
             {{ (design.arenas_config.wikipedia.seed_articles | default([])) | tojson }}
         )">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4 cursor-pointer"
             @click="open = !open">
            <div class="flex-1">
                <div class="flex items-center gap-2">
                    <h2 class="text-sm font-semibold text-gray-900">Wikipedia — Seed Articles</h2>
                    <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600"
                          title="Source-list arena requiring configuration">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Requires setup
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-0.5">Wikipedia articles to monitor for editorial attention signals</p>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="items.length > 0"
                      class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700"
                      x-text="items.length + ' article' + (items.length === 1 ? '' : 's')"></span>
                <svg class="w-4 h-4 text-gray-400 transition-transform"
                     :class="open ? 'rotate-180' : ''"
                     xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        <div x-show="open"
             x-transition:enter="transition ease-out duration-150"
             x-transition:enter-start="opacity-0 -translate-y-1"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100 translate-y-0"
             x-transition:leave-end="opacity-0 -translate-y-1">
            <p class="text-xs text-gray-500 mb-3">
                Enter the Wikipedia article title exactly as it appears in the URL — e.g.,
                <code class="bg-gray-100 px-1 rounded">Gronland</code> (Danish),
                <code class="bg-gray-100 px-1 rounded">Greenland</code> (English),
                <code class="bg-gray-100 px-1 rounded">Kalaallit_Nunaat</code> (Greenlandic).
                The arena will fetch article text and follow internal links for context mapping.
            </p>

            <div class="flex gap-2 mb-4">
                <input type="text"
                       x-model="newItem"
                       @keydown.enter.prevent="addItem()"
                       placeholder="Article_Title"
                       autocomplete="off"
                       class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button type="button"
                        @click="addItem()"
                        :disabled="!newItem.trim() || saving"
                        class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors disabled:opacity-50 flex-shrink-0">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                    Add Article
                </button>
            </div>

            <ul class="space-y-1.5 mb-3" x-show="items.length > 0">
                <template x-for="(item, idx) in items" :key="idx">
                    <li class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                        <a :href="'https://en.wikipedia.org/wiki/' + encodeURIComponent(item)"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-sm text-blue-600 hover:text-blue-800 font-mono truncate"
                           x-text="item"></a>
                        <button type="button"
                                @click="removeItem(idx)"
                                :disabled="saving"
                                class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50 disabled:opacity-30"
                                aria-label="Remove article">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </li>
                </template>
            </ul>
            <p x-show="items.length === 0" class="text-sm text-gray-400 text-center py-3">
                No seed articles added. The Wikipedia arena will use your search terms as article titles.
            </p>

            <div class="flex items-center gap-3 pt-2 border-t border-gray-100">
                <span x-show="savedOk" x-cloak
                      x-transition:enter="transition ease-out duration-150"
                      x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                      x-transition:leave="transition ease-in duration-300"
                      x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
                      class="text-sm text-green-700 font-medium">Saved</span>
                <span x-show="saveError" x-cloak class="text-sm text-red-600" x-text="saveError"></span>
            </div>
        </div>
    </div>

    {% endif %}{# /is_edit #}

</div>

<script>
/**
 * Alpine component for the arena configuration grid.
 *
 * On init(), fetches the live arena list from GET /api/arenas/ to populate
 * the grid dynamically. Each arena entry from the API includes:
 *   - arena_name (string): unique arena identifier
 *   - platform_name (string): underlying platform
 *   - supported_tiers (string[]): which tiers this arena supports
 *   - description (string): human-readable description
 *   - has_credentials (boolean): whether API credentials are configured
 *
 * After fetching the arena list, the saved per-design config is loaded from
 * GET /api/query-designs/{id}/arena-config and merged in. If a saved tier
 * is no longer in supported_tiers, it is auto-corrected to the first
 * supported tier.
 *
 * API contracts:
 *   GET  /api/arenas/                        → ArenaInfo[]
 *   GET  /api/query-designs/{id}/arena-config → { arenas: [{id, enabled, tier}] }
 *   POST /api/query-designs/{id}/arena-config → 200
 */
function arenaConfigGrid(defaultTier) {
    return {
        arenas: [],
        _estimateTimer: null,
        _loadError: null,

        async init() {
            // Step 1: Fetch the live arena list from the backend.
            let fetchedArenas = [];
            try {
                const resp = await fetch('/api/arenas/');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                // Normalise to a consistent internal shape.
                fetchedArenas = data.map(a => ({
                    // Use arena_name as the stable identifier (matches saved config id).
                    id: a.arena_name,
                    label: _arenaLabel(a.arena_name),
                    platform: a.platform_name,
                    description: a.description || '',
                    hasCredentials: a.has_credentials === true,
                    supportedTiers: Array.isArray(a.supported_tiers) && a.supported_tiers.length > 0
                        ? a.supported_tiers
                        : ['free'],
                    enabled: false,
                    // Default tier: use the design default if it is supported, else the first supported tier.
                    tier: defaultTier || 'free',
                    estimatedCredits: null,
                    // YF-02: Include custom configuration field metadata.
                    customConfigFields: a.custom_config_fields || null,
                }));
                // Correct initial tier if the design default is not supported by this arena.
                fetchedArenas.forEach(a => {
                    if (!a.supportedTiers.includes(a.tier)) {
                        a.tier = a.supportedTiers[0];
                    }
                });
            } catch (err) {
                this._loadError = 'Could not load arena list: ' + err.message;
                return;
            }

            this.arenas = fetchedArenas;

            // Step 2: Load existing per-design arena config and merge it in.
            const designId = document.querySelector('input[name="design_id"]')?.value;
            if (designId) {
                try {
                    const configResp = await fetch('/api/query-designs/' + designId + '/arena-config');
                    if (configResp.ok) {
                        const configData = await configResp.json();
                        if (configData && Array.isArray(configData.arenas)) {
                            configData.arenas.forEach(saved => {
                                const arena = this.arenas.find(a => a.id === saved.id);
                                if (arena) {
                                    arena.enabled = saved.enabled;
                                    // Auto-correct saved tier if it is no longer supported.
                                    if (arena.supportedTiers.includes(saved.tier)) {
                                        arena.tier = saved.tier;
                                    } else {
                                        arena.tier = arena.supportedTiers[0];
                                    }
                                }
                            });
                        }
                    }
                } catch (_) {
                    // Silently ignore — saved config not available, defaults apply.
                }
            }

            // Step 3: Listen for estimate results from the credit_estimate fragment.
            document.addEventListener('estimate:result', (evt) => {
                this.applyEstimateResult(evt.detail);
            });
        },

        toggleArena(arena) {
            arena.enabled = !arena.enabled;
        },

        enableAll() {
            this.arenas.forEach(a => { a.enabled = true; });
            this.scheduleEstimate();
        },

        disableAll() {
            this.arenas.forEach(a => { a.enabled = false; });
            this.scheduleEstimate();
        },

        scheduleEstimate() {
            clearTimeout(this._estimateTimer);
            this._estimateTimer = setTimeout(() => {
                const trigger = document.getElementById('arena-estimate-trigger');
                if (trigger) htmx.trigger(trigger, 'arena-estimate');
            }, 400);
        },

        applyEstimateResult(detail) {
            // The estimate fragment may provide per-arena breakdown in detail.arenas.
            if (detail.arenas) {
                detail.arenas.forEach(est => {
                    const arena = this.arenas.find(a => a.id === est.id);
                    if (arena) arena.estimatedCredits = est.credits;
                });
            }
        },

        /**
         * Compute the tooltip text for a disabled tier radio button.
         * Returns a string like "This arena only supports free tier(s)".
         */
        unsupportedTierTitle(arena) {
            return 'This arena only supports ' + arena.supportedTiers.join(', ') + ' tier(s)';
        },
    };
}

/**
 * Convert a snake_case arena_name to a human-readable label.
 * Falls back gracefully for unknown arenas.
 */
function _arenaLabel(arenaName) {
    const labels = {
        'google_search':       'Google Search',
        'google_autocomplete': 'Google Autocomplete',
        'bluesky':             'Bluesky',
        'reddit':              'Reddit',
        'youtube':             'YouTube',
        'rss_feeds':           'RSS Feeds',
        'gdelt':               'GDELT',
        'telegram':            'Telegram',
        'tiktok':              'TikTok',
        'ritzau_via':          'Ritzau Infostream',
        'gab':                 'Gab',
    };
    return labels[arenaName] || arenaName.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

/**
 * Alpine component for the query design editor.
 * Term add/remove is handled by HTMX; this component provides local state.
 */
Alpine.data('queryEditor', () => ({
    init() {
        const input = document.getElementById('new-term-input');
        if (input) {
            setTimeout(() => input.focus(), 100);
        }
    },
}));

/**
 * Alpine component that manages visual group headers in the terms list.
 *
 * Terms are stored as <li data-group="Group name"> rows appended by HTMX.
 * This component observes DOM mutations on #terms-list and re-renders the
 * group header <li> elements so the visual grouping stays consistent after
 * every add/remove.
 *
 * Group rename works client-side only — it updates the data-group attributes
 * and re-renders headers.  A future endpoint (PATCH /terms/{id}/group) could
 * persist the rename.
 */
function termGroupManager() {
    return {
        _observer: null,

        init() {
            this._rebuildHeaders();
            this._updateDatalist();

            // Watch for DOM changes caused by HTMX appends/removes.
            const list = document.getElementById('terms-list');
            if (list) {
                this._observer = new MutationObserver(() => {
                    this._rebuildHeaders();
                    this._updateDatalist();
                });
                this._observer.observe(list, { childList: true, subtree: false });
            }
        },

        destroy() {
            if (this._observer) this._observer.disconnect();
        },

        /**
         * Re-render group header <li> elements before the first term in each
         * group.  Existing header elements are removed and re-inserted to
         * handle reordering and additions.
         */
        _rebuildHeaders() {
            const list = document.getElementById('terms-list');
            if (!list) return;

            // Remove all existing group header <li> nodes.
            list.querySelectorAll('.term-group-header').forEach(el => el.remove());

            // Walk the current term rows and inject a header before the first
            // row of each group transition.
            let lastGroup = null;
            const rows = list.querySelectorAll('li[id^="term-"]');
            rows.forEach(row => {
                const group = row.dataset.group || null;
                if (group && group !== lastGroup) {
                    const header = this._makeGroupHeader(group);
                    list.insertBefore(header, row);
                }
                lastGroup = group;
            });
        },

        /**
         * Create a group header <li> element for the given group label.
         *
         * @param {string} label - The group display name.
         * @returns {HTMLLIElement}
         */
        _makeGroupHeader(label) {
            const li = document.createElement('li');
            li.className = 'term-group-header pt-3';
            li.dataset.groupHeader = label;

            // Wrapper div with label + divider line.
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-1.5';

            const span = document.createElement('span');
            span.className = 'text-xs font-semibold text-gray-500 uppercase tracking-wide cursor-pointer hover:text-gray-700';
            span.title = 'Click to rename group';
            span.textContent = label;

            // Clicking the label opens an inline rename input.
            span.addEventListener('click', () => this._startRename(li, label, span));

            const line = document.createElement('span');
            line.className = 'flex-1 border-b border-gray-100';

            wrapper.appendChild(span);
            wrapper.appendChild(line);
            li.appendChild(wrapper);
            return li;
        },

        /**
         * Replace the group label span with a text input for inline renaming.
         *
         * @param {HTMLLIElement} headerLi - The group header element.
         * @param {string} oldLabel        - Current group label.
         * @param {HTMLSpanElement} span   - The label span to replace.
         */
        _startRename(headerLi, oldLabel, span) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldLabel;
            input.className = 'text-xs font-semibold text-gray-600 border border-blue-300 rounded px-1 py-0.5 focus:outline-none focus:ring-1 focus:ring-blue-400 w-44';

            const commit = () => {
                const newLabel = input.value.trim();
                if (newLabel && newLabel !== oldLabel) {
                    this.renameGroup(oldLabel, newLabel);
                }
                // _rebuildHeaders will replace the input with a fresh header.
                this._rebuildHeaders();
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); commit(); }
                if (e.key === 'Escape') { this._rebuildHeaders(); }
            });
            input.addEventListener('blur', commit);

            span.replaceWith(input);
            input.focus();
            input.select();
        },

        /**
         * Rename all term rows that carry oldLabel as their data-group value.
         * This is a client-side-only operation — the server-side group_label is
         * not updated here.  A future PATCH endpoint would persist this change.
         *
         * @param {string} oldLabel
         * @param {string} newLabel
         */
        renameGroup(oldLabel, newLabel) {
            if (!newLabel || newLabel === oldLabel) return;
            const list = document.getElementById('terms-list');
            if (!list) return;
            // Use direct DOM iteration instead of a CSS attribute selector so
            // that group label values with quotes or special chars are safe.
            list.querySelectorAll('li[data-group]').forEach(row => {
                if (row.dataset.group === oldLabel) {
                    row.dataset.group = newLabel;
                }
            });
            this._rebuildHeaders();
            this._updateDatalist();
        },

        /**
         * YF-10: Update the datalist with existing group labels from the current
         * query design's terms.
         *
         * Scans all term rows for data-group attributes and adds them to the
         * #term-group-suggestions datalist alongside the predefined options.
         */
        _updateDatalist() {
            const list = document.getElementById('terms-list');
            const datalist = document.getElementById('term-group-suggestions');
            if (!list || !datalist) return;

            // Collect existing group labels
            const existingGroups = new Set();
            list.querySelectorAll('li[data-group]').forEach(row => {
                const label = row.dataset.group;
                if (label && label.trim()) {
                    existingGroups.add(label);
                }
            });

            // Remove previously added dynamic options (marked with data-dynamic attribute)
            datalist.querySelectorAll('option[data-dynamic]').forEach(opt => opt.remove());

            // Add existing groups as new options
            existingGroups.forEach(label => {
                // Check if this label already exists in predefined options
                const existingOption = Array.from(datalist.querySelectorAll('option:not([data-dynamic])')).find(
                    opt => opt.value === label
                );
                if (!existingOption) {
                    const opt = document.createElement('option');
                    opt.value = label;
                    opt.dataset.dynamic = 'true';
                    datalist.appendChild(opt);
                }
            });
        },
    };
}

/**
 * Global helper called by the HTMX afterRequest handler to trigger a
 * group header rebuild after a new term is appended.
 */
function rebuildGroups() {
    const list = document.getElementById('terms-list');
    if (!list) return;
    // Dispatch a synthetic mutation-like event that the Alpine observer picks up.
    // Since Alpine's MutationObserver already handles this, this is a no-op safety
    // call for cases where the observer fires before the DOM settles.
    list.dispatchEvent(new Event('terms:updated', { bubbles: true }));
}

// ---------------------------------------------------------------------------
// GR-01 through GR-04 — Generic arena source panel component
// ---------------------------------------------------------------------------
//
// Shared Alpine component used by all per-arena custom source panels
// (RSS custom feeds, Telegram custom channels, Reddit custom subreddits,
//  Discord custom channel IDs, Wikipedia seed articles).
//
// Parameters:
//   designId  — query design UUID (from Jinja)
//   arenaName — arena identifier matching the PATCH route segment
//               (e.g. 'rss', 'telegram', 'reddit', 'discord', 'wikipedia')
//   fieldName — JSONB key to store the list under within the arena's config
//               (e.g. 'custom_feeds', 'custom_channels', 'seed_articles')
//   initial   — Array of existing values loaded from arenas_config (Jinja-serialised)
//
// PATCH endpoint contract (added by Core Engineer):
//   PATCH /query-designs/{design_id}/arena-config/{arena_name}
//   Content-Type: application/json
//   Body: { "<fieldName>": ["val1", "val2", ...] }
//   Success: 200 JSON { "<fieldName>": [...] }
//
// ---------------------------------------------------------------------------
function arenaSourcePanel(designId, arenaName, fieldName, initial) {
    return {
        open: false,
        items: Array.isArray(initial) ? [...initial] : [],
        newItem: '',
        saving: false,
        savedOk: false,
        saveError: null,
        _savedTimer: null,

        /**
         * Add the current newItem value to the list and persist immediately.
         * Trims whitespace; no-op if empty or already present.
         */
        addItem() {
            const val = this.newItem.trim();
            if (!val) return;
            // Prevent duplicates (case-insensitive).
            if (this.items.some(i => i.toLowerCase() === val.toLowerCase())) {
                this.newItem = '';
                return;
            }
            this.items.push(val);
            this.newItem = '';
            this._persist();
        },

        /**
         * Remove item at the given index and persist immediately.
         * @param {number} idx
         */
        removeItem(idx) {
            this.items.splice(idx, 1);
            this._persist();
        },

        /**
         * PATCH the arena config to the backend.
         * Sends { fieldName: items } as JSON.
         */
        async _persist() {
            this.saving = true;
            this.saveError = null;
            clearTimeout(this._savedTimer);
            try {
                const resp = await fetch(
                    `/query-designs/${designId}/arena-config/${arenaName}`,
                    {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ [fieldName]: [...this.items] }),
                    }
                );
                if (!resp.ok) {
                    const detail = await resp.json().catch(() => ({}));
                    throw new Error(detail.detail || `HTTP ${resp.status}`);
                }
                this.savedOk = true;
                this._savedTimer = setTimeout(() => { this.savedOk = false; }, 3000);
            } catch (err) {
                this.saveError = 'Save failed: ' + err.message;
            } finally {
                this.saving = false;
            }
        },
    };
}

// ---------------------------------------------------------------------------
// GR-05 — Multi-language selector component
// ---------------------------------------------------------------------------
//
// PATCH endpoint contract (added by Core Engineer):
//   PATCH /query-designs/{design_id}/arena-config/global
//   Content-Type: application/json
//   Body: { "languages": ["da", "en", "kl"] }
//   Success: 200 JSON { "languages": [...] }
//
// ---------------------------------------------------------------------------
function languageSelector(designId, initial) {
    return {
        open: false,
        // All available language options in display order.
        availableLanguages: [
            { code: 'da', label: 'Danish' },
            { code: 'en', label: 'English' },
            { code: 'kl', label: 'Greenlandic / Kalaallisut' },
            { code: 'de', label: 'German' },
            { code: 'sv', label: 'Swedish' },
            { code: 'no', label: 'Norwegian' },
            { code: 'ru', label: 'Russian' },
        ],
        // Currently selected language codes. Default to ['da'] if initial is empty.
        selected: (Array.isArray(initial) && initial.length > 0) ? [...initial] : ['da'],
        saving: false,
        savedOk: false,
        saveError: null,
        _savedTimer: null,

        /**
         * IP2-052: Expose selected languages globally for term translation UI.
         */
        init() {
            window.__queryDesignLanguages = () => this.selected;
        },

        /**
         * Toggle a language code in/out of the selected array.
         * At least one language must remain selected.
         * @param {string} code - ISO 639-1 language code
         */
        toggleLanguage(code) {
            const idx = this.selected.indexOf(code);
            if (idx === -1) {
                this.selected.push(code);
            } else {
                // Do not allow deselecting the last language.
                if (this.selected.length <= 1) return;
                this.selected.splice(idx, 1);
            }
        },

        /**
         * PATCH the global arena config with the selected languages array.
         */
        async save() {
            this.saving = true;
            this.saveError = null;
            clearTimeout(this._savedTimer);
            try {
                const resp = await fetch(
                    `/query-designs/${designId}/arena-config/global`,
                    {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ languages: [...this.selected] }),
                    }
                );
                if (!resp.ok) {
                    const detail = await resp.json().catch(() => ({}));
                    throw new Error(detail.detail || `HTTP ${resp.status}`);
                }
                this.savedOk = true;
                this._savedTimer = setTimeout(() => { this.savedOk = false; }, 3000);
            } catch (err) {
                this.saveError = 'Save failed: ' + err.message;
            } finally {
                this.saving = false;
            }
        },
    };
}

// ---------------------------------------------------------------------------
// YF-12 — RSS Feed Preview Component
// ---------------------------------------------------------------------------
//
// Displays the list of default Danish RSS feeds with search filtering.
// Fetches feed data from GET /api/arenas/rss-feeds/feeds.
//
// ---------------------------------------------------------------------------
function rssFeedViewer() {
    return {
        feeds: [],
        searchQuery: '',
        loading: false,
        error: null,

        async loadFeeds() {
            this.loading = true;
            this.error = null;
            try {
                const resp = await fetch('/api/arenas/rss-feeds/feeds', {
                    credentials: 'include',
                });
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                const data = await resp.json();
                // Transform the feeds dict into an array
                this.feeds = Object.entries(data.feeds || {}).map(([key, url]) => ({
                    key: key,
                    name: this.formatOutletName(key),
                    url: url
                }));
            } catch (err) {
                this.error = 'Failed to load feeds: ' + err.message;
                console.error('rssFeedViewer: loadFeeds error', err);
            } finally {
                this.loading = false;
            }
        },

        /**
         * Convert feed key to human-readable outlet name.
         * Examples:
         *   "dr_allenyheder" -> "DR AllNyheder"
         *   "tv2_nyheder" -> "TV2 Nyheder"
         *   "politiken_seneste" -> "Politiken Seneste"
         */
        formatOutletName(key) {
            return key
                .split('_')
                .map((part, idx) => {
                    if (idx === 0) {
                        // First part is outlet abbreviation - keep uppercase
                        return part.toUpperCase();
                    }
                    // Subsequent parts - capitalize first letter
                    return part.charAt(0).toUpperCase() + part.slice(1);
                })
                .join(' ');
        },

        /**
         * Filter feeds by search query (matches outlet name or URL).
         */
        get filteredFeeds() {
            if (!this.searchQuery.trim()) {
                return this.feeds;
            }
            const q = this.searchQuery.toLowerCase();
            return this.feeds.filter(feed =>
                feed.name.toLowerCase().includes(q) ||
                feed.url.toLowerCase().includes(q)
            );
        },
    };
}

// ---------------------------------------------------------------------------
// YF-01 — Per-arena search term scoping
// ---------------------------------------------------------------------------
//
// Alpine component for the arena selector in the search term form.
// Fetches the list of available arenas from GET /api/arenas/ and allows
// the researcher to scope a term to specific arenas. When no arenas are
// selected, the term applies to all arenas (default behavior).
//
// ---------------------------------------------------------------------------
/**
 * Bulk actor importer component (YF-07).
 *
 * Provides a textarea-based UI for importing multiple actors at once,
 * supporting two formats:
 *   - Simple: one actor name per line (defaults to "person" type)
 *   - Structured: name | type (pipe-delimited)
 *
 * Lines starting with # are treated as comments and skipped.
 * Empty lines are ignored.
 */
function bulkActorImport() {
    return {
        bulkInput: '',
        importing: false,
        bulkSuccess: null,
        bulkError: null,

        /**
         * Parse the bulk input textarea and submit to the backend.
         */
        async submitBulkActors() {
            this.bulkError = null;
            this.bulkSuccess = null;

            const lines = this.bulkInput
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'));

            if (lines.length === 0) {
                this.bulkError = 'No valid actors found. Add at least one actor.';
                return;
            }

            const actors = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineNum = i + 1;

                try {
                    const actor = this.parseLine(line);
                    actors.push(actor);
                } catch (err) {
                    this.bulkError = `Line ${lineNum}: ${err.message}`;
                    return;
                }
            }

            // Submit to backend
            this.importing = true;
            try {
                const designId = '{{ design_id }}';
                const resp = await fetch(`/query-designs/${designId}/actors/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(actors),
                });

                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${resp.status}`);
                }

                // Success - clear input and refresh the actors list
                const result = await resp.json();
                const total = result.added.length + result.skipped.length;

                if (result.skipped.length > 0) {
                    this.bulkSuccess = `Added ${result.added.length} actor${result.added.length !== 1 ? 's' : ''}, skipped ${result.skipped.length} duplicate${result.skipped.length !== 1 ? 's' : ''}`;
                } else {
                    this.bulkSuccess = `Added ${result.added.length} actor${result.added.length !== 1 ? 's' : ''}`;
                }

                this.bulkInput = '';

                // Reload the page to show the new actors
                setTimeout(() => {
                    window.location.reload();
                }, 800);

            } catch (err) {
                this.bulkError = err.message;
            } finally {
                this.importing = false;
            }
        },

        /**
         * Parse a single line into an ActorBulkItem object.
         *
         * Supports two formats:
         *   - Simple: "name" → {name: "name", actor_type: "person"}
         *   - Structured: "name | type" → {name: "name", actor_type: "type"}
         *
         * @param {string} line - The input line to parse
         * @returns {object} ActorBulkItem-compatible object
         * @throws {Error} If the line is invalid
         */
        parseLine(line) {
            // Check if it's structured format (contains pipe)
            if (line.includes('|')) {
                const parts = line.split('|').map(p => p.trim());

                const name = parts[0];
                if (!name) {
                    throw new Error('Actor name must not be empty');
                }

                const actor_type = parts[1] || 'person';

                // Validate actor type
                const validTypes = [
                    'person', 'organization', 'political_party', 'educational_institution',
                    'teachers_union', 'think_tank', 'media_outlet', 'government_body',
                    'ngo', 'company', 'unknown'
                ];
                if (!validTypes.includes(actor_type)) {
                    throw new Error(`Invalid actor type: ${actor_type}. Must be one of: ${validTypes.join(', ')}`);
                }

                return { name, actor_type };
            } else {
                // Simple format: just a name, defaults to person
                return {
                    name: line,
                    actor_type: 'person'
                };
            }
        },

        /**
         * Clear the input textarea and any error message.
         */
        clearInput() {
            this.bulkInput = '';
            this.bulkError = null;
            this.bulkSuccess = null;
        }
    };
}

/**
 * Bulk term importer component.
 *
 * Provides a textarea-based UI for importing multiple search terms at once,
 * supporting two formats:
 *   - Simple: one term per line (defaults to "keyword" type)
 *   - Structured: term | type | group_label | arenas (pipe-delimited)
 *
 * Lines starting with # are treated as comments and skipped.
 * Empty lines are ignored.
 */
function bulkTermImporter() {
    return {
        bulkMode: false,
        bulkInput: '',
        importing: false,
        bulkSuccess: null,
        bulkError: null,

        /**
         * Parse the bulk input textarea and submit to the backend.
         */
        async importTerms() {
            this.bulkError = null;
            this.bulkSuccess = null;

            const lines = this.bulkInput
                .split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'));

            if (lines.length === 0) {
                this.bulkError = 'No valid terms found. Add at least one term.';
                return;
            }

            const terms = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const lineNum = i + 1;

                try {
                    const term = this.parseLine(line);
                    terms.push(term);
                } catch (err) {
                    this.bulkError = `Line ${lineNum}: ${err.message}`;
                    return;
                }
            }

            // Submit to backend
            this.importing = true;
            try {
                const designId = '{{ design_id }}';
                const resp = await fetch(`/query-designs/${designId}/terms/bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(terms),
                });

                if (!resp.ok) {
                    const errorData = await resp.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${resp.status}`);
                }

                // Success - clear input and refresh the terms list
                const addedTerms = await resp.json();
                this.bulkSuccess = `Added ${addedTerms.length} term${addedTerms.length !== 1 ? 's' : ''}`;
                this.bulkInput = '';

                // Reload the page to show the new terms with proper grouping
                setTimeout(() => {
                    window.location.reload();
                }, 800);

            } catch (err) {
                this.bulkError = err.message;
            } finally {
                this.importing = false;
            }
        },

        /**
         * Parse a single line into a SearchTermCreate object.
         *
         * Supports two formats:
         *   - Simple: "term" → {term: "term", term_type: "keyword"}
         *   - Structured: "term | type | group | arenas" → full object
         *
         * @param {string} line - The input line to parse
         * @returns {object} SearchTermCreate-compatible object
         * @throws {Error} If the line is invalid
         */
        parseLine(line) {
            // Check if it's structured format (contains pipes)
            if (line.includes('|')) {
                const parts = line.split('|').map(p => p.trim());

                const term = parts[0];
                if (!term) {
                    throw new Error('Term text cannot be empty');
                }

                const termType = parts[1] || 'keyword';
                const validTypes = ['keyword', 'phrase', 'hashtag', 'url_pattern'];
                if (!validTypes.includes(termType)) {
                    throw new Error(`Invalid term type "${termType}". Must be one of: ${validTypes.join(', ')}`);
                }

                const groupLabel = parts[2] || null;
                const arenasStr = parts[3] || '';
                const targetArenas = arenasStr
                    ? arenasStr.split(',').map(a => a.trim()).filter(a => a)
                    : null;

                return {
                    term: term,
                    term_type: termType,
                    group_label: groupLabel,
                    target_arenas: targetArenas,
                };
            } else {
                // Simple format: just the term text
                return {
                    term: line,
                    term_type: 'keyword',
                    group_label: null,
                    target_arenas: null,
                };
            }
        },
    };
}

function termArenaSelector() {
    return {
        arenaOpen: false,
        availableArenas: [],
        selectedArenas: [],
        _loading: false,

        async init() {
            await this.fetchArenas();
        },

        /**
         * Fetch the list of available arenas from the backend.
         */
        async fetchArenas() {
            if (this._loading || this.availableArenas.length > 0) return;
            this._loading = true;
            try {
                const resp = await fetch('/api/arenas/');
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const arenas = await resp.json();
                // Sort alphabetically by platform_name for consistent display
                this.availableArenas = arenas.sort((a, b) =>
                    a.platform_name.localeCompare(b.platform_name)
                );
            } catch (err) {
                console.error('Failed to fetch arenas:', err);
            } finally {
                this._loading = false;
            }
        },

        /**
         * Return a comma-separated string of selected arena platform_names
         * for submission to the backend. Returns empty string if none selected
         * (which means "all arenas").
         */
        getArenaValue() {
            return this.selectedArenas.join(',');
        },

        /**
         * Reset the arena selector state after successful form submission.
         */
        resetArenaSelector() {
            this.selectedArenas = [];
            this.arenaOpen = false;
        },

        /**
         * Summary text for the collapsible arena selector button.
         */
        arenaSelectionSummary() {
            const count = this.selectedArenas.length;
            if (count === 0) {
                return 'Target arenas: all (default)';
            } else if (count === 1) {
                return `Target arenas: ${this.selectedArenas[0]}`;
            } else {
                return `Target arenas: ${count} selected`;
            }
        },

        // ---------------------------------------------------------------
        // IP2-052: Translation management for multilingual term pairing
        // ---------------------------------------------------------------
        translationsOpen: false,
        translations: {},

        /**
         * Language code to label mapping (subset matching languageSelector).
         */
        languageMap: {
            'da': 'Danish',
            'kl': 'Greenlandic',
            'en': 'English',
            'fo': 'Faroese',
            'de': 'German',
            'sv': 'Swedish',
            'nb': 'Norwegian',
        },

        /**
         * Get the list of non-default languages that need translation inputs.
         * This reads from the global languageSelector state via window.
         *
         * @returns {Array<{code: string, label: string}>} Languages excluding Danish
         */
        translationLanguages() {
            // Access the languageSelector's selected languages via global accessor
            const selectedLangs = (typeof window.__queryDesignLanguages === 'function')
                ? window.__queryDesignLanguages()
                : ['da'];

            // Filter out Danish (da) since it's the default and doesn't need translation
            return selectedLangs
                .filter(code => code !== 'da')
                .map(code => ({
                    code: code,
                    label: this.languageMap[code] || code.toUpperCase()
                }));
        },

        /**
         * Serialize the translations object to JSON for form submission.
         * Only includes non-empty translation values.
         *
         * @returns {string} JSON string or empty string if no translations
         */
        getTranslationsJSON() {
            const filtered = {};
            for (const [lang, value] of Object.entries(this.translations)) {
                if (value && value.trim()) {
                    filtered[lang] = value.trim();
                }
            }
            return Object.keys(filtered).length > 0 ? JSON.stringify(filtered) : '';
        },

        /**
         * Reset translations state after successful form submission.
         */
        resetTranslations() {
            this.translations = {};
            this.translationsOpen = false;
        },
    };
}
</script>
{% endblock %}
