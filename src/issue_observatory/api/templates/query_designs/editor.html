{% extends "base.html" %}
{% block title %}{% if design_id is defined and design_id %}Edit Query Design{% else %}New Query Design{% endif %}{% endblock %}

{% block content %}
{#
    Query design editor — Phase 1.14 implementation.
    Covers: core metadata form + search terms panel (HTMX add/remove)
            + arena configuration grid (Alpine-powered, per-arena tier selection)
            + actor list sub-panel (HTMX add/remove actors).

    Context:
        - design (dict|None): existing design for editing, or None for create
        - design_id (str|None): UUID string (also derivable from design.id)
        - terms (list): existing search terms (dicts with id, term, term_type, is_active)
        - actors (list): existing actor list members (dicts with id, name, type)
#}
{% set is_edit = design_id is defined and design_id %}
{% set action_url = '/query-designs/' + design_id if is_edit else '/query-designs/' %}
{% set design = design | default({}) %}
{% set terms = terms | default([]) %}
{% set actors = actors | default([]) %}

<div class="max-w-4xl mx-auto space-y-6" x-data="queryEditor()">

    {# Page header #}
    <div class="flex items-center gap-3">
        <a href="/query-designs"
           class="text-gray-400 hover:text-gray-600 transition-colors"
           aria-label="Back to list">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-xl font-bold text-gray-900">
            {% if is_edit %}Edit Query Design{% else %}New Query Design{% endif %}
        </h1>
    </div>

    {# Metadata form #}
    <div class="bg-white rounded-lg shadow p-6 space-y-5">
        <h2 class="text-sm font-semibold text-gray-900 border-b border-gray-200 pb-3">Basic Information</h2>

        <form method="POST"
              action="{{ action_url }}"
              id="design-form"
              hx-post="{{ action_url if not is_edit else '' }}"
              hx-put="{{ action_url if is_edit else '' }}"
              {% if not is_edit %}
              hx-on::after-request="if(event.detail.successful){ window.location.href = '/query-designs/' + event.detail.xhr.getResponseHeader('HX-Redirect-To') || '/query-designs' }"
              {% endif %}>

            <div class="grid grid-cols-2 gap-5">
                {# Name #}
                <div class="col-span-2">
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
                        Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text"
                           id="name"
                           name="name"
                           required
                           maxlength="200"
                           value="{{ design.name | default('') }}"
                           placeholder="e.g. Climate debate DK 2024"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>

                {# Description #}
                <div class="col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <textarea id="description"
                              name="description"
                              rows="3"
                              placeholder="Brief description of the purpose and scope of this query design..."
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none">{{ design.description | default('') }}</textarea>
                </div>

                {# Visibility #}
                <div>
                    <label for="visibility" class="block text-sm font-medium text-gray-700 mb-1">
                        Visibility
                    </label>
                    <select id="visibility"
                            name="visibility"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="private" {% if design.visibility | default('private') == 'private' %}selected{% endif %}>Private</option>
                        <option value="team"    {% if design.visibility | default('') == 'team' %}selected{% endif %}>Team</option>
                        <option value="public"  {% if design.visibility | default('') == 'public' %}selected{% endif %}>Public</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Public designs are visible to all users, but only you can edit them.</p>
                </div>

                {# Default tier #}
                <div>
                    <label for="default_tier" class="block text-sm font-medium text-gray-700 mb-1">
                        Default Collection Tier
                    </label>
                    <select id="default_tier"
                            name="default_tier"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="free"    {% if design.default_tier | default('free') == 'free' %}selected{% endif %}>Free — free data sources only</option>
                        <option value="medium"  {% if design.default_tier | default('') == 'medium' %}selected{% endif %}>Medium — low-cost paid services</option>
                        <option value="premium" {% if design.default_tier | default('') == 'premium' %}selected{% endif %}>Premium — best available</option>
                    </select>
                </div>

                {# Language #}
                <div>
                    <label for="language" class="block text-sm font-medium text-gray-700 mb-1">
                        Language
                    </label>
                    <select id="language"
                            name="language"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="da" {% if design.language | default('da') == 'da' %}selected{% endif %}>Danish (da)</option>
                        <option value="en" {% if design.language | default('') == 'en' %}selected{% endif %}>English (en)</option>
                        <option value="de" {% if design.language | default('') == 'de' %}selected{% endif %}>German (de)</option>
                    </select>
                </div>

            </div>

            {# Save button for metadata #}
            {% if not is_edit %}
            <div class="pt-4 border-t border-gray-200 mt-5 flex items-center justify-between">
                <a href="/query-designs"
                   class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
                <button type="submit"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50">
                    Create Query Design
                </button>
            </div>
            {% else %}
            <div class="pt-4 border-t border-gray-200 mt-5 flex items-center justify-between">
                <a href="/query-designs/{{ design_id }}"
                   class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
                <button type="submit"
                        hx-put="{{ action_url }}"
                        hx-target="#design-form"
                        hx-swap="none"
                        hx-indicator="#save-spinner"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                    {% include '_partials/loading_spinner.html' %}
                    Save Changes
                </button>
            </div>
            {% endif %}
        </form>
    </div>

    {% if is_edit %}

    {# Search terms panel #}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <h2 class="text-sm font-semibold text-gray-900">Search Terms</h2>
            <span class="text-xs text-gray-400" id="term-count">{{ terms | length }} term{% if terms | length != 1 %}er{% endif %}</span>
        </div>

        {# Add term form #}
        <form hx-post="/query-designs/{{ design_id }}/terms"
              hx-target="#terms-list"
              hx-swap="beforeend"
              hx-on::after-request="if(event.detail.successful){ this.reset(); document.getElementById('new-term-input').focus(); }"
              class="flex gap-2 mb-4">
            <select name="term_type"
                    class="border border-gray-300 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex-shrink-0">
                <option value="keyword">Keyword</option>
                <option value="phrase">Phrase</option>
                <option value="hashtag">Hashtag</option>
                <option value="url_pattern">URL pattern</option>
            </select>
            <input type="text"
                   id="new-term-input"
                   name="term"
                   required
                   placeholder="Add search term..."
                   autocomplete="off"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <button type="submit"
                    class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors flex-shrink-0">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                </svg>
                Add
            </button>
        </form>

        {# Terms list — HTMX appends new rows, delete removes them #}
        {% if terms %}
        <ul class="space-y-1.5" id="terms-list">
            {% for term in terms %}
                {% include '_fragments/term_row.html' %}
            {% endfor %}
        </ul>
        {% else %}
        <ul class="space-y-1.5" id="terms-list"></ul>
        <p class="text-sm text-gray-400 text-center py-6" id="terms-empty">
            No search terms yet. Add the first term above.
        </p>
        {% endif %}
    </div>

    {# Actor list panel #}
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Actor List</h2>
                <p class="text-xs text-gray-400 mt-0.5">Specific accounts or people to track across arenas</p>
            </div>
            <span class="text-xs text-gray-400" id="actor-count">{{ actors | length }} actor{% if actors | length != 1 %}s{% endif %}</span>
        </div>

        {# Add actor form #}
        <form hx-post="/query-designs/{{ design_id }}/actors"
              hx-target="#actors-list"
              hx-swap="beforeend"
              hx-on::after-request="if(event.detail.successful){ this.reset(); document.getElementById('new-actor-input').focus(); }"
              class="flex gap-2 mb-4">
            <select name="actor_type"
                    class="border border-gray-300 rounded px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white flex-shrink-0">
                <option value="person">Person</option>
                <option value="organisation">Organisation</option>
                <option value="media_outlet">Media outlet</option>
                <option value="account">Account</option>
            </select>
            <input type="text"
                   id="new-actor-input"
                   name="name"
                   required
                   placeholder="Actor name or handle..."
                   autocomplete="off"
                   class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <button type="submit"
                    class="inline-flex items-center gap-1.5 px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded hover:bg-gray-200 transition-colors flex-shrink-0">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                </svg>
                Add
            </button>
        </form>

        {# Actors list #}
        {% if actors %}
        <ul class="space-y-1.5" id="actors-list">
            {% for actor in actors %}
            <li id="actor-{{ actor.id }}"
                class="flex items-center justify-between gap-3 py-2 px-3 rounded-md bg-gray-50 border border-gray-200 group">
                <div class="flex items-center gap-2 min-w-0">
                    {# Type badge #}
                    {% set atype = actor.type | default('account') %}
                    {% if atype == 'person' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700 flex-shrink-0">Person</span>
                    {% elif atype == 'organisation' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700 flex-shrink-0">Org</span>
                    {% elif atype == 'media_outlet' %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-700 flex-shrink-0">Media</span>
                    {% else %}
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 flex-shrink-0">Account</span>
                    {% endif %}
                    <span class="text-sm text-gray-900 font-medium truncate">{{ actor.name | default('') }}</span>
                    {% if actor.actor_id is defined %}
                    <a href="/actors/{{ actor.actor_id }}"
                       class="text-xs text-blue-500 hover:text-blue-700 flex-shrink-0"
                       title="View actor profile">Profile</a>
                    {% endif %}
                </div>
                <button type="button"
                        hx-delete="/query-designs/{{ design_id }}/actors/{{ actor.id }}"
                        hx-target="#actor-{{ actor.id }}"
                        hx-swap="outerHTML"
                        hx-confirm="Remove '{{ actor.name | default('') }}' from this actor list?"
                        class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded text-gray-400 hover:text-red-600 hover:bg-red-50"
                        aria-label="Remove actor">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <ul class="space-y-1.5" id="actors-list"></ul>
        <p class="text-sm text-gray-400 text-center py-6">
            No actors in this list. Add specific accounts or people to track above.
        </p>
        {% endif %}
    </div>

    {#
        Arena configuration grid — Alpine-powered, Phase 1.14.
        The arena list is hardcoded here; no server discovery needed for Phase 1.
        Each row: arena name, enabled toggle (Alpine x-model), tier selector.
        Credit estimate fires via HTMX debounced 400ms on any change.
    #}
    <div class="bg-white rounded-lg shadow p-6"
         x-data="arenaConfigGrid('{{ design.default_tier | default('free') }}')">

        <div class="flex items-center justify-between border-b border-gray-200 pb-3 mb-4">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Arena Configuration</h2>
                <p class="text-xs text-gray-400 mt-0.5">Enable arenas and choose a tier for each one</p>
            </div>
            {# Hidden HTMX trigger for estimate refresh #}
            <div id="arena-estimate-trigger"
                 hx-get="/api/collections/estimate"
                 hx-trigger="arena-estimate"
                 hx-target="#arena-credit-estimate"
                 hx-swap="innerHTML"
                 hx-include="#arena-config-form"
                 hx-indicator="#estimate-spinner"
                 style="display:none">
            </div>
            <div class="flex items-center gap-2">
                <span id="estimate-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5 text-blue-600" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
                <button type="button"
                        @click="enableAll()"
                        class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                    Enable all
                </button>
                <button type="button"
                        @click="disableAll()"
                        class="text-xs text-gray-500 hover:text-gray-700 px-2 py-1 rounded hover:bg-gray-100 transition-colors">
                    Disable all
                </button>
            </div>
        </div>

        {# Hidden form fields that HTMX sends to the estimate endpoint #}
        <form id="arena-config-form" style="display:none">
            <input type="hidden" name="design_id" value="{{ design_id }}">
            <template x-for="arena in arenas" :key="arena.id">
                <div>
                    <input type="hidden" :name="'arena[' + arena.id + '][enabled]'" :value="arena.enabled ? '1' : '0'">
                    <input type="hidden" :name="'arena[' + arena.id + '][tier]'" :value="arena.tier">
                </div>
            </template>
        </form>

        <table class="min-w-full text-sm">
            <thead>
                <tr class="text-left">
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Arena</th>
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Enabled</th>
                    <th class="pb-2 pr-4 text-xs font-medium text-gray-500 uppercase tracking-wider">Tier</th>
                    <th class="pb-2 text-xs font-medium text-gray-500 uppercase tracking-wider text-right">Est. Credits</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <template x-for="arena in arenas" :key="arena.id">
                    <tr :class="arena.enabled ? '' : 'opacity-50'">
                        {# Arena name + platform label #}
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-800 capitalize"
                                      x-text="arena.label"></span>
                                <span class="text-xs text-gray-400 font-mono" x-text="arena.id"></span>
                            </div>
                        </td>

                        {# Enable/disable toggle #}
                        <td class="py-3 pr-4">
                            <button type="button"
                                    @click="toggleArena(arena); scheduleEstimate()"
                                    :class="arena.enabled
                                        ? 'bg-blue-600'
                                        : 'bg-gray-200'"
                                    class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                                    :aria-pressed="arena.enabled.toString()"
                                    :aria-label="'Toggle ' + arena.label">
                                <span :class="arena.enabled ? 'translate-x-5' : 'translate-x-1'"
                                      class="inline-block h-3 w-3 transform rounded-full bg-white transition-transform"></span>
                            </button>
                        </td>

                        {# Tier radio buttons — only active when arena is enabled #}
                        <td class="py-3 pr-4">
                            <div class="flex items-center gap-3" :class="arena.enabled ? '' : 'pointer-events-none'">
                                <template x-for="t in ['free', 'medium', 'premium']" :key="t">
                                    <label class="flex items-center gap-1 cursor-pointer">
                                        <input type="radio"
                                               :name="'tier_' + arena.id"
                                               :value="t"
                                               x-model="arena.tier"
                                               @change="scheduleEstimate()"
                                               :disabled="!arena.enabled"
                                               class="text-blue-600 focus:ring-blue-500">
                                        <span class="text-xs capitalize"
                                              :class="{
                                                'text-green-700': t === 'free',
                                                'text-yellow-700': t === 'medium',
                                                'text-purple-700': t === 'premium'
                                              }"
                                              x-text="t"></span>
                                    </label>
                                </template>
                            </div>
                        </td>

                        {# Estimated credits (per-arena placeholder; aggregate shown below) #}
                        <td class="py-3 text-right">
                            <span class="text-xs font-mono text-gray-400"
                                  x-show="!arena.enabled">—</span>
                            <span class="text-xs font-mono text-gray-600"
                                  x-show="arena.enabled"
                                  :class="arena.tier === 'premium' ? 'text-purple-700' : arena.tier === 'medium' ? 'text-yellow-700' : 'text-green-700'">
                                <span x-text="arena.estimatedCredits !== null ? arena.estimatedCredits : '…'"></span>
                            </span>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>

        {# Credit estimate summary — HTMX-populated #}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <div id="arena-credit-estimate" class="text-sm text-gray-500">
                <span class="text-xs text-gray-400">Change arena settings to see a credit estimate.</span>
            </div>
        </div>

        {# Save arena config button #}
        <div class="mt-4 flex justify-end">
            <button type="button"
                    hx-post="/query-designs/{{ design_id }}/arena-config"
                    hx-include="#arena-config-form"
                    hx-swap="none"
                    hx-indicator="#save-arena-spinner"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-gray-800 text-white text-sm font-medium rounded-md hover:bg-gray-700 transition-colors">
                <span id="save-arena-spinner" class="htmx-indicator">
                    <svg class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                         fill="none" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                </span>
                Save Arena Config
            </button>
        </div>
    </div>

    {% endif %}{# /is_edit #}

</div>

<script>
/**
 * Alpine component for the arena configuration grid.
 *
 * The arena list is defined statically here — Phase 1 arenas only.
 * The `defaultTier` parameter comes from the server-rendered default_tier field.
 * Per-arena saved configuration would ideally be loaded from the server
 * via an API call in `init()`, but for Phase 1 we start from the design default.
 *
 * API contract needed (Phase 1.14 backend):
 *   GET  /query-designs/{id}/arena-config   → { arenas: [{id, enabled, tier}] }
 *   POST /query-designs/{id}/arena-config   → 200
 */
function arenaConfigGrid(defaultTier) {
    // Phase 1 arena registry — hardcoded for stability (no dynamic discovery needed)
    const ARENAS = [
        { id: 'google_search',      label: 'Google Search',      platform: 'google' },
        { id: 'google_autocomplete',label: 'Google Autocomplete', platform: 'google' },
        { id: 'bluesky',            label: 'Bluesky',            platform: 'bluesky' },
        { id: 'reddit',             label: 'Reddit',             platform: 'reddit' },
        { id: 'youtube',            label: 'YouTube',            platform: 'youtube' },
        { id: 'rss_feeds',          label: 'RSS Feeds',          platform: 'rss' },
        { id: 'gdelt',              label: 'GDELT',              platform: 'gdelt' },
        { id: 'telegram',           label: 'Telegram',           platform: 'telegram' },
        { id: 'tiktok',             label: 'TikTok',             platform: 'tiktok' },
        { id: 'ritzau_via',         label: 'Ritzau Infostream',  platform: 'ritzau' },
        { id: 'gab',                label: 'Gab',                platform: 'gab' },
    ];

    return {
        arenas: ARENAS.map(a => ({
            ...a,
            enabled: false,
            tier: defaultTier || 'free',
            estimatedCredits: null,
        })),
        _estimateTimer: null,

        init() {
            // Load existing arena config from server if editing
            const designId = document.querySelector('input[name="design_id"]')?.value;
            if (designId) {
                fetch('/api/query-designs/' + designId + '/arena-config')
                    .then(r => r.ok ? r.json() : null)
                    .then(data => {
                        if (!data || !data.arenas) return;
                        // Merge server state into local arena list
                        data.arenas.forEach(saved => {
                            const arena = this.arenas.find(a => a.id === saved.id);
                            if (arena) {
                                arena.enabled = saved.enabled;
                                arena.tier = saved.tier || arena.tier;
                            }
                        });
                    })
                    .catch(() => {
                        // Silently ignore — server config not yet saved, defaults are fine
                    });
            }

            // Listen for estimate results from the credit_estimate fragment
            document.addEventListener('estimate:result', (evt) => {
                this.applyEstimateResult(evt.detail);
            });
        },

        toggleArena(arena) {
            arena.enabled = !arena.enabled;
        },

        enableAll() {
            this.arenas.forEach(a => { a.enabled = true; });
            this.scheduleEstimate();
        },

        disableAll() {
            this.arenas.forEach(a => { a.enabled = false; });
            this.scheduleEstimate();
        },

        scheduleEstimate() {
            clearTimeout(this._estimateTimer);
            this._estimateTimer = setTimeout(() => {
                const trigger = document.getElementById('arena-estimate-trigger');
                if (trigger) htmx.trigger(trigger, 'arena-estimate');
            }, 400);
        },

        applyEstimateResult(detail) {
            // The estimate fragment may provide per-arena breakdown in detail.arenas
            if (detail.arenas) {
                detail.arenas.forEach(est => {
                    const arena = this.arenas.find(a => a.id === est.id);
                    if (arena) arena.estimatedCredits = est.credits;
                });
            }
        },
    };
}

/**
 * Alpine component for the query design editor.
 * Term add/remove is handled by HTMX; this component provides local state.
 */
Alpine.data('queryEditor', () => ({
    init() {
        const input = document.getElementById('new-term-input');
        if (input) {
            setTimeout(() => input.focus(), 100);
        }
    },
}));
</script>
{% endblock %}
