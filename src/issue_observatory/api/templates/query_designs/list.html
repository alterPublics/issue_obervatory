{% extends "base.html" %}
{% block title %}Query Designs{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">

    {# Page header #}
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Query Designs</h1>
            <p class="text-sm text-gray-500 mt-0.5">Configure search terms and actor lists for collection</p>
        </div>
        <a href="/query-designs/new"
           class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
            </svg>
            New Query Design
        </a>
    </div>

    {# Designs table #}
    <div class="bg-white rounded-lg shadow overflow-hidden">
        {% if designs | default([]) | length > 0 %}
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Name</th>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Visibility</th>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Default Tier</th>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Search Terms</th>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Created</th>
                    <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Status</th>
                    <th class="px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="designs-tbody">
                {% for design in designs %}
                <tr class="hover:bg-gray-50 transition-colors" id="design-row-{{ design.id }}">
                    <td class="px-6 py-4">
                        <a href="/query-designs/{{ design.id }}"
                           class="font-medium text-gray-900 hover:text-blue-600">
                            {{ design.name | default('(untitled)') }}
                        </a>
                        {% if design.description | default('') %}
                        <p class="text-xs text-gray-400 mt-0.5 truncate max-w-xs">
                            {{ design.description }}
                        </p>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        {% set vis = design.visibility | default('private') %}
                        {% if vis == 'public' %}
                            <span class="inline-flex items-center gap-1 text-green-700">
                                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                     stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/></svg>
                                Public
                            </span>
                        {% elif vis == 'team' %}
                            <span class="text-blue-700">Team</span>
                        {% else %}
                            <span class="text-gray-500">Private</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        {% set tier = design.default_tier | default('free') %}
                        {% if tier == 'free' %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Free</span>
                        {% elif tier == 'medium' %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Medium</span>
                        {% else %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">Premium</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        {{ design.search_term_count | default(0) }}
                    </td>
                    <td class="px-6 py-4 text-gray-500 text-xs">
                        {{ design.created_at | default('') | truncate(10, true, '') }}
                    </td>
                    <td class="px-6 py-4">
                        {% if design.is_active | default(true) %}
                            <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                        {% else %}
                            <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Inactive</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                            <a href="/query-designs/{{ design.id }}/edit"
                               class="text-sm text-gray-500 hover:text-blue-600 transition-colors px-2 py-1 rounded hover:bg-gray-100">
                                Edit
                            </a>
                            <a href="/collections/new?design_id={{ design.id }}"
                               class="text-sm text-gray-500 hover:text-green-700 transition-colors px-2 py-1 rounded hover:bg-gray-100">
                                Collect
                            </a>
                            {#
                                IP2-051: Clone — creates a copy of the design and all its
                                search terms.  The backend POST /query-designs/{id}/clone
                                returns a 303 redirect to the new design's editor, so the
                                browser navigates there automatically on success.
                                hx-boost=false prevents HTMX from intercepting the redirect.
                            #}
                            <button type="button"
                                    hx-post="/query-designs/{{ design.id }}/clone"
                                    hx-confirm="Create a copy of '{{ design.name | default('this design') }}'?"
                                    hx-boost="false"
                                    class="text-sm text-gray-500 hover:text-purple-600 transition-colors px-2 py-1 rounded hover:bg-purple-50">
                                Clone
                            </button>
                            {# HTMX delete — confirms, then swaps the row out of the DOM #}
                            <button type="button"
                                    hx-delete="/query-designs/{{ design.id }}"
                                    hx-target="#design-row-{{ design.id }}"
                                    hx-swap="outerHTML"
                                    hx-confirm="Delete query design '{{ design.name | default('this design') }}'? All associated search terms will also be deleted."
                                    class="text-sm text-gray-400 hover:text-red-600 transition-colors px-2 py-1 rounded hover:bg-red-50">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {# Pagination — only shown when there are enough results #}
        {% if next_cursor is defined or prev_cursor is defined %}
        <div class="px-6 py-3 border-t border-gray-200">
            {% set hx_target = '#designs-tbody' %}
            {% set base_url = '/query-designs' %}
            {% include '_partials/pagination.html' %}
        </div>
        {% endif %}

        {% else %}
        {# Empty state #}
        {% set empty_title = 'No query designs yet' %}
        {% set empty_message = 'Create your first query design to define search terms and actor lists for collection.' %}
        {% set empty_cta_label = 'New Query Design' %}
        {% set empty_cta_href = '/query-designs/new' %}
        {% include '_partials/empty_state.html' %}
        {% endif %}
    </div>

</div>
{% endblock %}
