{% extends "base.html" %}
{% block title %}Collection Run — {{ run.query_design_name | default(run_id | default('')) }}{% endblock %}

{% block content %}
{#
    Collection run live status page.

    SSE connection to /api/collections/{run_id}/stream streams two event types:
      - 'task_update':  server renders _fragments/task_row.html with hx-swap-oob
                        which HTMX automatically routes to the matching <tr> by id.
      - 'run_update':   server renders _fragments/run_summary.html with hx-swap-oob
                        which updates the summary card at the top.
      - 'run_complete': signals the SSE close event; HTMX disconnects the stream.

    Context:
        - run_id (str):  UUID of the run (always available)
        - run (dict, optional): initial run state from the page route handler
        - tasks (list, optional): initial task list for pre-rendering rows
#}
{% set run = run | default({}) %}
{% set tasks = tasks | default([]) %}
{% set run_id = run_id | default(run.id | default('')) %}
{% set status = run.status | default('running') %}
{% set mode = run.mode | default('batch') %}
{% set is_live = mode == 'live' %}
{% set is_terminal = status in ('completed', 'failed', 'cancelled') %}

<div class="max-w-5xl mx-auto space-y-6">

    {# Breadcrumb navigation #}
    {% set _run_label = run.query_design_name | default('Collection Run') %}
    {% set breadcrumbs = [('Collections', '/collections'), (_run_label, '')] %}
    {% include '_partials/breadcrumbs.html' %}

    {# Page title #}
    <div class="flex items-center gap-3 flex-wrap">
        <div>
            <h1 class="text-xl font-bold text-gray-900">
                {% if run.query_design_name | default('') %}
                    {{ run.query_design_name }}
                {% else %}
                    Collection Run
                {% endif %}
            </h1>
            <div class="flex items-center gap-3 mt-0.5">
                <span class="text-xs text-gray-400 font-mono">Run ID: {{ run_id | truncate(8, true, '') }}</span>
                {% if run.search_terms | default([]) | length > 0 or run.actor_count | default(0) > 0 %}
                <span class="text-xs text-gray-400">
                    {{ run.search_terms | default([]) | length }} term{{ 's' if run.search_terms | default([]) | length != 1 else '' }}{% if run.actor_count | default(0) > 0 %}, {{ run.actor_count }} actor{{ 's' if run.actor_count | default(0) != 1 else '' }}{% endif %}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    {# Search terms summary — shown when terms are available on the run context #}
    {% if run.search_terms | default([]) | length > 0 %}
    <div class="bg-gray-50 border border-gray-200 rounded-lg px-5 py-3">
        <p class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Search terms used in this collection</p>
        <div class="flex flex-wrap gap-1.5">
            {% for term in run.search_terms %}
            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-white border border-gray-300 text-gray-700">
                {% if term.term_type | default('') %}
                <span class="text-gray-400 mr-1">{{ term.term_type }}:</span>
                {% endif %}
                {{ term.term | default(term) }}
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {#
        SSE container — wraps everything that receives live updates.
        hx-ext="sse" activates the HTMX SSE extension.
        sse-connect points to the streaming endpoint.
        sse-close="run_complete" closes the SSE connection when the server
        emits an event named 'run_complete'.

        The inner elements use hx-swap-oob, so HTMX routes each incoming HTML
        fragment to its target element by id rather than swapping innerHTML here.
    #}
    <div {% if not is_terminal %}
         hx-ext="sse"
         sse-connect="/collections/{{ run_id }}/stream"
         sse-close="run_complete"
         {% endif %}
         id="sse-container">

        {# Run summary card — updated via hx-swap-oob on run_update SSE events #}
        {% with run = run %}
            {% include '_fragments/run_summary.html' %}
        {% endwith %}

        {# ---- Records by Platform ------------------------------------------- #}
        {% if run.platform_counts | default({}) | length > 0 %}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-sm font-semibold text-gray-900">Records by Platform</h2>
            </div>
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                        <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for platform, count in run.platform_counts.items() | sort(attribute='1', reverse=true) %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 text-gray-700 capitalize">{{ platform | replace('_', ' ') }}</td>
                        <td class="px-6 py-3 text-right font-medium text-gray-900">{{ '{:,}'.format(count) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {# ---- Live Tracking Schedule panel --------------------------------- #}
        {#
            Only shown for live-mode runs. Fetches schedule info from
            GET /collections/{run_id}/schedule which returns:
              { mode, status, next_run_at, timezone, suspended_at }
        #}
        {% if is_live %}
        <div class="bg-white rounded-lg shadow px-6 py-5"
             x-data="liveSchedulePanel('{{ run_id }}', '{{ status }}')"
             x-init="init()">

            <div class="flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-sm font-semibold text-gray-900 mb-1">Live Tracking Schedule</h2>
                    <div x-show="loadingSchedule" class="text-xs text-gray-400 animate-pulse">
                        Loading schedule...
                    </div>
                    <div x-show="!loadingSchedule" class="space-y-1.5">
                        <p class="text-sm text-gray-700">
                            <span class="font-medium text-gray-500 text-xs uppercase tracking-wider">Next scheduled run:</span>
                            <span x-text="nextRunDisplay"
                                  class="ml-2 font-medium text-gray-900"></span>
                        </p>
                        <p x-show="suspendedAt" class="text-sm text-amber-700">
                            Suspended on
                            <span x-text="suspendedAt" class="font-medium"></span>
                        </p>
                    </div>
                </div>

                {# Status indicator badge #}
                <div x-show="!loadingSchedule" class="flex-shrink-0">
                    <span x-show="scheduleStatus === 'active'"
                          class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 inline-block"></span>
                        Active — collecting daily
                    </span>
                    <span x-show="scheduleStatus === 'suspended'"
                          class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                        <span class="w-1.5 h-1.5 rounded-full bg-amber-500 inline-block"></span>
                        Suspended — collection paused
                    </span>
                </div>
            </div>

            {# Suspend / Resume / Cancel controls #}
            {% if not is_terminal %}
            <div class="mt-4 flex flex-wrap items-center gap-2 pt-4 border-t border-gray-100">

                {# Suspend button — shown when active #}
                <button type="button"
                        x-show="scheduleStatus === 'active'"
                        hx-post="/collections/{{ run_id }}/suspend"
                        hx-confirm="Suspend this live tracking run? Collection will pause but your data will be preserved. You can resume at any time."
                        hx-target="#run-summary-card"
                        hx-swap="outerHTML"
                        @htmx:after-request="scheduleStatus = 'suspended'; suspendedAt = new Date().toLocaleDateString('en-GB')"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium
                               text-amber-700 border border-amber-300 bg-amber-50 rounded-md
                               hover:bg-amber-100 transition-colors">
                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6"/>
                    </svg>
                    Suspend Tracking
                </button>

                {# Resume button — shown when suspended #}
                <button type="button"
                        x-show="scheduleStatus === 'suspended'"
                        hx-post="/collections/{{ run_id }}/resume"
                        hx-confirm="Resume this live tracking run? Daily collection will restart from the next scheduled run."
                        hx-target="#run-summary-card"
                        hx-swap="outerHTML"
                        @htmx:after-request="scheduleStatus = 'active'; suspendedAt = null"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium
                               text-green-700 border border-green-300 bg-green-50 rounded-md
                               hover:bg-green-100 transition-colors">
                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    </svg>
                    Resume Tracking
                </button>

                {# Cancel & Delete — always visible for non-terminal live runs #}
                <button type="button"
                        hx-post="/collections/{{ run_id }}/cancel"
                        hx-confirm="Cancel and permanently delete this live tracking run? All collected data will be retained but the run cannot be restarted. This cannot be undone."
                        hx-target="#run-summary-card"
                        hx-swap="outerHTML"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium
                               text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors">
                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancel &amp; Delete Run
                </button>

                {# Inline explanation of suspend vs. cancel #}
                <span class="text-xs text-gray-400 ml-1">
                    Suspend pauses daily collection without deleting your data. Cancel permanently ends the run.
                </span>

            </div>
            {% endif %}

        </div>
        {% endif %}{# /is_live #}

        {# Per-arena task table #}
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                <h2 class="text-sm font-semibold text-gray-900">Arena Tasks</h2>
                {% if not is_terminal %}
                <div class="flex items-center gap-2">
                    {# Live indicator dot while running #}
                    <span class="inline-flex items-center gap-1.5 text-xs text-blue-600">
                        <svg class="w-2 h-2 text-blue-500 animate-pulse" xmlns="http://www.w3.org/2000/svg"
                             fill="currentColor" viewBox="0 0 8 8" aria-hidden="true">
                            <circle cx="4" cy="4" r="3"/>
                        </svg>
                        Live
                    </span>

                    {# For batch runs: show the standard cancel button here.
                       Live runs have their cancel button in the schedule panel above. #}
                    {% if not is_live %}
                    <button type="button"
                            hx-post="/collections/{{ run_id }}/cancel"
                            hx-confirm="Cancel this collection run?"
                            hx-target="#run-summary-card"
                            hx-swap="outerHTML"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-600 border border-red-200 rounded-md hover:bg-red-50 transition-colors">
                        <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none"
                             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancel run
                    </button>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {% if tasks %}
            <table class="min-w-full divide-y divide-gray-200 text-sm" id="tasks-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Arena</th>
                        <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                        <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Credits</th>
                        <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                        <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="tasks-tbody">
                    {% for task in tasks %}
                        {% include '_fragments/task_row.html' %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            {# Empty state: no tasks pre-loaded — will populate via SSE or HTMX poll #}
            <div class="px-6 py-12 text-center">
                {% if is_terminal %}
                    {% set empty_title = 'No task data available' %}
                    {% set empty_message = 'Task details were not recorded for this run.' %}
                    {% include '_partials/empty_state.html' %}
                {% else %}
                    <div class="flex flex-col items-center gap-3">
                        {% include '_partials/loading_spinner.html' %}
                        <p class="text-sm text-gray-400">Waiting for tasks to start...</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {# SB-03: Discovery Summary Panel (shown after enrichment completes) #}
        <div id="discovery-summary-panel"
             x-data="{ visible: false, suggestedTerms: 0, discoveredLinks: 0, telegramLinks: 0 }"
             x-show="visible"
             x-transition
             class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow border border-blue-200 px-6 py-5"
             style="display: none;">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <svg class="w-10 h-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-sm font-semibold text-gray-900 mb-2">Discovery Summary</h3>
                    <p class="text-sm text-gray-600 mb-3">
                        This collection run found new research opportunities:
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div class="bg-white rounded-lg px-4 py-3 border border-blue-100">
                            <div class="text-2xl font-bold text-blue-600" x-text="suggestedTerms"></div>
                            <div class="text-xs text-gray-500">Suggested terms</div>
                        </div>
                        <div class="bg-white rounded-lg px-4 py-3 border border-blue-100">
                            <div class="text-2xl font-bold text-blue-600" x-text="discoveredLinks"></div>
                            <div class="text-xs text-gray-500">Discovered links</div>
                        </div>
                        <div class="bg-white rounded-lg px-4 py-3 border border-blue-100" x-show="telegramLinks > 0">
                            <div class="text-2xl font-bold text-indigo-600" x-text="telegramLinks"></div>
                            <div class="text-xs text-gray-500">Telegram channels</div>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <a href="/analysis/{{ run_id }}"
                           class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700 transition-colors">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            View suggested terms
                        </a>
                        <a href="/content/discovered-links"
                           class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-white border border-gray-300 text-gray-700 text-xs font-medium rounded-md hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                            </svg>
                            View discovered links
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# Post-run actions (shown when terminal) #}
        {% if is_terminal %}
        <div class="flex items-center justify-between bg-white rounded-lg shadow px-6 py-4">
            <div class="text-sm text-gray-500">
                {% if status == 'completed' %}
                    Collection finished. Explore the collected content below.
                {% elif status == 'failed' %}
                    This run encountered errors. Check the task table above for details.
                    {% if run.records_collected | default(0) | int > 0 %}
                    <span class="text-green-600 font-medium">Some data was collected before the failure.</span>
                    {% endif %}
                {% else %}
                    This run was cancelled.
                {% endif %}
            </div>
            <div class="flex gap-3">
                {% if run.records_collected | default(0) | int > 0 %}
                <a href="/analysis/{{ run_id }}"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 transition-colors">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Analyse Collected Data
                </a>
                {% endif %}
                {% if status == 'completed' %}
                <button type="button"
                        hx-post="/collections/{{ run_id }}/refresh-engagement"
                        hx-confirm="Refresh engagement metrics for this collection run? This will update like counts, view counts, and other engagement data."
                        hx-swap="none"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh Engagement
                </button>
                <button type="button"
                        hx-post="/collections/{{ run_id }}/enrich"
                        hx-confirm="Run enrichment pipeline on this collection? This will apply language detection, named entity extraction, sentiment analysis, and coordination detection to all collected content."
                        hx-swap="none"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    Run Enrichments
                </button>
                <button type="button"
                        hx-post="/content/deduplicate?run_id={{ run_id }}"
                        hx-confirm="Run deduplication on this collection? This will identify and mark duplicate records using URL normalization and content hashing."
                        hx-swap="none"
                        class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Run Deduplication
                </button>
                <a href="/content?run_id={{ run_id }}"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                    </svg>
                    Browse content
                </a>
                {% endif %}
                <a href="/collections/new?design_id={{ run.query_design_id | default('') }}"
                   class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Run again
                </a>
            </div>
        </div>
        {% endif %}

    </div>{# /sse-container #}

</div>

<script>
// ---- SB-03: Discovery Summary SSE Handler ---------------------------------
// Listen for discovery_summary events emitted after enrichment completes.
document.addEventListener('DOMContentLoaded', () => {
    const discoveryPanel = document.getElementById('discovery-summary-panel');
    if (!discoveryPanel) return;

    // Listen for SSE messages via HTMX's custom event
    document.body.addEventListener('htmx:sseMessage', (event) => {
        if (!event.detail || !event.detail.data) return;

        try {
            const data = JSON.parse(event.detail.data);

            // Check if this is a discovery_summary event
            if (data.event === 'discovery_summary') {
                // Update Alpine data model
                Alpine.store('discovery', {
                    suggestedTerms: data.suggested_terms || 0,
                    discoveredLinks: data.discovered_links || 0,
                    telegramLinks: data.telegram_links || 0
                });

                // Show the panel via Alpine
                const alpineData = Alpine.$data(discoveryPanel);
                if (alpineData) {
                    alpineData.suggestedTerms = data.suggested_terms || 0;
                    alpineData.discoveredLinks = data.discovered_links || 0;
                    alpineData.telegramLinks = data.telegram_links || 0;
                    alpineData.visible = true;
                }
            }
        } catch (err) {
            console.warn('Failed to parse discovery summary SSE event:', err);
        }
    });
});

// ---- Live schedule panel Alpine component ---------------------------------
// Fetches GET /collections/{runId}/schedule and exposes schedule state.
// Also reacts to HTMX suspend/resume requests to update the badge optimistically.
function liveSchedulePanel(runId, initialStatus) {
    return {
        runId,
        // scheduleStatus mirrors run.status but is also updated optimistically
        // when the researcher clicks Suspend or Resume before the page reloads.
        scheduleStatus: initialStatus,
        loadingSchedule: false,
        nextRunDisplay: '—',
        suspendedAt: null,

        async init() {
            this.loadingSchedule = true;
            try {
                const res = await fetch(`/collections/${runId}/schedule`, {
                    credentials: 'include',
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                // Update schedule status from the server — supersedes the
                // template-injected initial value once the fetch completes.
                if (data.status) this.scheduleStatus = data.status;

                // Format next run timestamp with timezone context.
                if (data.next_run_at) {
                    const tz = data.timezone || 'Europe/Copenhagen';
                    try {
                        const d = new Date(data.next_run_at);
                        this.nextRunDisplay = d.toLocaleString('en-GB', {
                            timeZone: tz,
                            dateStyle: 'medium',
                            timeStyle: 'short',
                        }) + ' (' + tz + ')';
                    } catch {
                        this.nextRunDisplay = data.next_run_at;
                    }
                } else {
                    // Fallback: communicate the known fixed schedule.
                    this.nextRunDisplay = 'Daily at midnight Copenhagen time (00:00 CET/CEST)';
                }

                // suspended_at comes as an ISO string or null.
                if (data.suspended_at) {
                    try {
                        const sd = new Date(data.suspended_at);
                        this.suspendedAt = sd.toLocaleDateString('en-GB', {
                            dateStyle: 'medium',
                        });
                    } catch {
                        this.suspendedAt = data.suspended_at;
                    }
                }
            } catch {
                // Non-fatal: show the static fallback schedule text.
                this.nextRunDisplay = 'Daily at midnight Copenhagen time (00:00 CET/CEST)';
            } finally {
                this.loadingSchedule = false;
            }
        },
    };
}
</script>
{% endblock %}
