{% extends "base.html" %}
{% block title %}Start Collection{% endblock %}

{% block content %}
{#
    Collection run launcher with pre-flight credit estimate.
    The Alpine component debounces form changes (400ms) and triggers
    HTMX to fetch a credit estimate from GET /collections/estimate.

    Context:
        - projects (list): user's projects [{id, name, qd_count}]
        - query_designs (list): owned query designs [{id, name, default_tier, project_id}]
        - preselected_design_id (str|None): from ?design_id= query param
        - preselected_project_id (str|None): from ?project_id= query param
#}
{% set projects = projects | default([]) %}
{% set query_designs = query_designs | default([]) %}
{% set preselected = preselected_design_id | default(request.query_params.get('design_id', '')) %}
{% set preselected_project = preselected_project_id | default(request.query_params.get('project_id', '')) %}

<div class="max-w-4xl mx-auto space-y-6"
     x-data="collectionLauncher({{ available_credits | default(0) }}, '{{ preselected_project }}')"
     x-init="init()">

    {# Page header #}
    <div class="flex items-center gap-3">
        <a href="/collections"
           class="text-gray-400 hover:text-gray-600 transition-colors"
           aria-label="Back to collections">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-xl font-bold text-gray-900">Start New Collection</h1>
    </div>

    <div class="grid grid-cols-5 gap-6">
        {# Left: Configuration form #}
        <div class="col-span-3 space-y-5">

            {# Configuration card #}
            <div class="bg-white rounded-lg shadow p-6 space-y-5">
                <h2 class="text-sm font-semibold text-gray-900 border-b border-gray-200 pb-3">Configuration</h2>

                {#
                    POST to /collections/project-form to create and start the run.
                    On 201 Created the server sets HX-Redirect to /collections/{run_id}.
                    On error it returns a form fragment to replace this block.
                #}
                <form id="launcher-form"
                      method="POST"
                      action="/collections/project-form"
                      @change="onFormChange()"
                      @submit="onSubmit($event)">

                    {# Project selector #}
                    <div class="mb-4">
                        <label for="project_id" class="block text-sm font-medium text-gray-700 mb-1">
                            Project <span class="text-red-500">*</span>
                        </label>
                        {% if projects %}
                        <select id="project_id"
                                name="project_id"
                                required
                                x-model="projectId"
                                @change="onProjectChange()"
                                class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="">Select a project...</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}"
                                    {% if project.id == preselected_project %}selected{% endif %}>
                                {{ project.name | default('(untitled)') }}
                                ({{ project.qd_count }} design{{ 's' if project.qd_count != 1 else '' }})
                            </option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <div class="rounded-md bg-yellow-50 border border-yellow-200 px-4 py-3 text-sm text-yellow-800">
                            No projects yet.
                            <a href="/projects/new" class="font-medium underline">Create a project</a>
                            to start a collection.
                        </div>
                        {% endif %}
                    </div>

                    {# Query designs from selected project — read-only list #}
                    <div x-show="projectId" x-cloak class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Query Designs in Project
                        </label>
                        <div class="rounded-md bg-gray-50 border border-gray-200 px-4 py-3">
                            <div x-show="filteredDesigns.length === 0" class="text-sm text-gray-400 italic">
                                No query designs in this project yet.
                            </div>
                            <ul x-show="filteredDesigns.length > 0" class="text-sm text-gray-700 space-y-1">
                                <template x-for="design in filteredDesigns" :key="design.id">
                                    <li class="flex items-center gap-2">
                                        <svg class="w-3 h-3 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                        <span x-text="design.name"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>

                    {# Arena preview — shows combined enabled arenas across all designs in project #}
                    <div x-show="projectId && filteredDesigns.length > 0" x-cloak class="mb-4">
                        <div class="rounded-md bg-gray-50 border border-gray-200 px-4 py-3">
                            <p class="text-xs font-medium text-gray-700 mb-2">Enabled arenas across project designs:</p>
                            <div x-show="loadingArenas" class="flex items-center gap-2 text-xs text-gray-400 py-1.5">
                                <svg class="animate-spin w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg"
                                     fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                                </svg>
                                Loading arenas...
                            </div>
                            <div x-show="!loadingArenas && combinedArenas.length > 0" class="flex flex-wrap gap-1.5">
                                <template x-for="arena in combinedArenas" :key="arena.id + '-' + arena.tier">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800"
                                          x-text="_humanizeArena(arena.id) + ' (' + arena.tier + ')'"></span>
                                </template>
                            </div>
                            <div x-show="!loadingArenas && combinedArenas.length === 0" class="text-xs text-gray-400 italic">
                                No arenas configured on any query design in this project.
                            </div>
                        </div>

                        {#
                            Actor-only guidance for Facebook and Instagram.
                            Shown when either arena appears in the combined enabled arena list.
                            These platforms collect via actors only — search terms are ignored.
                        #}
                        <div x-show="!loadingArenas && hasActorOnlyArenas"
                             x-cloak
                             class="mt-2 rounded-md bg-amber-50 border border-amber-200 px-4 py-3">
                            <div class="flex gap-2">
                                <svg class="w-4 h-4 text-amber-600 flex-shrink-0 mt-0.5" xmlns="http://www.w3.org/2000/svg"
                                     fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <div>
                                    <p class="text-xs font-medium text-amber-800">
                                        <span x-text="actorOnlyArenaNames.join(' and ')"></span>
                                        collect via actors only
                                    </p>
                                    <p class="text-xs text-amber-700 mt-0.5">
                                        Keyword search is not supported for
                                        <span x-text="actorOnlyArenaNames.join(' or ')"></span>.
                                        Search terms in your query design will be skipped for
                                        <span x-text="actorOnlyArenaNames.length === 1 ? 'this arena' : 'these arenas'"></span>.
                                        Add Facebook pages/groups or Instagram profiles in the
                                        <a href="/actors" class="underline font-medium hover:text-amber-900">Actor Directory</a>
                                        to collect from
                                        <span x-text="actorOnlyArenaNames.length === 1 ? 'it' : 'them'"></span>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# Mode toggle: batch vs live #}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Collection Mode</label>
                        <div class="flex rounded-md border border-gray-300 overflow-hidden">
                            <label class="flex-1">
                                <input type="radio" name="mode" value="batch"
                                       x-model="mode" @change="requestEstimate()"
                                       class="sr-only">
                                <div :class="mode === 'batch' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                                     class="text-center px-4 py-2 text-sm font-medium cursor-pointer transition-colors select-none">
                                    Batch (historical)
                                </div>
                            </label>
                            <label class="flex-1 border-l border-gray-300">
                                <input type="radio" name="mode" value="live"
                                       x-model="mode" @change="requestEstimate()"
                                       class="sr-only">
                                <div :class="mode === 'live' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
                                     class="text-center px-4 py-2 text-sm font-medium cursor-pointer transition-colors select-none">
                                    Live (ongoing)
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-400 mt-1"
                           x-text="mode === 'batch'
                               ? 'Collect data for a specific time period.'
                               : 'Runs automatically every day at midnight Copenhagen time (CET/CEST).'">
                        </p>
                    </div>

                    {# Date range — only shown in batch mode #}
                    <div x-show="mode === 'batch'" x-transition class="mb-4 space-y-3">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="date_from" class="block text-sm font-medium text-gray-700 mb-1">
                                    From date
                                </label>
                                <input type="date"
                                       id="date_from"
                                       name="date_from"
                                       x-model="dateFrom"
                                       @change="requestEstimate()"
                                       class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="date_to" class="block text-sm font-medium text-gray-700 mb-1">
                                    To date
                                </label>
                                <input type="date"
                                       id="date_to"
                                       name="date_to"
                                       x-model="dateTo"
                                       @change="requestEstimate()"
                                       class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        {#
                            IP2-023: Per-arena date range coverage notes.
                            Helps researchers set realistic date ranges for each arena type.
                        #}
                        <div class="rounded-md bg-blue-50 border border-blue-100 px-4 py-3 space-y-1.5">
                            <p class="text-xs font-medium text-blue-800 mb-2">Date range coverage by arena</p>
                            <dl class="grid grid-cols-1 gap-y-1 text-xs text-blue-700 sm:grid-cols-2">
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">RSS Feeds:</dt>
                                    <dd class="text-blue-600">Real-time only — typically last 24-48 hours of articles.</dd>
                                </div>
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">GDELT:</dt>
                                    <dd class="text-blue-600">Historical coverage available — years of data.</dd>
                                </div>
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">Bluesky:</dt>
                                    <dd class="text-blue-600">Last 30 days via search API.</dd>
                                </div>
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">Reddit:</dt>
                                    <dd class="text-blue-600">Recent posts via API (up to 1,000 per subreddit).</dd>
                                </div>
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">YouTube:</dt>
                                    <dd class="text-blue-600">Search results are recent — no guaranteed date range.</dd>
                                </div>
                                <div class="flex gap-1.5">
                                    <dt class="font-medium whitespace-nowrap">Google Search:</dt>
                                    <dd class="text-blue-600">Recent results only.</dd>
                                </div>
                            </dl>
                            <p class="text-xs text-blue-500 mt-1 pt-1 border-t border-blue-100">
                                Coverage limits depend on each arena's underlying API. Setting a wider date range than an arena supports will not cause errors — the arena simply collects what is available.
                            </p>
                        </div>
                    </div>

                    {# Tier selector #}
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Collection Tier
                        </label>
                        <div class="grid grid-cols-3 gap-3">
                            {% for tier_value, tier_label, tier_desc, tier_color in [
                                ('free',    'Free',    'Free data sources only. 0 credits for most arenas.', 'green'),
                                ('medium',  'Medium',  'Includes low-cost API services. Costs credits.', 'yellow'),
                                ('premium', 'Premium', 'Best available data quality. Highest credit usage.', 'purple'),
                            ] %}
                            <label class="cursor-pointer">
                                <input type="radio" name="tier" value="{{ tier_value }}"
                                       x-model="tier" @change="requestEstimate()"
                                       class="sr-only">
                                <div :class="tier === '{{ tier_value }}'
                                             ? 'border-{{ tier_color }}-500 bg-{{ tier_color }}-50 ring-2 ring-{{ tier_color }}-300'
                                             : 'border-gray-200 hover:border-gray-300 bg-white'"
                                     class="border rounded-lg p-3 transition-all">
                                    <div class="text-sm font-medium text-gray-900 mb-0.5">{{ tier_label }}</div>
                                    <div class="text-xs text-gray-500">{{ tier_desc }}</div>
                                </div>
                            </label>
                            {% endfor %}
                        </div>

                        {# YF-09: Tier precedence explanation #}
                        <details class="mt-3" x-data="{ open: false }" x-modelable="open" x-model="open">
                            <summary class="cursor-pointer text-xs text-blue-600 hover:text-blue-800 select-none">
                                Which tier will be used?
                            </summary>
                            <div class="mt-2 rounded-md bg-blue-50 border border-blue-100 px-4 py-3 space-y-2">
                                <p class="text-xs text-blue-900 font-medium">
                                    Tier precedence (highest priority first)
                                </p>
                                <ol class="text-xs text-blue-700 space-y-1 list-decimal list-inside ml-1">
                                    <li><strong>Per-arena settings</strong> in the query design (if configured)</li>
                                    <li><strong>Global tier</strong> selected above (this form)</li>
                                    <li><strong>Query design default</strong> (as fallback)</li>
                                </ol>
                                <div id="tier-overrides-summary" x-show="projectId" class="pt-2 border-t border-blue-200">
                                    <p class="text-xs text-blue-900 font-medium mb-1.5">
                                        Per-arena overrides for selected design
                                    </p>
                                    <div class="text-xs text-blue-600" id="tier-overrides-content">
                                        <p class="italic text-blue-400">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>

                    {# F1: Pre-launch collection summary #}
                    <div x-show="projectId && (termCount > 0 || actorCount > 0 || enabledArenaCount > 0)"
                         x-cloak
                         x-transition
                         class="mb-4 rounded-md bg-blue-50 border border-blue-200 px-4 py-3">
                        <p class="text-sm text-blue-900">
                            Collection scope:
                            <span x-show="enabledArenaCount > 0">
                                <strong x-text="enabledArenaCount"></strong> arena<span x-show="enabledArenaCount !== 1">s</span>
                            </span>
                            <span x-show="enabledArenaCount > 0 && (termCount > 0 || actorCount > 0)">,</span>
                            <span x-show="termCount > 0">
                                <strong x-text="termCount"></strong> search term<span x-show="termCount !== 1">s</span>
                            </span>
                            <span x-show="termCount > 0 && actorCount > 0">,</span>
                            <span x-show="actorCount > 0">
                                <strong x-text="actorCount"></strong> actor<span x-show="actorCount !== 1">s</span>
                            </span>
                        </p>
                    </div>

                    {# Launch button — disabled when credits are insufficient or no project selected #}
                    <div class="pt-4 border-t border-gray-200 flex items-center justify-between">
                        <a href="/collections" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
                        <button type="submit"
                                :disabled="!canLaunch || launching || !projectId"
                                :title="!canLaunch ? 'Insufficient credits' : (!projectId ? 'Select a project' : '')"
                                class="inline-flex items-center gap-2 px-5 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <svg x-show="launching" class="animate-spin w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                                 fill="none" viewBox="0 0 24 24" aria-hidden="true">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                            </svg>
                            <svg x-show="!launching" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg"
                                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                      d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span x-text="launching ? 'Starting...' : 'Start Collection'">Start Collection</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {# Right: Pre-flight estimate panel #}
        <div class="col-span-2">
            <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-gray-900">Credit Estimate</h2>
                    {# Spinner shown while HTMX fetches the estimate #}
                    <span id="estimate-spinner" class="htmx-indicator">
                        <svg class="animate-spin w-4 h-4 text-blue-600" xmlns="http://www.w3.org/2000/svg"
                             fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                        </svg>
                    </span>
                </div>

                {#
                    Estimate panel — HTMX replaces the contents of this div.
                    `requestEstimate()` in Alpine triggers:
                      htmx.trigger('#estimate-trigger', 'estimate')
                    which fires the GET with form state as query params.
                #}
                <div id="estimate-panel">
                    <p class="text-sm text-gray-400 italic">
                        Select a query design and tier to see an estimate.
                    </p>
                </div>

                {# Hidden HTMX trigger element — decoupled from the visible form #}
                <span id="estimate-trigger"
                      hx-post="/collections/estimate"
                      hx-trigger="estimate"
                      hx-target="#estimate-panel"
                      hx-swap="innerHTML"
                      hx-indicator="#estimate-spinner"
                      hx-include="#launcher-form">
                </span>
            </div>
        </div>

    </div>
</div>

<script>
/**
 * Convert a snake_case arena ID to a human-readable label.
 */
function _humanizeArena(name) {
    const labels = {
        'google_search': 'Google Search', 'google_autocomplete': 'Google Autocomplete',
        'bluesky': 'Bluesky', 'reddit': 'Reddit', 'youtube': 'YouTube',
        'rss_feeds': 'RSS Feeds', 'gdelt': 'GDELT', 'telegram': 'Telegram',
        'tiktok': 'TikTok', 'ritzau_via': 'Via Ritzau', 'gab': 'Gab',
        'event_registry': 'Event Registry', 'x_twitter': 'X / Twitter',
        'facebook': 'Facebook', 'instagram': 'Instagram', 'threads': 'Threads',
        'common_crawl': 'Common Crawl', 'wayback': 'Wayback Machine',
        'url_scraper': 'URL Scraper', 'wikipedia': 'Wikipedia', 'discord': 'Discord',
        'ai_chat_search': 'AI Chat Search', 'majestic': 'Majestic',
        'twitch': 'Twitch', 'vkontakte': 'VKontakte',
    };
    return labels[name] || name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
}

/**
 * Alpine component for the collection launcher (project-based).
 *
 * Responsibilities:
 *  - Track form state (projectId, mode, tier, dateFrom, dateTo).
 *  - Filter query designs by selected project.
 *  - Fetch and display combined arena config across all designs in project.
 *  - Debounce changes and fire HTMX estimate requests via htmx.trigger().
 *  - Receive the estimated credits from the rendered fragment via a custom
 *    event dispatched by the fragment itself (see _fragments/credit_estimate.html).
 *  - Gate the launch button when estimatedCredits > availableCredits.
 */
function collectionLauncher(availableCredits, preselectedProjectId) {
    // All query designs from backend (server-rendered)
    const allDesigns = [
        {% for design in query_designs %}
        {
            id: '{{ design.id }}',
            name: '{{ design.name | default("(untitled)") | replace("'", "\\'") }}',
            projectId: '{{ design.project_id | default("") }}',
            termCount: {{ design.term_count | default(0) }},
            actorCount: {{ design.actor_count | default(0) }},
        },
        {% endfor %}
    ];

    return {
        // Form state
        projectId: preselectedProjectId || '',
        mode: 'batch',
        tier: 'free',
        dateFrom: '',
        dateTo: '',

        // Filtered query designs (computed from projectId)
        filteredDesigns: [],

        // Combined arena config across all designs in project
        combinedArenas: [],
        loadingArenas: false,

        // Platforms that collect via actors only (no keyword search support).
        // Used to surface guidance when these arenas are selected in the project.
        _ACTOR_ONLY_PLATFORMS: ['facebook', 'instagram'],

        // F1: Pre-launch summary counts
        termCount: 0,
        actorCount: 0,
        enabledArenaCount: 0,

        // Credit tracking
        availableCredits: availableCredits,
        estimatedCredits: 0,
        isEstimating: false,
        launching: false,

        // Debounce timer handle
        _estimateTimer: null,

        /** True when the user can safely launch. */
        get canLaunch() {
            return this.estimatedCredits <= this.availableCredits;
        },

        /**
         * Returns the human-readable names of any actor-only arenas in the
         * combined enabled arena list (Facebook, Instagram).
         */
        get actorOnlyArenaNames() {
            const labels = { facebook: 'Facebook', instagram: 'Instagram' };
            const ids = new Set(this.combinedArenas.map(a => a.id));
            return this._ACTOR_ONLY_PLATFORMS
                .filter(p => ids.has(p))
                .map(p => labels[p] || p);
        },

        /** True when at least one actor-only arena is enabled in the project. */
        get hasActorOnlyArenas() {
            return this.actorOnlyArenaNames.length > 0;
        },

        init() {
            // If a project was pre-selected via query param, trigger the filter
            if (this.projectId) {
                this.$nextTick(() => {
                    this.onProjectChange();
                });
            }

            // Listen for estimated credit value from the rendered fragment.
            // The fragment dispatches 'estimate:result' with { credits, sufficient }
            // so Alpine can update the launch button state without parsing the DOM.
            document.addEventListener('estimate:result', (evt) => {
                this.estimatedCredits = evt.detail.credits || 0;
                this.availableCredits = evt.detail.availableCredits || this.availableCredits;
            });
        },

        /**
         * Called when project selection changes.
         * Filters query designs, fetches combined arena config, and resets estimate.
         */
        onProjectChange() {
            // Filter designs by selected project
            this.filteredDesigns = allDesigns.filter(d => d.projectId === this.projectId);

            // Reset arena and count state
            this.combinedArenas = [];
            this.termCount = 0;
            this.actorCount = 0;
            this.enabledArenaCount = 0;

            if (this.projectId && this.filteredDesigns.length > 0) {
                // Compute aggregated counts across all designs
                this.termCount = this.filteredDesigns.reduce((sum, d) => sum + d.termCount, 0);
                this.actorCount = this.filteredDesigns.reduce((sum, d) => sum + d.actorCount, 0);

                // Load combined arena config
                this.loadCombinedArenaConfig();
            }

            // Reset estimate
            this.requestEstimate();
        },

        /**
         * Fetch arena configs for all designs in the selected project and merge them.
         * Combines all enabled arenas with their tiers.
         */
        async loadCombinedArenaConfig() {
            if (!this.projectId || this.filteredDesigns.length === 0) {
                this.combinedArenas = [];
                return;
            }

            this.loadingArenas = true;

            try {
                // Fetch arena configs for all designs in parallel
                const configPromises = this.filteredDesigns.map(d =>
                    fetch(`/query-designs/${d.id}/arena-config`)
                        .then(r => r.ok ? r.json() : { arenas: [] })
                        .catch(() => ({ arenas: [] }))
                );

                const configs = await Promise.all(configPromises);

                // Merge all enabled arenas, de-duplicate by platform + tier
                const arenaMap = new Map();
                for (const config of configs) {
                    const arenas = config.arenas || [];
                    for (const arena of arenas) {
                        if (arena.enabled) {
                            const key = `${arena.id}|${arena.tier}`;
                            if (!arenaMap.has(key)) {
                                arenaMap.set(key, arena);
                            }
                        }
                    }
                }

                this.combinedArenas = Array.from(arenaMap.values());
                this.enabledArenaCount = this.combinedArenas.length;

            } catch (err) {
                console.error('Failed to load combined arena config:', err);
                this.combinedArenas = [];
            } finally {
                this.loadingArenas = false;
            }
        },

        onFormChange() {
            this.requestEstimate();
        },

        /**
         * Debounced HTMX estimate trigger.
         * Waits 400ms after the last change before firing the request.
         */
        requestEstimate() {
            if (!this.projectId) return;
            clearTimeout(this._estimateTimer);
            this._estimateTimer = setTimeout(() => {
                htmx.trigger(document.getElementById('estimate-trigger'), 'estimate');
            }, 400);
        },

        onSubmit(event) {
            if (!this.canLaunch || !this.projectId) {
                event.preventDefault();
                return;
            }
            this.launching = true;
        },
    };
}
</script>
{% endblock %}
