{% extends "base.html" %}
{% block title %}{{ actor.name | default('Actor') }} — Issue Observatory{% endblock %}

{% block content %}
{#
    Actor profile page — Task 1.17.
    Shows: identity card, platform presences, content timeline (HTMX-paginated).
    Edit actor metadata via Alpine modal → PATCH /api/actors/{id}.

    Context:
        - actor (dict): {id, name, type, description, created_at, content_count}
        - presences (list): [{id, platform, username, profile_url, follower_count, verified, last_checked}]
        - recent_content (list): initial page of content records by this actor
        - content_cursor (str|None): pagination cursor
#}
{% set actor = actor | default({}) %}
{% set presences = presences | default([]) %}
{% set recent_content = recent_content | default([]) %}
{% set content_cursor = content_cursor | default('') %}
{% set actor_id = actor.id | default('') %}

<div class="max-w-4xl mx-auto space-y-6"
     x-data="actorProfile()">

    {# Back navigation #}
    <div class="flex items-center gap-3">
        <a href="/actors"
           class="text-gray-400 hover:text-gray-600 transition-colors"
           aria-label="Back to actor directory">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
        </a>
        <h1 class="text-xl font-bold text-gray-900">Actor Profile</h1>
    </div>

    {# Edit actor modal #}
    <div x-show="editOpen"
         x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
         @keydown.escape.window="editOpen = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6" @click.stop
             x-data="{ publicFigure: {{ 'true' if actor.public_figure | default(false) else 'false' }} }">
            <div class="flex items-center justify-between mb-5">
                <h2 class="text-base font-semibold text-gray-900">Edit Actor</h2>
                <button @click="editOpen = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form method="POST"
                  action="/actors/{{ actor_id }}/edit"
                  hx-patch="/actors/{{ actor_id }}"
                  hx-target="#actor-profile-card"
                  hx-swap="outerHTML"
                  hx-on::after-request="if(event.detail.successful){ editOpen = false; }"
                  class="space-y-4">

                <div>
                    <label for="edit_name" class="block text-sm font-medium text-gray-700 mb-1">
                        Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="edit_name" name="name" required
                           value="{{ actor.name | default('') }}"
                           class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="edit_type" class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="edit_type" name="type"
                            class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="person"       {% if actor.type | default('') == 'person' %}selected{% endif %}>Person</option>
                        <option value="organisation" {% if actor.type | default('') == 'organisation' %}selected{% endif %}>Organisation</option>
                        <option value="media_outlet" {% if actor.type | default('') == 'media_outlet' %}selected{% endif %}>Media outlet</option>
                        <option value="account"      {% if actor.type | default('') == 'account' %}selected{% endif %}>Account</option>
                    </select>
                </div>

                <div>
                    <label for="edit_description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="edit_description" name="description" rows="3"
                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none">{{ actor.description | default('') }}</textarea>
                </div>

                {# Public Figure toggle — GR-14 GDPR Art. 89(1) exemption #}
                <div class="pt-3 border-t border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="block text-sm font-medium text-gray-700">Public Figure</span>
                            <span class="block text-xs text-gray-500 mt-0.5 max-w-xs">
                                Stores real username in collected content. Use only for elected officials
                                and public appointees acting in official capacity.
                            </span>
                        </div>
                        <button type="button"
                                @click="publicFigure = !publicFigure"
                                :class="publicFigure ? 'bg-amber-500' : 'bg-gray-200'"
                                class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer
                                       rounded-full border-2 border-transparent transition-colors
                                       duration-200 ease-in-out focus:outline-none focus:ring-2
                                       focus:ring-amber-400 focus:ring-offset-1"
                                role="switch"
                                :aria-checked="publicFigure.toString()"
                                aria-label="Public figure toggle">
                            <span :class="publicFigure ? 'translate-x-4' : 'translate-x-0'"
                                  class="pointer-events-none inline-block h-4 w-4 transform
                                         rounded-full bg-white shadow transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>

                    {# Hidden input so the value is submitted with the form #}
                    <input type="hidden" name="public_figure" :value="publicFigure ? 'true' : 'false'">

                    {# GDPR warning — visible only when toggle is ON #}
                    <div x-show="publicFigure"
                         x-cloak
                         class="mt-3 flex items-start gap-2 rounded-md border border-amber-200 bg-amber-50 px-3 py-2.5">
                        <svg class="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0"
                             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                  d="M12 9v2m0 4h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        </svg>
                        <p class="text-xs text-amber-800 leading-relaxed">
                            <span class="font-semibold">GDPR Notice:</span>
                            Enabling this bypasses anonymization for this actor's collected content.
                            Only use for public political figures (ministers, MPs, officials) making statements
                            in their official capacity. Private individuals must remain anonymized.
                            The research institution's DPO should periodically review the public figure list.
                        </p>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-200 flex justify-between">
                    <button type="button" @click="editOpen = false"
                            class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                    <button type="submit"
                            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                        Save changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    {# Actor identity card #}
    <div id="actor-profile-card" class="bg-white rounded-lg shadow p-6">
        <div class="flex items-start justify-between gap-4">
            <div class="flex items-center gap-4">
                {# Avatar initials #}
                <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center text-lg font-bold flex-shrink-0">
                    {{ (actor.name or '?')[0] | upper }}
                </div>
                <div>
                    <div class="flex items-center gap-2">
                        <h2 class="text-lg font-bold text-gray-900">{{ actor.name | default('Unknown') }}</h2>
                        {% if actor.public_figure | default(false) %}
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-semibold bg-amber-100 text-amber-800"
                              title="Public Figure — pseudonymization bypassed (GDPR Art. 89(1))">
                            PF
                        </span>
                        {% endif %}
                    </div>
                    <div class="flex items-center gap-2 mt-1">
                        {# Type badge #}
                        {% set atype = actor.type | default('account') %}
                        {% if atype == 'person' %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Person</span>
                        {% elif atype == 'organisation' %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">Organisation</span>
                        {% elif atype == 'media_outlet' %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">Media outlet</span>
                        {% else %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">Account</span>
                        {% endif %}
                        <span class="text-xs text-gray-400">
                            {{ actor.content_count | default(0) }} content record{% if actor.content_count | default(0) != 1 %}s{% endif %}
                        </span>
                    </div>
                    {% if actor.description | default('') %}
                    <p class="text-sm text-gray-600 mt-2 max-w-lg">{{ actor.description }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
                <a href="/content?actor_id={{ actor_id }}"
                   class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                    </svg>
                    Browse content
                </a>
                <button type="button"
                        @click="editOpen = true"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors">
                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                         stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit
                </button>
            </div>
        </div>

        {# Meta row #}
        <div class="mt-4 pt-4 border-t border-gray-100 flex items-center gap-6 text-xs text-gray-400">
            <span class="font-mono">{{ actor_id | truncate(8, true, '') }}</span>
            {% if actor.created_at | default('') %}
            <span>Added {{ actor.created_at | truncate(10, true, '') }}</span>
            {% endif %}
        </div>
    </div>

    {# Platform presences #}
    <div id="presences" class="bg-white rounded-lg shadow overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 class="text-sm font-semibold text-gray-900">Platform Presences</h2>
            <button type="button"
                    @click="addPresenceOpen = true"
                    class="inline-flex items-center gap-1.5 text-xs text-blue-600 hover:text-blue-800 px-2 py-1 rounded hover:bg-blue-50 transition-colors">
                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                     stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                </svg>
                Add presence
            </button>
        </div>

        {# Add presence modal #}
        <div x-show="addPresenceOpen"
             x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
             @keydown.escape.window="addPresenceOpen = false">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4 p-6" @click.stop>
                <div class="flex items-center justify-between mb-5">
                    <h2 class="text-base font-semibold text-gray-900">Add Platform Presence</h2>
                    <button @click="addPresenceOpen = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                             stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <form method="POST"
                      action="/actors/{{ actor_id }}/presences"
                      hx-post="/actors/{{ actor_id }}/presences"
                      hx-target="#presences-tbody"
                      hx-swap="beforeend"
                      hx-on::after-request="if(event.detail.successful){ addPresenceOpen = false; this.reset(); }"
                      class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pres_platform" class="block text-sm font-medium text-gray-700 mb-1">
                                Platform <span class="text-red-500">*</span>
                            </label>
                            <select id="pres_platform" name="platform" required
                                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="">Select...</option>
                                <option value="bluesky">Bluesky</option>
                                <option value="reddit">Reddit</option>
                                <option value="youtube">YouTube</option>
                                <option value="telegram">Telegram</option>
                                <option value="tiktok">TikTok</option>
                                <option value="twitter">Twitter/X</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="gab">Gab</option>
                                <option value="linkedin">LinkedIn</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="pres_username" class="block text-sm font-medium text-gray-700 mb-1">
                                Username <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="pres_username" name="username" required
                                   placeholder="@handle or channel ID"
                                   class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="pres_url" class="block text-sm font-medium text-gray-700 mb-1">Profile URL</label>
                        <input type="url" id="pres_url" name="profile_url"
                               placeholder="https://..."
                               class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="pt-4 border-t border-gray-200 flex justify-between">
                        <button type="button" @click="addPresenceOpen = false"
                                class="text-sm text-gray-500 hover:text-gray-700">Cancel</button>
                        <button type="submit"
                                class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                            Add Presence
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if presences %}
        <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th>
                    <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                    <th class="text-right px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Followers</th>
                    <th class="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider">Profile</th>
                    <th class="px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100" id="presences-tbody">
                {% for pres in presences %}
                <tr class="hover:bg-gray-50" id="presence-row-{{ pres.id }}">
                    <td class="px-6 py-3">
                        <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-700 capitalize">
                            {{ pres.platform | default('') }}
                        </span>
                    </td>
                    <td class="px-6 py-3 text-sm text-gray-900">
                        {{ pres.username | default('') }}
                        {% if pres.verified | default(false) %}
                        <span class="text-blue-500" title="Verified">
                            <svg class="inline w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                 fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-3 text-right text-xs font-mono text-gray-500">
                        {% if pres.follower_count | default(0) > 0 %}
                            {{ pres.follower_count | int }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                    <td class="px-6 py-3">
                        {% if pres.profile_url | default('') %}
                        <a href="{{ pres.profile_url }}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="text-xs text-blue-600 hover:text-blue-800 truncate block max-w-xs">
                            {{ pres.profile_url | truncate(40) }}
                        </a>
                        {% else %}
                        <span class="text-xs text-gray-300">—</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-3 text-right">
                        <button type="button"
                                hx-delete="/actors/{{ actor_id }}/presences/{{ pres.id }}"
                                hx-target="#presence-row-{{ pres.id }}"
                                hx-swap="outerHTML"
                                hx-confirm="Remove this platform presence?"
                                class="text-xs text-red-500 hover:text-red-700 px-2 py-1 rounded hover:bg-red-50 transition-colors">
                            Remove
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div id="presences-tbody" class="px-6 py-8 text-center">
            <p class="text-sm text-gray-400">No platform presences linked yet. Add one above.</p>
        </div>
        {% endif %}
    </div>

    {# Content timeline #}
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
            <h2 class="text-sm font-semibold text-gray-900">Content Timeline</h2>
            <a href="/content?actor_id={{ actor_id }}"
               class="text-xs text-blue-600 hover:text-blue-800">View all</a>
        </div>

        {% if recent_content %}
        <ul class="divide-y divide-gray-100" id="actor-content-list">
            {% for record in recent_content %}
            <li class="px-6 py-3 hover:bg-gray-50 transition-colors">
                <div class="flex items-start justify-between gap-3">
                    <div class="flex items-center gap-2 min-w-0">
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 flex-shrink-0">
                            {{ record.platform | default('') | capitalize }}
                        </span>
                        <a href="/content/{{ record.id }}"
                           class="text-sm text-gray-900 hover:text-blue-600 truncate">
                            {% if record.title | default('') %}
                                {{ record.title | truncate(80) }}
                            {% else %}
                                {{ record.text | default('(no content)') | truncate(80) }}
                            {% endif %}
                        </a>
                    </div>
                    <span class="text-xs text-gray-400 flex-shrink-0">
                        {{ record.published_at | default('') | truncate(10, true, '') }}
                    </span>
                </div>
            </li>
            {% endfor %}

            {# Infinite scroll for content timeline #}
            {% if content_cursor %}
            <li id="content-scroll-sentinel"
                hx-get="/actors/{{ actor_id }}/content?cursor={{ content_cursor }}"
                hx-trigger="revealed"
                hx-target="#actor-content-list"
                hx-swap="beforeend"
                hx-indicator="#content-spinner"
                class="px-6 py-3 text-center">
                <span id="content-spinner" class="htmx-indicator">
                    {% include '_partials/loading_spinner.html' %}
                </span>
            </li>
            {% endif %}
        </ul>
        {% else %}
        {% set empty_title = 'No content collected yet' %}
        {% set empty_message = 'Content from this actor will appear here after collection runs.' %}
        {% include '_partials/empty_state.html' %}
        {% endif %}
    </div>

    {# Discover Similar — GR-18 #}
    <div class="bg-white rounded-lg shadow overflow-hidden"
         x-data="discoverSimilar('{{ actor_id }}')">

        {# Collapsible header #}
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 cursor-pointer select-none"
             @click="open = !open">
            <h2 class="text-sm font-semibold text-gray-900">Discover Similar Actors</h2>
            <svg class="w-4 h-4 text-gray-400 transition-transform"
                 :class="open ? 'rotate-180' : ''"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>

        <div x-show="open" x-cloak class="p-6 space-y-6">

            {# ---- Sub-tabs ---- #}
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex gap-4" aria-label="Similarity discovery tabs">
                    <button type="button"
                            @click="activeTab = 'platform'"
                            :class="activeTab === 'platform'
                                ? 'border-blue-500 text-blue-600'
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-xs transition-colors">
                        Platform Suggestions
                    </button>
                    <button type="button"
                            @click="activeTab = 'content'"
                            :class="activeTab === 'content'
                                ? 'border-blue-500 text-blue-600'
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-xs transition-colors">
                        Content Similar
                    </button>
                    <button type="button"
                            @click="activeTab = 'crossplatform'"
                            :class="activeTab === 'crossplatform'
                                ? 'border-blue-500 text-blue-600'
                                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="whitespace-nowrap pb-3 px-1 border-b-2 font-medium text-xs transition-colors">
                        Cross-Platform Search
                    </button>
                </nav>
            </div>

            {# ---- Tab: Platform Suggestions ---- #}
            <div x-show="activeTab === 'platform'" x-cloak class="space-y-4">
                <p class="text-xs text-gray-500">
                    Find accounts similar to this actor using platform-native recommendation APIs
                    (Bluesky suggested follows, Reddit shared subreddits, YouTube related playlists).
                </p>

                <div>
                    <p class="text-xs font-medium text-gray-700 mb-2">Platforms to search:</p>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="psim-bluesky"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="platformSims.includes('bluesky')"
                                   @change="togglePlatformSim('bluesky')">
                            Bluesky
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="psim-reddit"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="platformSims.includes('reddit')"
                                   @change="togglePlatformSim('reddit')">
                            Reddit
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="psim-youtube"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="platformSims.includes('youtube')"
                                   @change="togglePlatformSim('youtube')">
                            YouTube
                        </label>
                    </div>
                </div>

                <button type="button"
                        hx-post="/actors/{{ actor_id }}/similar/platform"
                        hx-headers='{"Content-Type": "application/json"}'
                        :hx-vals="JSON.stringify({platforms: platformSims, max_results: 20})"
                        hx-target="#sim-platform-results"
                        hx-swap="innerHTML"
                        hx-indicator="#sim-platform-spinner"
                        :disabled="platformSims.length === 0"
                        class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                    <span id="sim-platform-spinner" class="htmx-indicator">
                        <svg class="animate-spin w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </span>
                    Find Similar
                </button>

                <div id="sim-platform-results" class="min-h-[40px]">
                    <p class="text-xs text-gray-400">Select platforms and click "Find Similar" to discover recommendations.</p>
                </div>
            </div>

            {# ---- Tab: Content Similar ---- #}
            <div x-show="activeTab === 'content'" x-cloak class="space-y-4">
                <p class="text-xs text-gray-500">
                    Find actors whose collected content covers similar topics to this actor,
                    using TF-IDF cosine similarity over post text.  Requires collected content.
                </p>

                <div class="flex items-center gap-4">
                    <label class="text-xs font-medium text-gray-700 flex-shrink-0" for="csim-min-sim">
                        Min similarity:
                    </label>
                    <input type="range" id="csim-min-sim"
                           min="0" max="1" step="0.05"
                           x-model="contentMinSim"
                           class="flex-1 h-1.5 accent-blue-600">
                    <span class="text-xs font-mono text-gray-500 w-10 text-right" x-text="Math.round(contentMinSim * 100) + '%'"></span>
                </div>

                <button type="button"
                        hx-post="/actors/{{ actor_id }}/similar/content"
                        hx-headers='{"Content-Type": "application/json"}'
                        :hx-vals="JSON.stringify({max_results: 20, min_similarity: parseFloat(contentMinSim)})"
                        hx-target="#sim-content-results"
                        hx-swap="innerHTML"
                        hx-indicator="#sim-content-spinner"
                        class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50 transition-colors">
                    <span id="sim-content-spinner" class="htmx-indicator">
                        <svg class="animate-spin w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </span>
                    Find Similar
                </button>

                <div id="sim-content-results" class="min-h-[40px]">
                    <p class="text-xs text-gray-400">Click "Find Similar" to discover actors posting about similar topics.</p>
                </div>
            </div>

            {# ---- Tab: Cross-Platform Search ---- #}
            <div x-show="activeTab === 'crossplatform'" x-cloak class="space-y-4">
                <p class="text-xs text-gray-500">
                    Search for this actor's name on other platforms to discover accounts
                    they may control.  Results are ranked by name similarity.
                </p>

                <div>
                    <p class="text-xs font-medium text-gray-700 mb-2">Platforms to search:</p>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="xsim-bluesky"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="crossPlatforms.includes('bluesky')"
                                   @change="toggleCrossPlatform('bluesky')">
                            Bluesky
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="xsim-reddit"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="crossPlatforms.includes('reddit')"
                                   @change="toggleCrossPlatform('reddit')">
                            Reddit
                        </label>
                        <label class="flex items-center gap-2 text-sm text-gray-700 cursor-pointer">
                            <input type="checkbox" id="xsim-youtube"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                   :checked="crossPlatforms.includes('youtube')"
                                   @change="toggleCrossPlatform('youtube')">
                            YouTube
                        </label>
                    </div>
                </div>

                <button type="button"
                        hx-post="/actors/{{ actor_id }}/similar/cross-platform"
                        hx-headers='{"Content-Type": "application/json"}'
                        :hx-vals="JSON.stringify({platforms: crossPlatforms, max_results: 10})"
                        hx-target="#sim-cross-results"
                        hx-swap="innerHTML"
                        hx-indicator="#sim-cross-spinner"
                        :disabled="crossPlatforms.length === 0"
                        class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50 transition-colors disabled:opacity-40 disabled:cursor-not-allowed">
                    <span id="sim-cross-spinner" class="htmx-indicator">
                        <svg class="animate-spin w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </span>
                    Search Platforms
                </button>

                <div id="sim-cross-results" class="min-h-[40px]">
                    <p class="text-xs text-gray-400">Select platforms and click "Search Platforms" to find matching accounts.</p>
                </div>
            </div>

        </div>
    </div>

    {# Entity Resolution — Task 3.9 #}
    <div class="bg-white rounded-lg shadow overflow-hidden"
         x-data="entityResolution('{{ actor_id }}', '{{ actor.name | default('') | replace("'", "\\'") }}')">

        {# Collapsible header #}
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 cursor-pointer select-none"
             @click="open = !open">
            <h2 class="text-sm font-semibold text-gray-900">Entity Resolution</h2>
            <svg class="w-4 h-4 text-gray-400 transition-transform"
                 :class="open ? 'rotate-180' : ''"
                 xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                 stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
            </svg>
        </div>

        <div x-show="open" x-cloak class="p-6 space-y-6">

            {# ---- Find duplicates ---- #}
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Find Possible Duplicates</h3>
                    <button type="button"
                            hx-get="/actors/{{ actor_id }}/candidates"
                            hx-target="#candidates-container"
                            hx-swap="innerHTML"
                            hx-indicator="#candidates-spinner"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-blue-600 border border-blue-200 rounded-md hover:bg-blue-50 transition-colors">
                        <span id="candidates-spinner" class="htmx-indicator">
                            <svg class="animate-spin w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </span>
                        Search for duplicates
                    </button>
                </div>
                <div id="candidates-container"
                     @merge-actor.window="mergeCandidate($event.detail.duplicate_id)"
                     class="min-h-[40px]">
                    <p class="text-xs text-gray-400">Click the button above to search for actors that may be the same entity.</p>
                </div>
            </div>

            {# ---- Split section ---- #}
            <div class="pt-4 border-t border-gray-200">
                <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-3">Split Actor</h3>
                <p class="text-xs text-gray-500 mb-4">
                    Select platform presences to move to a new actor record.
                    This is useful when one canonical actor entry was incorrectly created for two distinct real-world entities.
                </p>

                {% if presences %}
                <form @submit.prevent="splitSelected($event)">
                    <div class="space-y-2 mb-4">
                        {% for pres in presences %}
                        <label class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 rounded px-2 py-1">
                            <input type="checkbox"
                                   name="presence_ids"
                                   value="{{ pres.id }}"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">
                                <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 mr-1">{{ pres.platform | default('') }}</span>
                                {{ pres.username | default('') }}
                            </span>
                        </label>
                        {% endfor %}
                    </div>

                    <div class="flex items-end gap-3">
                        <div class="flex-1">
                            <label for="split_name" class="block text-xs font-medium text-gray-700 mb-1">New actor name</label>
                            <input type="text"
                                   id="split_name"
                                   name="new_canonical_name"
                                   placeholder="Canonical name for the new actor"
                                   class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit"
                                class="inline-flex items-center gap-1.5 px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 transition-colors flex-shrink-0">
                            Split selected
                        </button>
                    </div>
                </form>
                {% else %}
                <p class="text-xs text-gray-400">No platform presences to split. Add presences first.</p>
                {% endif %}

                {# Split result message #}
                <div x-show="splitResult" x-cloak class="mt-3 p-3 rounded bg-green-50 border border-green-200">
                    <p class="text-sm text-green-800" x-text="splitResult"></p>
                </div>
            </div>

        </div>
    </div>

</div>

<script>
function actorProfile() {
    return {
        editOpen: false,
        addPresenceOpen: false,
    };
}

function discoverSimilar(actorId) {
    return {
        open: false,
        activeTab: 'platform',
        // Platform suggestions tab
        platformSims: ['bluesky', 'reddit', 'youtube'],
        togglePlatformSim(platform) {
            const idx = this.platformSims.indexOf(platform);
            if (idx === -1) {
                this.platformSims.push(platform);
            } else {
                this.platformSims.splice(idx, 1);
            }
        },
        // Content similarity tab
        contentMinSim: 0.3,
        // Cross-platform tab
        crossPlatforms: ['bluesky', 'reddit', 'youtube'],
        toggleCrossPlatform(platform) {
            const idx = this.crossPlatforms.indexOf(platform);
            if (idx === -1) {
                this.crossPlatforms.push(platform);
            } else {
                this.crossPlatforms.splice(idx, 1);
            }
        },
    };
}

function entityResolution(actorId, actorName) {
    return {
        open: false,
        splitResult: '',

        async mergeCandidate(duplicateId) {
            const candidateName = document.querySelector(
                `[data-candidate-id="${duplicateId}"]`
            )?.dataset?.candidateName || 'this actor';
            if (!confirm(`Merge ${candidateName} into ${actorName}? This cannot be undone.`)) {
                return;
            }
            try {
                const resp = await fetch(`/actors/${actorId}/merge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duplicate_ids: [duplicateId] }),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    alert('Merge failed: ' + (err.detail || resp.statusText));
                    return;
                }
                const data = await resp.json();
                alert(`Merge complete. ${data.records_updated} content record(s) updated.`);
                // Refresh candidates list
                htmx.trigger('#candidates-container button[hx-get]', 'click');
            } catch (e) {
                alert('Merge failed: ' + e.message);
            }
        },

        async splitSelected(event) {
            const form = event.target;
            const checkedBoxes = Array.from(form.querySelectorAll('input[name="presence_ids"]:checked'));
            if (checkedBoxes.length === 0) {
                alert('Select at least one platform presence to split.');
                return;
            }
            const newName = form.querySelector('input[name="new_canonical_name"]').value.trim();
            if (!newName) {
                alert('Enter a canonical name for the new actor.');
                return;
            }
            if (!confirm(`Split ${checkedBoxes.length} presence(s) into a new actor "${newName}"? This cannot be undone.`)) {
                return;
            }
            try {
                const resp = await fetch(`/actors/${actorId}/split`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        presence_ids: checkedBoxes.map(cb => cb.value),
                        new_canonical_name: newName,
                    }),
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    alert('Split failed: ' + (err.detail || resp.statusText));
                    return;
                }
                const data = await resp.json();
                this.splitResult = `Split complete. New actor created (${data.new_actor_id.slice(0, 8)}…). ${data.presences_moved} presence(s) moved, ${data.records_updated} content record(s) updated.`;
                // Uncheck all boxes
                checkedBoxes.forEach(cb => { cb.checked = false; });
                form.querySelector('input[name="new_canonical_name"]').value = '';
            } catch (e) {
                alert('Split failed: ' + e.message);
            }
        },
    };
}
</script>
{% endblock %}
