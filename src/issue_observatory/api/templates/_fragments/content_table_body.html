{#
    HTMX fragment: content browser table body rows.

    Rendered by GET /content/records and appended into #records-tbody via
    hx-swap="beforeend".

    Context:
        records       (list[dict]) — page of content records, each dict has:
            id, platform, arena, content_type, title, text, author,
            published_at, engagement_score, search_terms_matched (list[str])
        next_cursor   (str)  — opaque keyset cursor for the next page, or ""
        new_offset    (int)  — cumulative rows sent so far (after this page)
        browse_cap    (int)  — hard cap (2000)
#}
{% for record in records %}
<tr class="hover:bg-blue-50/40 cursor-pointer transition-colors"
    id="record-row-{{ record.id }}"
    hx-get="/content/{{ record.id }}"
    hx-target="#detail-panel-inner"
    hx-swap="innerHTML"
    hx-on::after-request="document.querySelector('[x-data]').__x.$data.showDetail = true"
    @click="openDetail('{{ record.id }}')"
    :class="selectedId === '{{ record.id }}' ? 'bg-blue-50 border-l-2 border-blue-500' : ''">

    {# Platform badge #}
    <td class="px-4 py-3 whitespace-nowrap">
        <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium
            {% set p = record.platform | default('') %}
            {% if p == 'youtube' %}bg-red-100 text-red-800
            {% elif p == 'reddit' %}bg-orange-100 text-orange-800
            {% elif p == 'bluesky' %}bg-sky-100 text-sky-800
            {% elif p == 'telegram' %}bg-blue-100 text-blue-800
            {% elif p == 'tiktok' %}bg-slate-100 text-slate-800
            {% elif p == 'gab' %}bg-green-100 text-green-800
            {% else %}bg-gray-100 text-gray-700{% endif %}">
            {{ record.platform | default('—') | capitalize }}
        </span>
        {% if record.content_type | default('') %}
        <span class="block text-xs text-gray-400 font-mono mt-0.5">{{ record.content_type }}</span>
        {% endif %}
    </td>

    {# Title / text excerpt #}
    <td class="px-4 py-3 max-w-xs">
        {% if record.title | default('') %}
            <p class="font-medium text-gray-900 truncate text-xs">{{ record.title | truncate(80) }}</p>
            {% if record.text | default('') %}
            <p class="text-gray-400 truncate text-xs mt-0.5">{{ record.text | truncate(80) }}</p>
            {% endif %}
        {% else %}
            <p class="text-gray-700 truncate text-xs">{{ record.text | default('(no content)') | truncate(100) }}</p>
        {% endif %}
        {# Search terms matched chips #}
        {% if record.search_terms_matched | default([]) | length > 0 %}
        <div class="flex flex-wrap gap-1 mt-1">
            {% for term in record.search_terms_matched[:3] %}
            <span class="inline-flex px-1.5 py-0 rounded text-xs font-medium bg-blue-50 text-blue-600 border border-blue-100">
                {{ term | truncate(20, true, '…') }}
            </span>
            {% endfor %}
            {% if record.search_terms_matched | length > 3 %}
            <span class="text-xs text-gray-400">+{{ record.search_terms_matched | length - 3 }}</span>
            {% endif %}
        </div>
        {% endif %}
    </td>

    {# Author #}
    <td class="px-4 py-3 text-xs text-gray-600 whitespace-nowrap hidden lg:table-cell">
        {{ record.author | default('—') | truncate(24, true, '…') }}
    </td>

    {# Published at (relative-style: show date only) #}
    <td class="px-4 py-3 text-xs text-gray-500 whitespace-nowrap hidden md:table-cell">
        {{ record.published_at | default('') | truncate(10, true, '') }}
    </td>

    {# Arena #}
    <td class="px-4 py-3 hidden xl:table-cell">
        <span class="text-xs text-gray-400 font-mono">{{ record.arena | default('') }}</span>
    </td>

    {# Engagement score + detail link #}
    <td class="px-4 py-3 text-right text-xs font-mono text-gray-500 whitespace-nowrap hidden md:table-cell">
        {% set eng = record.engagement_score | default(0) | int %}
        {% if eng > 0 %}
            <span class="{% if eng > 1000 %}text-blue-700 font-medium{% elif eng > 100 %}text-gray-700{% else %}text-gray-400{% endif %}">
                {{ eng }}
            </span>
        {% else %}
            <span class="text-gray-300">—</span>
        {% endif %}
        <a href="/content/{{ record.id }}"
           class="ml-2 text-gray-300 hover:text-blue-500 transition-colors"
           title="Full page"
           @click.stop>
            <svg class="inline w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
            </svg>
        </a>
    </td>
</tr>
{% endfor %}

{#
    Infinite scroll sentinel — hx-trigger="revealed" fires when the element
    scrolls into view.  Not rendered when the row cap has been reached.
#}
{% if next_cursor and new_offset < browse_cap %}
<tr id="scroll-sentinel"
    hx-get="/content/records?cursor={{ next_cursor }}&offset={{ new_offset }}"
    hx-trigger="revealed"
    hx-target="#records-tbody"
    hx-swap="beforeend"
    hx-include="#filter-form"
    hx-indicator="#table-spinner"
    x-show="rowCount < {{ browse_cap }}">
    <td colspan="6" class="px-4 py-4 text-center text-xs text-gray-400">
        Loading more…
    </td>
</tr>
{% endif %}
