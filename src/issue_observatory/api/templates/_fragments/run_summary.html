{#
    HTMX / SSE fragment: collection run-level summary card.

    Streamed via SSE and swapped into #run-summary-card using `hx-swap-oob`.
    Also rendered inline at page load from the initial context.

    Context:
        - run (dict):
            - id (str):                  run UUID
            - status (str):              'pending' | 'running' | 'completed' | 'failed' | 'cancelled'
            - query_design_name (str, optional)
            - tier (str):                'free' | 'medium' | 'premium'
            - mode (str):                'batch' | 'live'
            - records_collected (int, optional): total across all arenas
            - credits_spent (int, optional)
            - tasks_total (int, optional)
            - tasks_done (int, optional):  succeeded + failed
            - tasks_running (int, optional)
            - started_at (str, optional)
            - finished_at (str, optional)
#}
{% set run = run | default({}) %}
{% set status = run.status | default('pending') %}
{% set tasks_total = run.tasks_total | default(0) | int %}
{% set tasks_done  = run.tasks_done  | default(0) | int %}

<div id="run-summary-card" hx-swap-oob="true"
     class="bg-white rounded-lg shadow p-6 space-y-4">

    {# Header row: status badge + run metadata #}
    <div class="flex items-start justify-between gap-4">
        <div>
            <h2 class="text-base font-semibold text-gray-900">
                {{ run.query_design_name | default('Collection Run') }}
            </h2>
            <p class="text-xs text-gray-500 mt-0.5">
                {% if run.mode | default('batch') == 'live' %}Live{% else %}Batch{% endif %}
                &mdash;
                {% set tier = run.tier | default('free') %}
                {% if tier == 'free' %}
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Free</span>
                {% elif tier == 'medium' %}
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Medium</span>
                {% else %}
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">Premium</span>
                {% endif %}
            </p>
        </div>

        {# Status badge #}
        {% if status == 'running' %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <svg class="animate-spin w-3 h-3" xmlns="http://www.w3.org/2000/svg"
                     fill="none" viewBox="0 0 24 24" aria-hidden="true">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                </svg>
                Running
            </span>
        {% elif status == 'completed' %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                </svg>
                Completed
            </span>
        {% elif status == 'failed' %}
            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                Failed
            </span>
        {% elif status == 'cancelled' %}
            <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Cancelled</span>
        {% else %}
            <span class="inline-flex px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-500">Pending</span>
        {% endif %}
    </div>

    {# Progress bar (only shown while running) #}
    {% if status == 'running' and tasks_total > 0 %}
    <div>
        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
            <span>{{ tasks_done }} / {{ tasks_total }} arenas finished</span>
            <span>{{ ((tasks_done / tasks_total) * 100) | round(0) | int }}%</span>
        </div>
        <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
            <div class="h-2 bg-blue-500 rounded-full transition-all duration-500"
                 style="width: {{ ((tasks_done / tasks_total) * 100) | round(0) | int }}%">
            </div>
        </div>
    </div>
    {% endif %}

    {# Summary stats grid #}
    <div class="grid grid-cols-3 gap-4 pt-2 border-t border-gray-100">
        <div>
            <p class="text-xs text-gray-500">Records</p>
            <p class="text-lg font-bold text-gray-900 mt-0.5">
                {{ run.records_collected | default(0) | int }}
            </p>
        </div>
        <div>
            <p class="text-xs text-gray-500">Credits used</p>
            <p class="text-lg font-bold text-gray-900 mt-0.5">
                {{ run.credits_spent | default(0) }}
            </p>
        </div>
        <div>
            <p class="text-xs text-gray-500">Started</p>
            <p class="text-sm font-medium text-gray-700 mt-0.5">
                {{ run.started_at | default('â€”') | truncate(16, true, '') }}
                {% if run.started_at | default('') %}
                <span class="text-xs text-gray-400">(UTC)</span>
                {% endif %}
            </p>
        </div>
    </div>

</div>
