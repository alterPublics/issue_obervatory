{% extends "base.html" %}
{% block title %}Live Tracking{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6" x-data="liveTrackingPage()">

    {# Page header #}
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-xl font-bold text-gray-900">Live Tracking</h1>
            <p class="text-sm text-gray-500 mt-0.5">Manage daily automated collections</p>
        </div>
    </div>

    {# ========== Data Timeline ========== #}
    <script>
        window.__timelineProjects = {{ projects | tojson }};
        window.__timelineDesigns = {{ all_designs | tojson }};
    </script>
    <div class="bg-white rounded-lg shadow overflow-hidden" x-data="dataTimeline()">
        <div class="px-6 py-4">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Data Timeline</h2>
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <span x-show="totalRecords > 0" x-text="totalRecords.toLocaleString() + ' records'"></span>
                    <span x-show="dateRange" x-text="dateRange" class="text-gray-400"></span>
                </div>
            </div>

            {# Filter row #}
            <div class="flex flex-wrap items-center gap-3 mb-4">
                <div class="flex items-center gap-1.5">
                    <label class="text-xs font-medium text-gray-500">Project:</label>
                    <select x-model="selectedProject" @change="onProjectChange()"
                            class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All projects</option>
                        <template x-for="p in projects" :key="p.id">
                            <option :value="p.id" x-text="p.name"></option>
                        </template>
                    </select>
                </div>

                <div class="flex items-center gap-1.5">
                    <label class="text-xs font-medium text-gray-500">Design:</label>
                    <select x-model="selectedDesign" @change="fetchVolume()"
                            class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All designs</option>
                        <template x-for="d in filteredDesigns" :key="d.id">
                            <option :value="d.id" x-text="d.name"></option>
                        </template>
                    </select>
                </div>

                <div class="flex items-center gap-1.5">
                    <label class="text-xs font-medium text-gray-500">Arena:</label>
                    <select x-model="selectedArena" @change="fetchVolume()"
                            class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All arenas</option>
                        <template x-for="a in availableArenas" :key="a">
                            <option :value="a" x-text="a"></option>
                        </template>
                    </select>
                </div>

                <div class="flex items-center gap-1.5">
                    <label class="text-xs font-medium text-gray-500">Time range:</label>
                    <select x-model="timeRange" @change="onTimeRangeChange()"
                            class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="180">Last 6 months</option>
                        <option value="365">Last year</option>
                        <option value="all">All time</option>
                    </select>
                </div>

                <div class="flex items-center gap-1.5">
                    <label class="text-xs font-medium text-gray-500">Granularity:</label>
                    <select x-model="granularity" @change="fetchVolume()"
                            class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                    </select>
                </div>

                <span x-show="loading" class="text-xs text-gray-400">Loading...</span>
            </div>

            {# Chart canvas #}
            <div class="h-72">
                <canvas id="data-timeline-chart"></canvas>
            </div>
            <p x-show="noData && !loading && !fetchError" class="text-sm text-gray-400 text-center py-8">
                No volume data available yet. Run a collection to see data here.
            </p>
            <p x-show="fetchError && !loading" class="text-sm text-red-500 text-center py-8"
               x-text="fetchError"></p>
        </div>
    </div>

    {# ========== Section A: Active Tracking ========== #}
    {% if active_tracking %}
    <div class="space-y-4">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Active Tracking</h2>

        {% for item in active_tracking %}
        <div class="bg-white rounded-lg shadow overflow-hidden"
             x-data="liveTrackingCard('{{ item.design_id }}', '{{ item.run_id }}', '{{ item.status }}', {{ item.enabled_arenas | tojson }})">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 min-w-0">
                        <a href="/query-designs/{{ item.design_id }}"
                           class="text-base font-semibold text-gray-900 hover:text-blue-600 truncate">
                            {{ item.design_name }}
                        </a>

                        {# Status badge #}
                        {% if item.status == 'active' %}
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 flex-shrink-0">
                                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                                Active
                            </span>
                        {% elif item.status == 'suspended' %}
                            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800 flex-shrink-0">
                                Suspended
                            </span>
                        {% else %}
                            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 flex-shrink-0">
                                {{ item.status | capitalize }}
                            </span>
                        {% endif %}
                    </div>

                    {# Action buttons #}
                    <div class="flex items-center gap-2 flex-shrink-0">
                        {% if item.status == 'active' %}
                            <button hx-post="/collections/{{ item.run_id }}/suspend"
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) window.location.reload()"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-amber-700 bg-amber-50 border border-amber-200 rounded-md hover:bg-amber-100 transition-colors">
                                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Suspend
                            </button>
                        {% elif item.status == 'suspended' %}
                            <button hx-post="/collections/{{ item.run_id }}/resume"
                                    hx-swap="none"
                                    hx-on::after-request="if(event.detail.successful) window.location.reload()"
                                    class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-green-700 bg-green-50 border border-green-200 rounded-md hover:bg-green-100 transition-colors">
                                <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                </svg>
                                Resume
                            </button>
                        {% endif %}

                        <button hx-post="/collections/{{ item.run_id }}/cancel"
                                hx-swap="none"
                                hx-confirm="Stop live tracking for {{ item.design_name }}? This cannot be undone."
                                hx-on::after-request="if(event.detail.successful) window.location.reload()"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-md hover:bg-red-100 transition-colors">
                            <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                            </svg>
                            Stop
                        </button>

                        {# Timeline toggle #}
                        <button @click="showTimeline = !showTimeline"
                                class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-50 border border-gray-200 rounded-md hover:bg-gray-100 transition-colors">
                            <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span x-text="showTimeline ? 'Hide Timeline' : 'Timeline'"></span>
                        </button>
                    </div>
                </div>

                {# Stats row #}
                <div class="flex items-center gap-6 mt-3 text-sm text-gray-500">
                    <span class="flex items-center gap-1">
                        <svg class="w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        {{ '{:,}'.format(item.total_design_records | int) }} records
                        {% if item.records_collected and item.records_collected != item.total_design_records %}
                            <span class="text-xs text-gray-400">({{ item.records_collected | int }} from live run)</span>
                        {% endif %}
                    </span>
                    <span class="text-xs text-gray-400">{{ item.tier | upper }} tier</span>
                    {% if item.started_at %}
                        <span class="text-xs text-gray-400">Since {{ item.started_at.strftime('%Y-%m-%d') if item.started_at else 'N/A' }}</span>
                    {% endif %}
                    <span class="text-xs text-gray-400">Daily at 00:00 CET (Europe/Copenhagen)</span>
                </div>

                {# Arena badges #}
                {% if item.enabled_arenas %}
                <div class="flex flex-wrap gap-1.5 mt-2">
                    {% for arena in item.enabled_arenas[:12] %}
                    <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700">
                        {{ arena }}
                    </span>
                    {% endfor %}
                    {% if item.enabled_arenas | length > 12 %}
                    <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-500">
                        +{{ item.enabled_arenas | length - 12 }} more
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            {# Expandable timeline #}
            <div x-show="showTimeline" x-collapse x-cloak class="border-t border-gray-100">
                <div class="px-6 py-4" x-data="liveTrackingTimeline('{{ item.design_id }}')">
                    {# Arena filter #}
                    <div class="flex items-center gap-3 mb-3">
                        <label class="text-xs font-medium text-gray-500">Filter by arena:</label>
                        <select x-model="selectedArena" @change="fetchVolume()"
                                class="text-xs border-gray-300 rounded-md shadow-sm py-1 px-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All arenas</option>
                            {% for arena in item.enabled_arenas %}
                            <option value="{{ arena }}">{{ arena }}</option>
                            {% endfor %}
                        </select>
                        <span x-show="loading" class="text-xs text-gray-400">Loading...</span>
                    </div>
                    {# Chart canvas #}
                    <div class="h-64">
                        <canvas :id="'timeline-chart-' + designId"></canvas>
                    </div>
                    <p x-show="noData && !loading" class="text-sm text-gray-400 text-center py-8">
                        No volume data available yet.
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {# ========== Section B: Available for Live Tracking ========== #}
    {% if available_designs or ready_designs %}
    <div class="space-y-4">
        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Available for Live Tracking</h2>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Design Name</th>
                        <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Last Data</th>
                        <th class="text-left px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Gap</th>
                        <th class="text-right px-6 py-3 font-medium text-gray-500 uppercase tracking-wider text-xs">Records</th>
                        <th class="px-6 py-3"><span class="sr-only">Actions</span></th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for design in available_designs + ready_designs %}
                    <tr class="hover:bg-gray-50 transition-colors"
                        x-data="{ confirming: false }">
                        <td class="px-6 py-4">
                            <a href="/query-designs/{{ design.design_id }}"
                               class="font-medium text-gray-900 hover:text-blue-600">
                                {{ design.design_name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-gray-500 text-xs">
                            {{ design.last_data_date or 'None' }}
                        </td>
                        <td class="px-6 py-4">
                            {% if design.gap_label == 'Up to date' %}
                                <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">{{ design.gap_label }}</span>
                            {% elif design.gap_label == 'No data' %}
                                <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600">{{ design.gap_label }}</span>
                            {% else %}
                                <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">{{ design.gap_label }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right text-gray-700 font-mono text-xs">
                            {{ design.total_records | int }}
                        </td>
                        <td class="px-6 py-4 text-right">
                            {# Confirmation step #}
                            <template x-if="!confirming">
                                <button @click="confirming = true"
                                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100 transition-colors">
                                    <svg class="w-3.5 h-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                                    </svg>
                                    Start Live Tracking
                                </button>
                            </template>
                            <template x-if="confirming">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs text-gray-500">
                                        {% if design.gap_days > 0 %}
                                            Will backfill {{ design.gap_days }} day{{ 's' if design.gap_days != 1 else '' }}.
                                        {% elif design.gap_label == 'No data' %}
                                            Will collect yesterday's data first.
                                        {% else %}
                                            No gap to fill.
                                        {% endif %}
                                        Start?
                                    </span>
                                    <form method="post" action="/live-tracking/start" class="inline">
                                        <input type="hidden" name="query_design_id" value="{{ design.design_id }}">
                                        <button type="submit"
                                                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                                            Confirm
                                        </button>
                                    </form>
                                    <button @click="confirming = false"
                                            class="inline-flex items-center px-2 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-700 transition-colors">
                                        Cancel
                                    </button>
                                </div>
                            </template>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {# ========== Section C: Empty state ========== #}
    {% if not active_tracking and not available_designs and not ready_designs %}
    <div class="bg-white rounded-lg shadow px-6 py-12 text-center">
        <svg class="mx-auto w-12 h-12 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h3 class="mt-4 text-base font-semibold text-gray-900">No designs available for live tracking</h3>
        <p class="mt-2 text-sm text-gray-500">
            Create a query design with arena configuration, then run a batch collection or start live tracking directly.
        </p>
        <a href="/query-designs/new"
           class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
            Create Query Design
        </a>
    </div>
    {% endif %}

</div>

<script>
/**
 * Top-level Alpine component for the live tracking page.
 */
function liveTrackingPage() {
    return {};
}

/**
 * Data Timeline Alpine component â€” always-visible volume chart at page top.
 * Data is passed via window.__timelineProjects / window.__timelineDesigns
 * (set in a <script> tag) to avoid tojson double-quote issues in x-data attributes.
 */
function dataTimeline() {
    return {
        projects: window.__timelineProjects || [],
        allDesigns: window.__timelineDesigns || [],
        selectedProject: '',
        selectedDesign: '',
        selectedArena: '',
        timeRange: '7',
        granularity: 'day',
        loading: false,
        noData: false,
        fetchError: '',
        chart: null,
        totalRecords: 0,
        dateRange: '',
        availableArenas: [],

        get filteredDesigns() {
            if (!this.selectedProject) return this.allDesigns;
            return this.allDesigns.filter(d => d.project_id === this.selectedProject);
        },

        init() {
            this.fetchVolume();
        },

        onProjectChange() {
            // If current design doesn't belong to new project, reset it
            if (this.selectedDesign) {
                const match = this.filteredDesigns.find(d => d.id === this.selectedDesign);
                if (!match) this.selectedDesign = '';
            }
            this.fetchVolume();
        },

        onTimeRangeChange() {
            // Auto-adjust granularity based on time range
            if (this.timeRange === '30') {
                this.granularity = 'day';
            } else if (this.timeRange === '90' || this.timeRange === '180') {
                if (this.granularity === 'month') this.granularity = 'week';
            } else if (this.timeRange === '365' || this.timeRange === 'all') {
                if (this.granularity === 'day') this.granularity = 'week';
            }
            this.fetchVolume();
        },

        async fetchVolume() {
            this.loading = true;
            this.noData = false;
            this.fetchError = '';

            let url;
            if (this.selectedDesign) {
                url = '/analysis/design/' + this.selectedDesign + '/volume';
            } else if (this.selectedProject) {
                url = '/analysis/project/' + this.selectedProject + '/volume';
            } else {
                url = '/analysis/volume';
            }

            const params = new URLSearchParams();
            params.set('granularity', this.granularity);
            params.set('delta_mode', 'true');
            if (this.selectedArena) params.set('platform', this.selectedArena);
            if (this.timeRange !== 'all') {
                const days = parseInt(this.timeRange, 10);
                const from = new Date();
                from.setDate(from.getDate() - days);
                params.set('date_from', from.toISOString().slice(0, 19));
            }
            url += '?' + params.toString();

            try {
                const resp = await fetch(url, { credentials: 'include' });
                if (!resp.ok) {
                    const text = await resp.text().catch(() => '');
                    console.error('Timeline fetch error:', resp.status, text);
                    this.fetchError = 'Failed to load data (HTTP ' + resp.status + ')';
                    this.loading = false;
                    return;
                }
                const rows = await resp.json();
                if (!rows || rows.length === 0) {
                    this.noData = true;
                    this.loading = false;
                    if (this.chart) { this.chart.destroy(); this.chart = null; }
                    return;
                }

                // Compute summary stats
                this.totalRecords = rows.reduce((sum, r) => sum + (r.count || 0), 0);
                if (rows.length > 0) {
                    const first = rows[0].period.slice(0, 10);
                    const last = rows[rows.length - 1].period.slice(0, 10);
                    this.dateRange = first + ' to ' + last;
                }

                // Build arenas list from data (for arena filter dropdown)
                const arenaSet = new Set();
                rows.forEach(r => {
                    if (r.arenas) Object.keys(r.arenas).forEach(a => arenaSet.add(a));
                });
                this.availableArenas = Array.from(arenaSet).sort();

                // Build chart data
                const labels = rows.map(r => r.period);
                const arenaNames = Array.from(arenaSet).sort();
                const chartData = {
                    labels: labels,
                    rows: rows,
                    arenaNames: arenaNames,
                    xLabel: 'Date',
                    yLabel: 'Records',
                };

                if (this.chart) { this.chart.destroy(); this.chart = null; }
                this.$nextTick(() => {
                    if (typeof window.initMultiArenaVolumeChart === 'function') {
                        this.chart = window.initMultiArenaVolumeChart('data-timeline-chart', chartData);
                    }
                });
            } catch (e) {
                console.error('Failed to fetch timeline volume data:', e);
                this.fetchError = 'Failed to load timeline data';
            }
            this.loading = false;
        },
    };
}

/**
 * Per-card Alpine component for active tracking cards.
 */
function liveTrackingCard(designId, runId, status, arenas) {
    return {
        designId: designId,
        runId: runId,
        status: status,
        arenas: arenas || [],
        showTimeline: false,
    };
}

/**
 * Timeline chart component that fetches volume data from the analysis endpoint.
 */
function liveTrackingTimeline(designId) {
    return {
        designId: designId,
        selectedArena: '',
        loading: false,
        noData: false,
        chart: null,

        init() {
            this.$watch('$el.closest("[x-show]")', () => {});
            // Fetch on first show via the parent's showTimeline toggle
            const parent = this.$el.closest('[x-data*="liveTrackingCard"]');
            if (parent && parent.__x) {
                this.$watch('$data', () => {});
            }
            // Lazy-load: fetch when the timeline becomes visible
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting && !this.chart && !this.loading) {
                    this.fetchVolume();
                    observer.disconnect();
                }
            });
            this.$nextTick(() => {
                observer.observe(this.$el);
            });
        },

        async fetchVolume() {
            this.loading = true;
            this.noData = false;
            const canvasId = 'timeline-chart-' + this.designId;
            let url = '/analysis/design/' + this.designId + '/volume?granularity=day&delta_mode=true';
            if (this.selectedArena) {
                url += '&platform=' + encodeURIComponent(this.selectedArena);
            }
            try {
                const resp = await fetch(url, { credentials: 'include' });
                if (!resp.ok) {
                    this.noData = true;
                    this.loading = false;
                    return;
                }
                const rows = await resp.json();
                if (!rows || rows.length === 0) {
                    this.noData = true;
                    this.loading = false;
                    return;
                }

                // Build data structure for initMultiArenaVolumeChart
                const labels = rows.map(r => r.period);
                const arenaSet = new Set();
                rows.forEach(r => {
                    if (r.arenas) {
                        Object.keys(r.arenas).forEach(a => arenaSet.add(a));
                    }
                });
                const arenaNames = Array.from(arenaSet).sort();

                const chartData = {
                    labels: labels,
                    rows: rows,
                    arenaNames: arenaNames,
                    xLabel: 'Date',
                    yLabel: 'Records',
                };

                // Destroy previous chart if any
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }

                this.$nextTick(() => {
                    if (typeof window.initMultiArenaVolumeChart === 'function') {
                        this.chart = window.initMultiArenaVolumeChart(canvasId, chartData);
                    }
                });
            } catch (e) {
                console.error('Failed to fetch volume data:', e);
                this.noData = true;
            }
            this.loading = false;
        },
    };
}
</script>
{% endblock %}
