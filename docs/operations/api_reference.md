# API Reference

## Authentication

The API supports two authentication mechanisms:

### Cookie-based (browser sessions)

Obtained via `POST /auth/login`. The server sets an `HttpOnly`, `SameSite=Lax`
cookie (`observatory_auth`) valid for `ACCESS_TOKEN_EXPIRE_MINUTES` (default: 30 min).
A refresh token cookie (`observatory_refresh`) with `REFRESH_TOKEN_EXPIRE_DAYS`
(default: 30 days) allows silent token refresh.

The HTMX frontend relies on this mechanism; all page route handlers read the
cookie automatically.

### Bearer token (API clients)

Pass the JWT as a header:
```
Authorization: Bearer <token>
```

Obtain a token programmatically:
```bash
curl -X POST /auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "user@example.com", "password": "..."}'
```

### API key

Permanent API keys are generated by admins via `POST /admin/users/{id}/api-keys`.
Pass as a bearer token. API keys do not expire automatically.

Generate via script:
```bash
python scripts/generate_api_key.py --email user@example.com
```

---

## Common Patterns

### Pagination

All list endpoints use cursor-based pagination. Parameters:

| Parameter | Default | Description |
|-----------|---------|-------------|
| `cursor` | `null` | Opaque cursor from previous response's `next_cursor` field |
| `limit` | `50` | Items per page (max 200) |

Response shape:
```json
{
  "items": [...],
  "next_cursor": "eyJpZCI6IDEyM30=",
  "total": 1500
}
```

Pass `?cursor=<next_cursor>` to fetch the next page. When `next_cursor` is
`null`, you have reached the last page.

### Ownership Scoping

All query designs and collection runs are scoped to the authenticated user.
An admin can access all resources. Non-admin users receive `404 Not Found`
(not `403`) when requesting resources they do not own, to avoid leaking
resource existence.

### HTMX vs JSON Responses

Routes that serve both the browser UI and API clients inspect the
`HX-Request: true` header set by HTMX. When present, the handler returns an
HTML fragment. When absent (or with `Accept: application/json`), it returns JSON.

---

## Endpoint Groups

### Auth — `/auth`

| Method | Path | Description |
|--------|------|-------------|
| POST | `/auth/login` | Cookie + bearer login |
| POST | `/auth/logout` | Clear session cookie |
| POST | `/auth/refresh` | Silent token refresh using refresh cookie |
| POST | `/auth/register` | Create new account (requires admin activation) |
| POST | `/auth/forgot-password` | Send password reset email |
| POST | `/auth/reset-password` | Complete password reset with token |

### Users — `/users`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/users/me` | Current user profile |
| PATCH | `/users/me` | Update own profile (email, password) |

### Admin: Users — `/admin/users`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/admin/users` | List all users (admin only) |
| POST | `/admin/users/{id}/activate` | Activate a pending user |
| POST | `/admin/users/{id}/deactivate` | Deactivate a user |
| POST | `/admin/users/{id}/role` | Change user role |
| GET | `/admin/users/{id}/api-keys` | List API keys for user |
| POST | `/admin/users/{id}/api-keys` | Generate new API key |
| DELETE | `/admin/users/{id}/api-keys/{key_id}` | Revoke API key |

### Query Designs — `/query-designs`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/query-designs` | List owned query designs (paginated) |
| POST | `/query-designs` | Create query design |
| GET | `/query-designs/{id}` | Get query design |
| PATCH | `/query-designs/{id}` | Update query design |
| DELETE | `/query-designs/{id}` | Delete query design |
| GET | `/query-designs/{id}/arena-config` | Get per-arena tier configuration |
| POST | `/query-designs/{id}/arena-config` | Update per-arena tier configuration |
| POST | `/query-designs/{id}/estimate` | Pre-flight credit cost estimate |

### Collections — `/collections`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/collections` | List collection runs for owned query designs |
| POST | `/collections` | Launch a new collection run |
| GET | `/collections/{id}` | Get collection run detail + task progress |
| DELETE | `/collections/{id}` | Cancel a running collection |
| GET | `/collections/{id}/stream` | SSE stream of live run status updates |

### Content — `/content`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/content` | Search and filter content records |
| GET | `/content/{id}` | Get single content record |
| GET | `/content/export` | Export content records (rate limited: 10/min) |

### Analysis — `/analysis`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/analysis/volume` | Volume over time for a collection run |
| GET | `/analysis/top-actors` | Top actors by engagement |
| GET | `/analysis/topics` | Topic distribution |

### Actors — `/actors`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/actors` | List tracked actors |
| POST | `/actors` | Add actor to a query design |
| GET | `/actors/{id}` | Get actor detail with all platform presences |
| PATCH | `/actors/{id}` | Update actor metadata |
| DELETE | `/actors/{id}` | Remove actor |
| GET | `/actors/{id}/presences` | List platform presences for an actor |
| POST | `/actors/{id}/presences` | Add a platform presence |

### Arenas — `/arenas`

Each arena exposes a standalone router under `/arenas/{platform}`:

| Method | Path pattern | Description |
|--------|-------------|-------------|
| POST | `/arenas/{platform}/collect/terms` | Ad-hoc term-based collection |
| POST | `/arenas/{platform}/collect/actors` | Ad-hoc actor-based collection |
| GET | `/arenas/{platform}/health` | Platform-specific health check |

Arena-level aggregates:

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/health` | Deep health check: DB, Redis, MinIO |
| GET | `/api/arenas/health` | All arena health statuses (cached 360s) |

### Credits — `/credits`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/credits/balance` | Current user's credit balance |
| GET | `/credits/transactions` | Credit transaction history (paginated) |
| POST | `/admin/credits/allocate` | Admin: allocate credits to a user |

### Imports — `/api`

| Method | Path | Description |
|--------|------|-------------|
| POST | `/api/import/jsonl` | Bulk import content records from JSONL |

### System — `/`

| Method | Path | Description |
|--------|------|-------------|
| GET | `/health` | Fast liveness check (no I/O) |
| GET | `/metrics` | Prometheus metrics (gated by `METRICS_ENABLED`) |

---

## Rate Limits

Enforced by `slowapi` middleware using a per-IP sliding window:

| Scope | Limit | Applied via |
|-------|-------|-------------|
| Global (all endpoints) | 100 requests/minute | `SlowAPIMiddleware` default |
| Collection launch (`POST /collections`) | 20 requests/minute | `@limiter.limit("20/minute")` |
| Content export (`GET /content/export`) | 10 requests/minute | `@limiter.limit("10/minute")` |

When a rate limit is exceeded the API returns:
```
HTTP 429 Too Many Requests
Retry-After: <seconds>
```

---

## Error Format

All errors follow the standard FastAPI JSON error shape:

```json
{
  "detail": "Human-readable error description"
}
```

For validation errors (422 Unprocessable Entity):

```json
{
  "detail": [
    {
      "loc": ["body", "field_name"],
      "msg": "field required",
      "type": "missing"
    }
  ]
}
```

Common status codes:

| Code | Meaning |
|------|---------|
| 400 | Bad request / validation error |
| 401 | Not authenticated |
| 403 | Insufficient permissions (admin-only resource) |
| 404 | Resource not found (also returned for ownership violations) |
| 422 | Request body validation failed |
| 429 | Rate limit exceeded |
| 500 | Internal server error (check logs) |

Every response includes an `X-Request-ID` header for log correlation.

---

## Prometheus Metrics

When `METRICS_ENABLED=true`, `GET /metrics` returns Prometheus text format.

| Metric | Type | Labels | Description |
|--------|------|--------|-------------|
| `collection_runs_total` | Counter | `status`, `tier` | Collection run completions by status and tier |
| `collection_records_total` | Counter | `arena`, `platform` | Records ingested by arena and platform |
| `arena_health_status` | Gauge | `arena` | 1 = healthy, 0 = degraded or down |
| `credit_transactions_total` | Counter | `type`, `arena` | Credit transactions by type (reservation/settlement/refund) |
| `http_requests_total` | Counter | `method`, `path`, `status` | HTTP requests by method, path, and response status |
| `http_request_duration_seconds` | Histogram | `method`, `path` | HTTP request latency |
| `celery_tasks_total` | Counter | `task_name`, `status` | Celery task completions by name and status |
| `celery_task_duration_seconds` | Histogram | `task_name` | Celery task duration by task name |
