# Issue Observatory -- Project Rules (.clinerules)

**Last updated:** 2026-02-19

## Project Identity

This is **The Issue Observatory**, a modular multi-platform media data collection and analysis application for media and communications research. It tracks mediated content around specific issues across diverse platforms in a Danish context, architected for international expansion.

## Key References

- `/CLAUDE.md` -- Comprehensive project guide reflecting current implementation state
- `/IMPLEMENTATION_PLAN.md` -- Original phased build plan, architecture, schema, cost tiers
- `/docs/research_reports/implementation_plan_2_0_strategy.md` -- Unified improvement roadmap (IP2-001 through IP2-061)
- `/AGENTS.md` -- Sub-agent role definitions and boundaries
- `/reports/cross_platform_data_collection.md` -- Platform-by-platform API/access research
- `/reports/danish_context_guide.md` -- Denmark-specific sources, legal, GDPR, DSA
- `/docs/status/{agent}.md` -- Per-agent implementation status (research, core, db, frontend, qa)
- `/docs/arenas/{platform}.md` -- Arena research briefs (required before implementation)

**All agents must read CLAUDE.md before beginning any task.** For arena work, also read the relevant arena brief in `/docs/arenas/`.

---

## Architecture Rules

### Arena Isolation
- Every arena lives in `src/issue_observatory/arenas/{arena_name}/` with: `collector.py`, `tasks.py` (Celery), `router.py` (FastAPI), `config.py`, `__init__.py`
- Every arena MUST implement the `ArenaCollector` abstract base class from `issue_observatory.arenas.base`
- Every arena MUST be registered via the `@register` decorator from `issue_observatory.arenas.registry`
- The registry is keyed by `platform_name` (unique per collector), not `arena_name` (which is a shared logical grouping label). Multiple collectors may share the same `arena_name` (e.g., `"social_media"`)
- Arenas MUST NOT import from other arenas. Cross-arena logic belongs in `issue_observatory.core` or `issue_observatory.analysis`
- Arena research briefs (`/docs/arenas/{platform}.md`) are blocking dependencies -- engineering work must not begin without a completed brief

### ArenaCollector Interface
- `arena_name` (str) -- logical grouping label (e.g., `"social_media"`, `"news_media"`, `"web"`)
- `platform_name` (str) -- unique per-collector identifier (e.g., `"reddit"`, `"youtube"`, `"wayback"`)
- `supported_tiers` (list[Tier]) -- FREE, MEDIUM, PREMIUM
- `collect_by_terms(terms, tier, ...)` -- keyword search; supports `term_groups` for boolean AND/OR logic and `language_filter` for multi-language collection
- `collect_by_actors(actor_ids, tier, ...)` -- actor-based collection
- `normalize(raw_item)` -- transforms raw API response to universal content record dict
- `get_tier_config(tier)` -- returns tier-specific API configuration
- `set_public_figure_ids(ids)` -- GR-14: registers actor IDs that bypass SHA-256 pseudonymization
- `estimate_credits(...)` -- returns estimated credit cost (default 0 for free arenas; override for paid)

### Three-Tier Cost Model
- Every arena MUST support at least one of: FREE, MEDIUM, PREMIUM tiers
- Tier selection is a runtime configuration, not a code branch -- use strategy pattern or config-driven provider selection
- If an arena has no free option, it MUST gracefully skip when tier=FREE (log warning, return empty results)
- Tier precedence (IP2-022): per-arena in arenas_config > launcher request > global CollectionRun.tier

### Researcher-Configurable Source Lists (GR-01 through GR-04)
- Arenas with curated source lists support researcher customization via `arenas_config` JSONB on query_designs
- Configuration is persisted via `PATCH /query-designs/{design_id}/arena-config/{arena_name}`
- Implemented for: RSS (custom_feeds), Telegram (custom_channels), Reddit (custom_subreddits), Discord (custom_channel_ids), Wikipedia (seed_articles)
- Multi-language override: `arenas_config["languages"]` takes priority over single `language` field (GR-05)

### Query Design as First-Class Entity
- All collection revolves around `query_designs` -- named sets of search terms + actor lists + arena configuration
- Search terms support boolean grouping: terms with the same `group_id` are ANDed; groups are ORed (IP2-031, `arenas/query_builder.py`)
- Search terms support `group_label` for categorization (IP2-046)
- Actor-based collection is equally important as keyword search
- The entity resolver (`issue_observatory.core.entity_resolver`) is shared across all arenas
- Query designs can be cloned (IP2-051, `parent_design_id` FK)

### Celery Task Patterns
- All data collection happens in Celery tasks, never in request handlers
- Task naming convention: `issue_observatory.arenas.{arena_name}.tasks.{action}`
- Tasks must be idempotent -- safe to retry on failure
- Rate limit state tracked in Redis with keys: `ratelimit:{arena}:{platform}:{credential_id}`
- Use `collection_runs` and `collection_tasks` tables to track progress
- SSE live monitoring: tasks publish progress via `event_bus.py` (synchronous Redis pub/sub)

### Enrichment Pipeline Pattern
- Enrichments are pluggable post-collection processors subclassing `ContentEnricher` from `analysis/enrichments/base.py`
- Each enricher defines `enricher_name`, `is_applicable(record)`, and `enrich(record)`
- Output stored in `raw_metadata.enrichments.{enricher_name}` as JSONB -- no schema migration needed
- Available enrichers: LanguageDetector, NamedEntityExtractor, PropagationEnricher, CoordinationDetector

### Database Conventions
- All models in `src/issue_observatory/core/models/` directory using SQLAlchemy 2.0 declarative style
- All tables have `created_at` and `updated_at` timestamps (via `TimestampMixin`)
- Platform-specific data goes in `raw_metadata` JSONB column -- never add platform-specific columns to the universal schema
- Enrichment data goes in `raw_metadata.enrichments.{enricher_name}` -- not in new columns
- UUIDs for all primary keys
- Alembic for all migrations -- never modify tables manually
- Pydantic schemas in `src/issue_observatory/core/schemas/` for all API inputs/outputs
- `content_records` is range-partitioned by `published_at` (monthly boundaries); FK references must account for the composite PK `(id, published_at)`

---

## Coding Standards

### Python
- Python 3.12+, strict type hints on all function signatures
- Async everywhere possible (httpx, SQLAlchemy async, FastAPI)
- Pydantic v2 for all data validation and serialization
- Use `from __future__ import annotations` in all files
- Docstrings on all public classes and functions (Google style)
- No wildcard imports. No `from module import *`

### Naming Conventions
- Files: `snake_case.py`
- Classes: `PascalCase`
- Functions/methods: `snake_case`
- Constants: `UPPER_SNAKE_CASE`
- Arena platform_names: `snake_case` (e.g., `google_search`, `x_twitter`, `rss_feeds`, `common_crawl`, `wayback`)
- Celery task names: dotted path matching module location

### Error Handling
- Custom exception hierarchy rooted in `IssueObservatoryError` (`core/exceptions.py`)
- Arena-specific exceptions: `ArenaCollectionError`, `ArenaRateLimitError`, `ArenaAuthError`
- Never swallow exceptions silently -- log at minimum
- All external API calls wrapped in try/except with specific error types
- Use structured logging (structlog)

### Linting and Formatting
- Ruff for linting and formatting; line length 100; double quotes; LF line endings
- Mypy strict mode with `pydantic.mypy` plugin
- Pre-commit hooks: ruff + pre-commit-hooks

### UI Language
- The application interface MUST be in **English**. All nav labels, page headings, button labels,
  form labels, placeholder text, status badges, error messages, confirmation dialogs,
  empty-state messages, and any other user-visible strings must be in English.
- Danish is relevant ONLY as a data/query parameter: locale settings such as `gl=dk&hl=da`,
  Danish RSS feed URLs, ISO language codes stored in the database (`da`, `DK`), and
  PostgreSQL full-text search dictionaries (`to_tsvector('danish', ...)`). None of these
  are UI text.
- Do NOT write Danish strings in Jinja2 templates, Alpine.js components, or JavaScript.
  There is no i18n layer; every string is hardcoded in English.
- The `<html lang="en">` attribute must be set in `base.html` and `base_auth.html`.

### Testing
- Every arena collector must have unit tests with mocked API responses (using `respx`)
- Test fixtures live in `tests/fixtures/api_responses/{arena_name}/`
- Test factories in `tests/factories/` (UserFactory, QueryDesignFactory, ContentRecordFactory)
- Integration tests use Docker-based PostgreSQL and Redis (pytest fixtures in conftest.py)
- Minimum test coverage target: 80% for core/, 75% for arenas/
- Test file naming: `test_{module_name}.py`
- Use `pytest-asyncio` with `asyncio_mode = "auto"`
- Test directories: `tests/unit/`, `tests/arenas/`, `tests/integration/`, `tests/scraper/`

---

## Danish Context Rules

### Language & Locale
- All Google Search/Autocomplete requests MUST include `gl=dk&hl=da` for Danish context
- YouTube searches use `relevanceLanguage=da`, `regionCode=DK`
- Bluesky searchPosts uses `lang:da` filter for term search; actor-based collection uses client-side language filtering
- GDELT queries filter by `sourcelang:danish` or `sourcecountry:DA`
- Event Registry uses ISO 639-3 `"dan"` (not ISO 639-1 `"da"`)
- X/Twitter uses `lang:da` search operator
- Store language as ISO 639-1 (`da` for Danish) and country as ISO 3166-1 (`DK`) on all content records
- Multi-language collection is supported via `arenas_config["languages"]` list (GR-05)

### Danish News Sources
- A curated Danish RSS feed list is in `src/issue_observatory/config/danish_defaults.py`
- Core sources: DR (all feeds), TV2, BT, Politiken, Berlingske, Ekstra Bladet, Information, Jyllands-Posten (uncertain availability), Nordjyske, Borsen, Kristeligt Dagblad
- Policy/sector: Altinget (main + uddannelse + klima section feeds)
- Education: Folkeskolen, Gymnasieskolen, KU, DTU, CBS
- Researchers can add custom RSS feeds via `arenas_config["rss"]["custom_feeds"]` (GR-01)

### Excluded Sources
- **Infomedia** is explicitly EXCLUDED (institutional-subscription-only, not available)
- **LinkedIn** has no automated collection path -- manual Zeeschuimer capture with NDJSON import only
- Do not implement Infomedia integration or reference it as available

### Legal Compliance
- GDPR compliance is non-negotiable. All architecture decisions must support:
  - Pseudonymization of author identifiers (SHA-256 with configurable salt)
  - Public figure exemption: `public_figure=True` on Actor records bypasses pseudonymization per GDPR Art. 89(1), with audit trail in `raw_metadata` (GR-14)
  - Data subject deletion capability via `RetentionService` (`core/retention_service.py`)
  - Purpose limitation (content records linked to research query_designs)
  - Data retention policies (configurable)
- LinkedIn scraping carries HIGH legal risk in EU (CNIL precedent: KASPR fined EUR 240K)
- Content annotations support qualitative coding with stance vocabulary (positive, negative, neutral, contested, irrelevant)

---

## Git & Workflow Rules

### Branch Strategy
- `main` -- stable, tested, deployable
- `develop` -- integration branch
- `feature/{arena-name}` -- per-arena feature branches
- `feature/{module-name}` -- for core, analysis, sampling modules
- PRs require passing CI (lint + type-check + tests) before merge

### Commit Messages
- Format: `{scope}: {description}`
- Scopes: `core`, `arena/{name}`, `analysis`, `sampling`, `scraper`, `infra`, `docs`, `tests`
- Examples: `core: add query design CRUD endpoints`, `arena/bluesky: implement keyword search collector`

### Documentation
- `/CLAUDE.md` at project root with comprehensive project guide
- `/README.md` at project root with setup instructions
- Arena research briefs in `/docs/arenas/{platform}.md`
- API docs auto-generated via FastAPI OpenAPI (no manual API docs)
- Status tracking in `/docs/status/{agent}.md`

---

## Agent Coordination Rules

### Handoff Protocol
- When one agent's work depends on another's output, the dependent agent MUST check that the prerequisite code exists and passes tests before building on it
- The Research & Planning agent maintains `/docs/decisions/` (ADR log) and arena briefs
- The QA agent has final say on whether code meets standards before it merges to develop
- Arena implementation requires a completed research brief at `/docs/arenas/{platform}.md`

### Shared State
- Database schema changes MUST be proposed in an Alembic migration and reviewed by the Database agent
- New arena implementations MUST follow the ArenaCollector interface and use the `@register` decorator
- New enrichers MUST subclass `ContentEnricher` and store output in `raw_metadata.enrichments`

### File Ownership
- `src/issue_observatory/core/` (except `models/`) -- Core Application Agent
- `src/issue_observatory/arenas/` -- Core Application Agent (structure/interface + arena implementations)
- `src/issue_observatory/api/routes/`, `src/issue_observatory/api/dependencies.py`, `src/issue_observatory/api/main.py` -- Core Application Agent
- `src/issue_observatory/api/templates/`, `src/issue_observatory/api/static/` -- Frontend Engineer
- `src/issue_observatory/workers/` -- Core Application Agent
- `src/issue_observatory/config/` -- Core Application Agent
- `src/issue_observatory/sampling/` -- Core Application Agent
- `src/issue_observatory/scraper/` -- Core Application Agent
- `src/issue_observatory/core/models/`, `src/issue_observatory/core/database.py`, `alembic/` -- Database & Data Processing Agent
- `src/issue_observatory/analysis/` -- Database & Data Processing Agent
- `tests/` -- QA & Testing Agent (writes tests), all agents (fix failing tests in their scope)
- `docs/`, `reports/` -- Research & Planning Agent
- `docker-compose.yml`, CI config, `pyproject.toml` -- shared (coordinate via PR review)
