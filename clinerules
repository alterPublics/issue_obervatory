# Issue Observatory — Project Rules (.clinerules)

## Project Identity

This is **The Issue Observatory**, a modular multi-platform media data collection and analysis application for media and communications research. It tracks mediated content around specific issues across diverse platforms in a Danish context, architected for international expansion.

## Key References

- `/IMPLEMENTATION_PLAN.md` — Phased build plan, architecture, schema, cost tiers
- `/AGENTS.md` — Sub-agent role definitions and boundaries
- `/reports/cross_platform_data_collection.md` — Platform-by-platform API/access research
- `/reports/danish_context_guide.md` — Denmark-specific sources, legal, GDPR, DSA
- `https://github.com/dimelab/issue_observatory_search` — Predecessor project (Google Search tracking). Inspect closely for patterns, but build fresh.

**All agents must read IMPLEMENTATION_PLAN.md and the relevant report(s) in /reports before beginning any task.**

---

## Architecture Rules

### Arena Isolation
- Every arena (google_search, bluesky, reddit, etc.) lives in `src/issue_observatory/arenas/{arena_name}/`
- Every arena MUST expose a standalone FastAPI router in `router.py` that can be mounted independently
- Every arena MUST implement the `ArenaCollector` abstract base class from `issue_observatory.arenas.base`
- Arenas MUST NOT import from other arenas. Cross-arena logic belongs in `issue_observatory.core`
- Each arena has its own `collector.py`, `tasks.py` (Celery), `router.py` (FastAPI), and `config.py`

### Three-Tier Cost Model
- Every arena MUST support at least one of: FREE, MEDIUM, PREMIUM tiers
- Tier selection is a runtime configuration, not a code branch — use strategy pattern or config-driven provider selection
- If an arena has no free option, it MUST gracefully skip when tier=FREE (log warning, return empty results)
- Tier configuration lives in `arenas_config` JSONB on `collection_runs` and per-arena `config.py` files

### Query Design as First-Class Entity
- All collection revolves around `query_designs` — named sets of search terms + actor lists
- Every collection function accepts a `query_design_id` parameter
- Actor-based collection (monitoring specific accounts) is equally important as keyword search — some arenas (Telegram, LinkedIn) may ONLY support actor-based collection
- The entity resolver (`issue_observatory.core.entity_resolver`) is shared across all arenas

### Celery Task Patterns
- All data collection happens in Celery tasks, never in request handlers
- Task naming convention: `issue_observatory.arenas.{arena_name}.tasks.{action}`
- Tasks must be idempotent — safe to retry on failure
- Rate limit state tracked in Redis with keys: `ratelimit:{arena}:{provider}:{key}`
- Use `collection_runs` and `collection_tasks` tables to track progress
- Long-running streaming tasks (Bluesky firehose, Reddit PRAW, Telegram) use dedicated Celery workers

### Database Conventions
- All models in `src/issue_observatory/core/models/` directory using SQLAlchemy 2.0 declarative style
- All tables have `created_at` and `updated_at` timestamps
- Platform-specific data goes in `raw_metadata` JSONB column — never add platform-specific columns to the universal schema
- UUIDs for all primary keys
- Alembic for all migrations — never modify tables manually
- Pydantic schemas in `src/issue_observatory/core/schemas/` for all API inputs/outputs

---

## Coding Standards

### Python
- Python 3.12+, strict type hints on all function signatures
- Async everywhere possible (httpx, SQLAlchemy async, FastAPI)
- Pydantic v2 for all data validation and serialization
- Use `from __future__ import annotations` in all files
- Docstrings on all public classes and functions (Google style)
- No wildcard imports. No `from module import *`

### Naming Conventions
- Files: `snake_case.py`
- Classes: `PascalCase`
- Functions/methods: `snake_case`
- Constants: `UPPER_SNAKE_CASE`
- Arena names: `snake_case` everywhere (google_search, x_twitter, news_media, web_at_large)
- Celery task names: dotted path matching module location

### Error Handling
- Custom exception hierarchy rooted in `IssueObservatoryError`
- Arena-specific exceptions: `ArenaCollectionError`, `ArenaRateLimitError`, `ArenaAuthError`
- Never swallow exceptions silently — log at minimum
- All external API calls wrapped in try/except with specific error types
- Use structured logging (structlog or standard logging with JSON formatter)

### UI Language
- The application interface MUST be in **English**. All nav labels, page headings, button labels,
  form labels, placeholder text, status badges, error messages, confirmation dialogs,
  empty-state messages, and any other user-visible strings must be in English.
- Danish is relevant ONLY as a data/query parameter: locale settings such as `gl=dk&hl=da`,
  Danish RSS feed URLs, ISO language codes stored in the database (`da`, `DK`), and
  PostgreSQL full-text search dictionaries (`to_tsvector('danish', ...)`). None of these
  are UI text.
- Do NOT write Danish strings in Jinja2 templates, Alpine.js components, or JavaScript.
  There is no i18n layer; every string is hardcoded in English.
- The `<html lang="en">` attribute must be set in `base.html` and `base_auth.html`.

### Testing
- Every arena collector must have unit tests with mocked API responses
- Integration tests use Docker-based PostgreSQL and Redis (pytest fixtures in conftest.py)
- Minimum test coverage target: 80% for core/, 70% for arenas/
- Test file naming: `test_{module_name}.py`
- Use `pytest-asyncio` for async tests
- Fixture factories for content_items, query_designs, actors

---

## Danish Context Rules

### Language & Locale
- All Google Search/Autocomplete requests MUST include `gl=dk&hl=da` for Danish context
- YouTube searches should use `relevanceLanguage=da` where supported
- Bluesky searchPosts supports `lang:da` filter — use it
- GDELT queries should filter by `sourcelang:danish` or `sourcecountry:DA`
- Store language as ISO 639-1 (`da` for Danish) and country as ISO 3166-1 (`DK`) on all content_items

### Danish News Sources
- A curated Danish RSS feed list is a first-class configuration artifact in `src/issue_observatory/config/danish_defaults.py`
- Minimum required sources: DR (all feeds), TV2, BT, Politiken, Berlingske, Ekstra Bladet, Information, Jyllands-Posten, Nordjyske, Børsen, Kristeligt Dagblad
- Feed URLs must be verified active before inclusion
- TV2 feed: `https://feeds.services.tv2.dk/api/feeds/nyheder/rss`
- DR feeds base: `https://www.dr.dk/nyheder/service/feeds/`

### Excluded Sources
- Infomedia is explicitly EXCLUDED despite being ideal for Danish news research (per user specification)
- Do not implement Infomedia integration or reference it as available

### Legal Compliance
- GDPR compliance is non-negotiable. All architecture decisions must support:
  - Pseudonymization of author identifiers on export
  - Data subject deletion capability (soft-delete with `deleted_at` column)
  - Purpose limitation (content_items linked to research query_designs)
  - Data retention policies (configurable per arena)
- LinkedIn scraping carries HIGH legal risk in EU — always flag this in documentation and logs
- The application must be able to generate a DPIA-supporting data inventory on demand

---

## Git & Workflow Rules

### Branch Strategy
- `main` — stable, tested, deployable
- `develop` — integration branch
- `feature/{arena-name}` — per-arena feature branches
- `feature/{module-name}` — for core, analysis, sampling modules
- PRs require passing CI (lint + type-check + tests) before merge

### Commit Messages
- Format: `{scope}: {description}` 
- Scopes: `core`, `arena/{name}`, `analysis`, `sampling`, `infra`, `docs`, `tests`
- Examples: `core: add query design CRUD endpoints`, `arena/bluesky: implement keyword search collector`

### Documentation
- README.md at project root with setup instructions
- Each arena directory gets a brief README.md documenting: supported tiers, required credentials, rate limits, Danish-specific notes
- API docs auto-generated via FastAPI OpenAPI (no manual API docs)

---

## Agent Coordination Rules

### Handoff Protocol
- When one agent's work depends on another's output, the dependent agent MUST check that the prerequisite code exists and passes tests before building on it
- The Research & Planning agent maintains `/docs/decisions/` (ADR log) with all architectural decisions and rationale
- The QA agent has final say on whether code meets standards before it merges to develop

### Shared State
- Database schema changes MUST be proposed in an Alembic migration and reviewed by the Database agent
- New arena implementations MUST follow the ArenaCollector interface — the Core agent defines the interface, arena agents implement it
- The QA agent maintains `/docs/test_plan.md` tracking coverage per module

### File Ownership
- `src/issue_observatory/core/` (except `models/`) — Core Application Agent
- `src/issue_observatory/arenas/` — Core Application Agent (structure/interface + arena implementations)
- `src/issue_observatory/api/` — Core Application Agent
- `src/issue_observatory/workers/` — Core Application Agent
- `src/issue_observatory/config/` — Core Application Agent
- `src/issue_observatory/sampling/` — Core Application Agent
- `src/issue_observatory/core/models/`, `src/issue_observatory/core/database.py`, `alembic/` — Database & Data Processing Agent
- `src/issue_observatory/analysis/` — Database & Data Processing Agent
- `tests/` — QA & Testing Agent (writes tests), all agents (fix failing tests in their scope)
- `docs/`, `reports/` — Research & Planning Agent
- `docker-compose.yml`, CI config, `pyproject.toml` — shared (coordinate via PR review)
