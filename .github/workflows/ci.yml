name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ---------------------------------------------------------------------------
  # Lint: ruff (format + lint checks)
  # ---------------------------------------------------------------------------
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install linting tools
        run: pip install "ruff>=0.8,<0.9"

      - name: ruff check (lint)
        run: ruff check src/ tests/

      - name: ruff format --check (formatting)
        run: ruff format --check src/ tests/

  # ---------------------------------------------------------------------------
  # Tests: unit + integration (PostgreSQL + Redis)
  # ---------------------------------------------------------------------------
  test:
    name: Test Suite
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_observatory
        ports:
          - "5432:5432"
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - "6379:6379"
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"

      - name: Run Alembic migrations against test database
        run: alembic upgrade head
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:test@localhost:5432/test_observatory

      - name: Run test suite with coverage
        run: >-
          pytest tests/
          --cov=src/issue_observatory
          --cov-report=term-missing
          --cov-report=xml:coverage.xml
          --cov-fail-under=75
          -v
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:test@localhost:5432/test_observatory
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci-only-do-not-use-in-production
          # CREDENTIAL_ENCRYPTION_KEY must be a valid Fernet key (32 random bytes,
          # URL-safe base64-encoded).  In real CI, set this GitHub Actions secret.
          # For reference, generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
          CREDENTIAL_ENCRYPTION_KEY: ${{ secrets.CREDENTIAL_ENCRYPTION_KEY }}
          PSEUDONYMIZATION_SALT: test-pseudonymization-salt-ci-only
          CELERY_BROKER_URL: redis://localhost:6379/1
          CELERY_RESULT_BACKEND: redis://localhost:6379/2

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml

  # ---------------------------------------------------------------------------
  # Security: dependency vulnerability audit
  # ---------------------------------------------------------------------------
  security:
    name: Security Audit (pip-audit)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Audit dependencies for known vulnerabilities
        run: pip-audit --requirement <(pip install -e ".[dev]" --dry-run -q 2>&1 | grep "^Would install" | sed 's/Would install //' | tr ' ' '\n' | sed 's/-\([0-9]\)/==\1/' || true)
        # Soft-fail for now: vulnerabilities are flagged but do not block CI.
        # Harden to a hard failure once all transitive deps are audited.
        continue-on-error: true
